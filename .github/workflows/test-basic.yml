name: Basic Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  basic-test:
    runs-on: self-hosted
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check environment
      run: |
        echo "=== Environment Check ==="
        echo "Node version: $(node --version)"
        echo "NPM version: $(npm --version)"
        echo "Current user: $(whoami)"
        echo "Working directory: $(pwd)"
        echo "Available disk space:"
        df -h
        echo "Memory usage:"
        free -h || echo "free command not available"
        
    - name: Check repository structure
      run: |
        echo "=== Repository Structure ==="
        ls -la
        echo "Client directory:"
        ls -la client/ || echo "Client directory not found"
        echo "Server directory:"
        ls -la server/ || echo "Server directory not found"
        echo "Functions directory:"
        ls -la functions/ || echo "Functions directory not found"
        
    - name: Check package.json files
      run: |
        echo "=== Package.json Files ==="
        echo "Root package.json:"
        cat package.json || echo "Root package.json not found"
        echo ""
        echo "Client package.json test scripts:"
        cat client/package.json | grep -A 10 -B 5 '"scripts"' || echo "Client package.json not found"
        
    - name: Install root dependencies
      run: |
        echo "=== Installing Root Dependencies ==="
        npm ci || {
          echo "npm ci failed, trying npm install"
          npm install
        }
        
    - name: Install client dependencies
      run: |
        echo "=== Installing Client Dependencies ==="
        cd client
        npm ci || {
          echo "npm ci failed, trying npm install"
          npm install
        }
        
    - name: Check if test script works
      run: |
        echo "=== Testing Basic Commands ==="
        echo "Checking if scripts/run-tests.sh exists:"
        ls -la scripts/run-tests.sh || echo "run-tests.sh not found"
        
        echo "Making script executable:"
        chmod +x scripts/run-tests.sh || echo "chmod failed"
        
        echo "Testing basic script execution:"
        bash --version
        
        echo "Checking test environment setup script:"
        ls -la scripts/codex-setp.sh || echo "codex-setp.sh not found"
        
    - name: Simple test run
      run: |
        echo "=== Simple Test Run ==="
        echo "Current directory: $(pwd)"
        echo "Test script content:"
        cat package.json | grep '"test"' || echo "No test script found"
        
        # Try to run a simple version check instead of full tests
        echo "Checking if we can run basic commands:"
        cd client
        npm run --silent || echo "npm run failed"
        
    - name: Environment summary
      if: always()
      run: |
        echo "=== Environment Summary ==="
        echo "Test completed at: $(date)"
        echo "Exit code: $?"
        echo "Working directory: $(pwd)"
        ps aux | head -10 || echo "ps command failed"
