# .github/workflows/auto-merge.yml
name: Auto merge on green CI
on:
  workflow_run:
    workflows: [ "Test", "Format Check" ]   # ← 個別 Workflow 名を列挙
    types: [ completed ]

jobs:
  merge:
    if: |
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
      checks: read
    concurrency: pr-${{ github.event.workflow_run.pull_requests[0].number }}  # ダブり防止
    steps:
      - name: Are *all* checks green?
        id: checks
        run: |
          sha="${{ github.event.workflow_run.head_sha }}"
          # 必須チェック名を改行区切りで列挙
          required_checks=$(cat <<'EOF'
          Lint
          Unit Test
          Build
          EOF
          )

          all_green=true
          for name in $required_checks; do
            # conclusion 取得（success / failure / neutral / cancelled…）
            conclusion=$(gh api \
              repos/${{ github.repository }}/commits/$sha/check-runs \
              --jq ".check_runs[] | select(.name==\"$name\") | .conclusion")
            echo "$name → $conclusion"
            if [[ "$conclusion" != "success" ]]; then
              all_green=false
            fi
          done

          echo "all_green=$all_green" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge PR
        if: steps.checks.outputs.all_green == 'true'
        run: |
          pr=${{ github.event.workflow_run.pull_requests[0].number }}
          gh pr merge "$pr" --merge --delete-branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
