name: Sync to GitLab
on:
  push:
    branches: [main]

jobs:
  relay:
    runs-on: ubuntu-latest
    steps:
      # 1. Fetch full history
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ‚Üê Disable shallow clone

      # 2. Git user identity
      - name: Git identity
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # 3. Sync with GitLab
      - name: Force-push to GitLab
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }} # api scope PAT
        run: |
          git remote add gitlab https://oauth2:${GITLAB_TOKEN}@gitlab.com/kitamura.tetsuo/outliner.git

          # Fetch main from GitLab
          git fetch gitlab main

          # Force overwrite even if GitLab history has diverged
          echo "üîÑ Force pushing to GitLab main branch"
          git push --force-with-lease gitlab HEAD:main
