name: Sync to GitLab
on:
  push:
    branches: [main]

jobs:
  relay:
    runs-on: ubuntu-latest
    steps:
      # 1. å®Œå…¨å±¥æ­´ã‚’å–ã‚‹
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # â† æµ…ã„ clone ã‚’è§£é™¤

      # 2. Git ãƒ¦ãƒ¼ã‚¶æƒ…å ±
      - name: Git identity
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # 3. GitLab ã¨åŒæœŸ
      - name: Merge-and-push to GitLab
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }} # api æ¨©é™ PAT
        run: |
          git remote add gitlab https://oauth2:${GITLAB_TOKEN}@gitlab.com/kitamura.tetsuo/outliner.git

          # GitLab å´ã® main ã‚’å–ã‚Šè¾¼ã¿
          git fetch gitlab main

          # GitLabã®å¤‰æ›´ã‚’ãƒ­ãƒ¼ã‚«ãƒ«mainã«çµ±åˆ
          if git merge-base --is-ancestor gitlab/main HEAD; then
            echo "âœ… Fast-forward possible, pushing normally"
            git push gitlab HEAD:main
          else
            echo "ğŸ”„ History has diverged, merging GitLab changes first"
            # ãƒ­ãƒ¼ã‚«ãƒ«ã§GitLabã®å¤‰æ›´ã‚’ãƒãƒ¼ã‚¸
            git merge gitlab/main --no-edit
            # ãã®å¾Œãƒ—ãƒƒã‚·ãƒ¥
            git push gitlab HEAD:main
          fi
