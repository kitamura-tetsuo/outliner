name: Format Check and Auto-Fix

on:
  push:
    branches: ['**']
    # Exclude PRs since test workflow will handle formatting for PRs

concurrency:
  group: formatter-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel to avoid incomplete formatting

jobs:
  format:
    if: ${{ github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          clean: true             # wipe workspace before fetch
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dprint
        run: npm install -g dprint

      - name: Check formatting
        id: format_check
        run: |
          echo "Running formatting check..."
          if ! ./scripts/check_format.sh; then
            echo "‚ùå Code is not properly formatted!"
            echo "format_needed=true" >> $GITHUB_OUTPUT
            exit 0  # Don't fail here, we'll handle it in the next step
          fi
          echo "‚úÖ All code is properly formatted!"
          echo "format_needed=false" >> $GITHUB_OUTPUT

      - name: Auto-fix formatting
        if: steps.format_check.outputs.format_needed == 'true'
        run: |
          echo "üîß Auto-fixing formatting issues..."
          npx dprint fmt

          # Check if there are any changes
          if git diff --quiet; then
            echo "No changes were made by dprint fmt"
            exit 0
          fi

          # Configure git (use --global as fallback for container environments)
          git config user.email "action@github.com" || git config --global user.email "action@github.com"
          git config user.name "GitHub Action" || git config --global user.name "GitHub Action"

          # Check if we're behind remote to avoid conflicts
          git fetch origin
          if git merge-base --is-ancestor HEAD origin/${{ github.ref_name }}; then
            git add .
            git commit -m "Auto-fix: Format code with dprint"

            # Retry push with pull if needed
            if ! git push; then
              echo "Push failed, trying to pull and retry..."
              git pull --rebase origin ${{ github.ref_name }}
              git push
            fi
            echo "‚úÖ Formatting issues have been automatically fixed and committed!"
          else
            echo "‚ö†Ô∏è Local branch is behind remote, skipping auto-commit to avoid conflicts"
            echo "Please pull latest changes and run 'npx dprint fmt' manually"
            exit 1
          fi
