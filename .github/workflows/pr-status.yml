name: PR Status Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  status-check:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set PR status to pending
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.repos.createCommitStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: context.payload.pull_request.head.sha,
            state: 'pending',
            target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
            description: 'Tests are running...',
            context: 'continuous-integration/outliner-tests'
          });
          
    - name: Wait for test workflow
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const sha = context.payload.pull_request.head.sha;
          
          // Wait for the test workflow to complete
          let attempts = 0;
          const maxAttempts = 60; // 30 minutes max wait
          
          while (attempts < maxAttempts) {
            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              head_sha: sha,
              status: 'completed'
            });
            
            const testRun = runs.data.workflow_runs.find(run => 
              run.name === 'Test' && run.head_sha === sha
            );
            
            if (testRun) {
              const conclusion = testRun.conclusion;
              const state = conclusion === 'success' ? 'success' : 'failure';
              const description = conclusion === 'success' 
                ? 'All tests passed!' 
                : 'Tests failed. Check logs for details.';
              
              await github.rest.repos.createCommitStatus({
                owner,
                repo,
                sha,
                state,
                target_url: testRun.html_url,
                description,
                context: 'continuous-integration/outliner-tests'
              });
              
              return;
            }
            
            attempts++;
            await new Promise(resolve => setTimeout(resolve, 30000)); // Wait 30 seconds
          }
          
          // If we get here, the test didn't complete in time
          await github.rest.repos.createCommitStatus({
            owner,
            repo,
            sha,
            state: 'error',
            target_url: `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`,
            description: 'Test workflow timed out',
            context: 'continuous-integration/outliner-tests'
          });
