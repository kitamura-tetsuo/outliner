name: Test Report

on:
  workflow_run:
    workflows: ["Test"]
    types:
      - completed

jobs:
  test-report:
    runs-on: self-hosted
    if: github.event.workflow_run.event == 'pull_request'
    
    steps:
    - name: Download test artifacts
      uses: actions/github-script@v7
      with:
        script: |
          const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: context.payload.workflow_run.id,
          });
          
          for (const artifact of artifacts.data.artifacts) {
            if (artifact.name === 'test-results') {
              const download = await github.rest.actions.downloadArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id,
                archive_format: 'zip',
              });
              
              const fs = require('fs');
              fs.writeFileSync('test-results.zip', Buffer.from(download.data));
              break;
            }
          }
          
    - name: Extract and analyze test results
      run: |
        if [ -f test-results.zip ]; then
          unzip -q test-results.zip || true
          
          # Create test summary
          echo "# Test Summary" > test-summary.md
          echo "" >> test-summary.md
          
          # Check for Playwright results
          if [ -f "client/test-results/results.json" ]; then
            echo "## E2E Test Results" >> test-summary.md
            echo "" >> test-summary.md
            
            # Parse Playwright results (basic parsing)
            if command -v jq &> /dev/null; then
              TOTAL=$(jq '.suites | length' client/test-results/results.json 2>/dev/null || echo "0")
              PASSED=$(jq '[.suites[].specs[] | select(.tests[].results[].status == "passed")] | length' client/test-results/results.json 2>/dev/null || echo "0")
              FAILED=$(jq '[.suites[].specs[] | select(.tests[].results[].status == "failed")] | length' client/test-results/results.json 2>/dev/null || echo "0")
              
              echo "- Total tests: $TOTAL" >> test-summary.md
              echo "- Passed: $PASSED" >> test-summary.md
              echo "- Failed: $FAILED" >> test-summary.md
            else
              echo "- Test results available in artifacts" >> test-summary.md
            fi
            echo "" >> test-summary.md
          fi
          
          # Check for coverage
          if [ -f "client/coverage/coverage-summary.json" ]; then
            echo "## Coverage Report" >> test-summary.md
            echo "" >> test-summary.md
            
            if command -v jq &> /dev/null; then
              LINES=$(jq '.total.lines.pct' client/coverage/coverage-summary.json 2>/dev/null || echo "N/A")
              FUNCTIONS=$(jq '.total.functions.pct' client/coverage/coverage-summary.json 2>/dev/null || echo "N/A")
              BRANCHES=$(jq '.total.branches.pct' client/coverage/coverage-summary.json 2>/dev/null || echo "N/A")
              STATEMENTS=$(jq '.total.statements.pct' client/coverage/coverage-summary.json 2>/dev/null || echo "N/A")
              
              echo "- Lines: ${LINES}%" >> test-summary.md
              echo "- Functions: ${FUNCTIONS}%" >> test-summary.md
              echo "- Branches: ${BRANCHES}%" >> test-summary.md
              echo "- Statements: ${STATEMENTS}%" >> test-summary.md
            else
              echo "- Coverage report available in artifacts" >> test-summary.md
            fi
            echo "" >> test-summary.md
          fi
          
          # Add links
          echo "## Detailed Reports" >> test-summary.md
          echo "" >> test-summary.md
          echo "- [Download test artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})" >> test-summary.md
          echo "- [View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})" >> test-summary.md
        else
          echo "# Test Summary" > test-summary.md
          echo "" >> test-summary.md
          echo "No test artifacts found." >> test-summary.md
        fi
        
    - name: Find PR number
      uses: actions/github-script@v7
      id: find-pr
      with:
        script: |
          const { owner, repo } = context.repo;
          const sha = context.payload.workflow_run.head_sha;
          
          const prs = await github.rest.pulls.list({
            owner,
            repo,
            state: 'open',
            head: `${owner}:${context.payload.workflow_run.head_branch}`
          });
          
          const pr = prs.data.find(p => p.head.sha === sha);
          return pr ? pr.number : null;
          
    - name: Comment on PR with detailed results
      uses: actions/github-script@v7
      if: steps.find-pr.outputs.result != 'null'
      with:
        script: |
          const fs = require('fs');
          const prNumber = ${{ steps.find-pr.outputs.result }};
          
          let comment = '';
          if (fs.existsSync('test-summary.md')) {
            comment = fs.readFileSync('test-summary.md', 'utf8');
          } else {
            comment = '# Test Summary\n\nNo detailed test results available.';
          }
          
          // Add workflow status
          const conclusion = context.payload.workflow_run.conclusion;
          const statusEmoji = conclusion === 'success' ? '✅' : '❌';
          const statusText = conclusion === 'success' ? 'PASSED' : 'FAILED';
          
          comment = `## ${statusEmoji} Tests ${statusText}\n\n${comment}`;
          
          // Add timestamp
          const now = new Date().toISOString();
          comment += `\n\n---\n*Report generated at ${now}*`;
          
          github.rest.issues.createComment({
            issue_number: prNumber,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
