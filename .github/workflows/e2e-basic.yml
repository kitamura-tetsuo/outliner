name: E2E Basic Tests

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  e2e-basic:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/${{ github.repository }}:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Java 21
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-21-jre-headless

      - name: Restore dependencies from cache
        run: |
          # Copy pre-installed node_modules from cache
          cp -r /cache/client/node_modules client/
          cp -r /cache/server/node_modules server/
          cp -r /cache/functions/node_modules functions/

          # Ensure binaries are executable
          chmod +x client/node_modules/.bin/* || true
          chmod +x server/node_modules/.bin/* || true
          chmod +x functions/node_modules/.bin/* || true

      - name: Setup test environment
        run: |
          # Create sentinel file to skip dependency installation in setup.sh
          touch .setup-installed
          ./scripts/setup.sh

      - name: Run basic E2E tests sequentially
        run: |
          cd client
          for spec in e2e/basic/*.spec.ts; do
            echo "Running $spec"
            npm run github:test:e2e -- "$spec"
          done

      - name: Cleanup after tests
        if: always()
        run: |
          node scripts/kill-tinylicious.js || true
          pkill -f "firebase" || true
          pkill -f "vite" || true
          pkill -f "node.*7090" || true
          pkill -f "node.*7091" || true
          pkill -f "node.*7092" || true
          pkill -f "node.*7093" || true
          pkill -f "node.*59099" || true
          pkill -f "node.*58080" || true
          pkill -f "node.*57000" || true
