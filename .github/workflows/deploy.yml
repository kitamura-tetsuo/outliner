name: Deploy

on:
  workflow_run:
    workflows: ['Test']
    types:
      - completed
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: true             # wipe workspace before fetch

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools@latest

      - name: Create client env file
        run: |
          cat > client/.env.production <<EOF2
          VITE_AZURE_TENANT_ID=${{ secrets.AZURE_TENANT_ID }}
          VITE_AZURE_FLUID_RELAY_ENDPOINT=${{ secrets.AZURE_ENDPOINT }}
          VITE_USE_FIREBASE_AUTH=true
          VITE_USE_API_AUTH=true
          VITE_USE_TINYLICIOUS=false
          VITE_FORCE_AZURE=true
          VITE_API_SERVER_URL=https://outliner-d57b0.web.app
          VITE_FIREBASE_FUNCTIONS_URL=https://outliner-d57b0.web.app
          VITE_DISABLE_FLUID_TELEMETRY=true
          VITE_FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN=outliner-d57b0.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID=outliner-d57b0
          VITE_FIREBASE_STORAGE_BUCKET=outliner-d57b0.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID=560407608873
          VITE_FIREBASE_APP_ID=1:560407608873:web:147817f4a93a4678606638
          VITE_FIREBASE_MEASUREMENT_ID=G-FKSFRCT7GR
          EOF2

      - name: Install client dependencies and build
        run: |
          cd client
          npm ci
          npm run build:production

      - name: Install functions dependencies
        run: |
          cd functions
          npm ci

      - name: Set Firebase project
        run: firebase use outliner-d57b0 --token "${{ secrets.FIREBASE_TOKEN }}"

      - name: Clean up problematic functions and update secrets
        run: |
          # 問題のある関数を削除（環境変数とシークレットの競合を解決するため）
          echo "Deleting problematic functions to resolve config conflicts..."
          firebase functions:delete fluidToken --project outliner-d57b0 --token "${{ secrets.FIREBASE_TOKEN }}" --force || echo "fluidToken function not found or already deleted"

          # 既存のFirebase Functions環境変数を削除
          echo "Cleaning up old Firebase Functions config..."
          firebase functions:config:unset azure --project outliner-d57b0 --token "${{ secrets.FIREBASE_TOKEN }}" || echo "No azure config to remove"

          # Firebase シークレットを GitHub Actions のシークレットから更新
          echo "Updating Firebase secrets..."

          # Azure関連のシークレットを更新
          echo "${{ secrets.AZURE_PRIMARY_KEY }}" | firebase functions:secrets:set AZURE_PRIMARY_KEY --project outliner-d57b0 --token "${{ secrets.FIREBASE_TOKEN }}" --data-file=-
          echo "${{ secrets.AZURE_SECONDARY_KEY }}" | firebase functions:secrets:set AZURE_SECONDARY_KEY --project outliner-d57b0 --token "${{ secrets.FIREBASE_TOKEN }}" --data-file=-
          echo "${{ secrets.AZURE_ACTIVE_KEY }}" | firebase functions:secrets:set AZURE_ACTIVE_KEY --project outliner-d57b0 --token "${{ secrets.FIREBASE_TOKEN }}" --data-file=-
          echo "${{ secrets.AZURE_TENANT_ID }}" | firebase functions:secrets:set AZURE_TENANT_ID --project outliner-d57b0 --token "${{ secrets.FIREBASE_TOKEN }}" --data-file=-
          echo "${{ secrets.AZURE_ENDPOINT }}" | firebase functions:secrets:set AZURE_ENDPOINT --project outliner-d57b0 --token "${{ secrets.FIREBASE_TOKEN }}" --data-file=-

          echo "Firebase secrets updated successfully"

      - name: Lint functions
        run: |
          cd functions
          npm run lint -- --fix

      - name: Deploy to Firebase
        run: firebase deploy --project outliner-d57b0 --token "${{ secrets.FIREBASE_TOKEN }}" --non-interactive --force
