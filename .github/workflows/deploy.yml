name: Deploy

on:
  workflow_run:
    workflows: ['CI']
    types:
      - completed
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: true             # wipe workspace before fetch

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools@latest

      - name: Install client dependencies and build
        run: |
          cd client
          npm ci
          npm run build:production

      - name: Install functions dependencies
        run: |
          cd functions
          npm ci

      - name: Install server dependencies and build
        run: |
          cd server
          npm ci
          npm run build

      - name: Create Sentry release (Client)
        if: ${{ env.SENTRY_AUTH_TOKEN != '' && vars.SENTRY_ORG != '' && vars.SENTRY_PROJECT_CLIENT != '' }}
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ vars.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ vars.SENTRY_PROJECT_CLIENT }}
        with:
          environment: production
          sourcemaps: './build'
          ignore_missing: true
          ignore_empty: true

      - name: Create Sentry release (Server)
        if: ${{ env.SENTRY_AUTH_TOKEN != '' && vars.SENTRY_ORG != '' && vars.SENTRY_PROJECT_SERVER != '' }}
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ vars.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ vars.SENTRY_PROJECT_SERVER }}
        with:
          environment: production
          sourcemaps: './server/dist'
          ignore_missing: true
          ignore_empty: true

      - name: Create Sentry release (Functions)
        if: ${{ env.SENTRY_AUTH_TOKEN != '' && vars.SENTRY_ORG != '' && vars.SENTRY_PROJECT_FUNCTIONS != '' }}
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ vars.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ vars.SENTRY_PROJECT_FUNCTIONS }}
        with:
          environment: production
          sourcemaps: './functions'
          ignore_missing: true
          ignore_empty: true


      - name: Setup GCP credentials
        if: github.actor != 'dependabot[bot]'
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS="$RUNNER_TEMP/gcp-key.json"
          echo '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}' > "$GOOGLE_APPLICATION_CREDENTIALS"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS" >> "$GITHUB_ENV"
      - name: Set Firebase project
        if: github.actor != 'dependabot[bot]'
        run: firebase use outliner-d57b0

      - name: Clean up old Firebase Functions config
        if: github.actor != 'dependabot[bot]'
        run: |
          # Remove existing Firebase Functions environment variables
          echo "Cleaning up old Firebase Functions config..."
          firebase functions:config:unset azure --project outliner-d57b0 || echo "No azure config to remove"

      - name: Lint functions
        run: |
          cd functions
          npm run lint -- --fix

      - name: Verify Firebase CLI version
        run: |
          echo "Firebase CLI version:"
          firebase --version

      - name: Deploy to Firebase
        if: github.actor != 'dependabot[bot]'
        run: firebase deploy --only hosting,functions,firestore:rules,storage --project outliner-d57b0 --non-interactive --force
