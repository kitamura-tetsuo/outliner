name: Deploy

on:
  workflow_run:
    workflows: ['CI']
    types:
      - completed
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: true             # wipe workspace before fetch

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools@latest

      - name: Check YJS_WS_URL
        run: |
          if [ -z "${{ vars.YJS_WS_URL }}" ]; then
            echo "Error: GitHub Actions variable YJS_WS_URL is not set or is empty."
            exit 1
          fi
          echo "YJS_WS_URL=${{ vars.YJS_WS_URL }}"

      - name: Create client env file
        run: |
          cat > client/.env.production <<EOF2
          VITE_AZURE_TENANT_ID=${{ secrets.AZURE_TENANT_ID }}
          VITE_AZURE_FLUID_RELAY_ENDPOINT=${{ secrets.AZURE_ENDPOINT }}
          VITE_USE_FIREBASE_AUTH=true
          VITE_USE_API_AUTH=true
          VITE_USE_TINYLICIOUS=false
          VITE_FORCE_AZURE=true
          VITE_API_SERVER_URL=https://outliner-d57b0.web.app
          VITE_FIREBASE_FUNCTIONS_URL=https://outliner-d57b0.web.app
          VITE_DISABLE_FLUID_TELEMETRY=true
          VITE_FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN=outliner-d57b0.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID=outliner-d57b0
          VITE_FIREBASE_STORAGE_BUCKET=outliner-d57b0.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID=560407608873
          VITE_FIREBASE_APP_ID=1:560407608873:web:147817f4a93a4678606638
          VITE_FIREBASE_MEASUREMENT_ID=G-FKSFRCT7GR
          VITE_YJS_WS_URL=${{ vars.YJS_WS_URL }}

          EOF2

      - name: Install client dependencies and build
        env:
          VITE_YJS_WS_URL: ${{ vars.YJS_WS_URL }}

        run: |
          cd client
          npm ci
          npm run build:production

      - name: Install functions dependencies
        run: |
          cd functions
          npm ci

      - name: Install server dependencies and build
        run: |
          cd server
          npm ci
          npm run build

      - name: Create Sentry release (Client)
        if: ${{ env.SENTRY_AUTH_TOKEN != '' && vars.SENTRY_ORG != '' && vars.SENTRY_PROJECT_CLIENT != '' }}
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ vars.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ vars.SENTRY_PROJECT_CLIENT }}
        with:
          environment: production
          sourcemaps: './build'
          ignore_missing: true
          ignore_empty: true

      - name: Create Sentry release (Server)
        if: ${{ env.SENTRY_AUTH_TOKEN != '' && vars.SENTRY_ORG != '' && vars.SENTRY_PROJECT_SERVER != '' }}
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ vars.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ vars.SENTRY_PROJECT_SERVER }}
        with:
          environment: production
          sourcemaps: './server/dist'
          ignore_missing: true
          ignore_empty: true

      - name: Create Sentry release (Functions)
        if: ${{ env.SENTRY_AUTH_TOKEN != '' && vars.SENTRY_ORG != '' && vars.SENTRY_PROJECT_FUNCTIONS != '' }}
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ vars.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ vars.SENTRY_PROJECT_FUNCTIONS }}
        with:
          environment: production
          sourcemaps: './functions'
          ignore_missing: true
          ignore_empty: true


      - name: Setup GCP credentials
        if: github.actor != 'dependabot[bot]'
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS="$RUNNER_TEMP/gcp-key.json"
          echo '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}' > "$GOOGLE_APPLICATION_CREDENTIALS"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS" >> "$GITHUB_ENV"
      - name: Set Firebase project
        if: github.actor != 'dependabot[bot]'
        run: firebase use outliner-d57b0

      - name: Clean up old Firebase Functions config
        if: github.actor != 'dependabot[bot]'
        run: |
          # 既存のFirebase Functions環境変数を削除
          echo "Cleaning up old Firebase Functions config..."
          firebase functions:config:unset azure --project outliner-d57b0 || echo "No azure config to remove"

      - name: Lint functions
        run: |
          cd functions
          npm run lint -- --fix

      - name: Verify Firebase CLI version
        run: |
          echo "Firebase CLI version:"
          firebase --version

      - name: Deploy to Firebase
        if: github.actor != 'dependabot[bot]'
        run: firebase deploy --only hosting,functions,firestore:rules,storage --project outliner-d57b0 --non-interactive --force

