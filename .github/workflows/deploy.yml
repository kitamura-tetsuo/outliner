name: Deploy

on:
  workflow_run:
    workflows: ['Test']
    types:
      - completed
    branches: [main]

jobs:
  deploy:
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Install client dependencies and build
        run: |
          cd client
          npm ci
          npm run build

      - name: Install functions dependencies
        run: |
          cd functions
          npm ci

      - name: Create client env file
        run: |
          cat > client/.env <<EOF2
          VITE_AZURE_TENANT_ID=${{ secrets.AZURE_TENANT_ID }}
          VITE_AZURE_FLUID_RELAY_ENDPOINT=${{ secrets.AZURE_FLUID_RELAY_ENDPOINT }}
          VITE_USE_FIREBASE_AUTH=true
          VITE_USE_API_AUTH=true
          VITE_USE_TINYLICIOUS=false
          VITE_FORCE_AZURE=true
          VITE_API_SERVER_URL=https://outliner-d57b0.web.app
          VITE_FIREBASE_FUNCTIONS_URL=https://outliner-d57b0.web.app
          VITE_DISABLE_FLUID_TELEMETRY=true
          VITE_FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN=outliner-d57b0.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID=outliner-d57b0
          VITE_FIREBASE_STORAGE_BUCKET=outliner-d57b0.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID=560407608873
          VITE_FIREBASE_APP_ID=1:560407608873:web:147817f4a93a4678606638
          VITE_FIREBASE_MEASUREMENT_ID=G-FKSFRCT7GR
          EOF2

      - name: Create functions env file
        run: |
          cat > functions/.env <<EOF3
          AZURE_TENANT_ID=${{ secrets.AZURE_TENANT_ID }}
          AZURE_FLUID_RELAY_ENDPOINT=${{ secrets.AZURE_FLUID_RELAY_ENDPOINT }}
          AZURE_PRIMARY_KEY=${{ secrets.AZURE_PRIMARY_KEY }}
          AZURE_SECONDARY_KEY=${{ secrets.AZURE_SECONDARY_KEY }}
          AZURE_ACTIVE_KEY=${{ secrets.AZURE_ACTIVE_KEY }}
          NODE_ENV=production
          EOF3

      - name: Deploy to Firebase
        run: firebase deploy --token "${{ secrets.FIREBASE_TOKEN }}" --non-interactive
