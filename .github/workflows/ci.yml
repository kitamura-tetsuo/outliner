name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_run:
    workflows: ["Format Check and Auto-Fix"]
    types:
      - completed
    branches: [main, develop]

permissions:
  contents: write
  pull-requests: write
  packages: write

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref == 'refs/heads/main' && github.run_id || github.ref }}
  cancel-in-progress: true

jobs:
  # Check if we should skip this run
  check-skip:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # If triggered by workflow_run, check conclusion
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            if [[ "${{ github.event.workflow_run.conclusion }}" != "success" ]]; then
              echo "should_skip=true" >> $GITHUB_OUTPUT
              echo "Skipping because formatter workflow failed"
              exit 0
            fi

            # Check if the commit is the same as the triggering workflow's head_commit
            # If it is, then no new commit was created by the formatter, so we skip (duplicate of push trigger)
            HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"
            TRIGGERING_SHA="${{ github.event.workflow_run.head_sha }}"
            
            # Fetch the latest commit of the branch
            echo "Checking for changes on $HEAD_BRANCH..."
            LATEST_SHA=$(gh api repos/${{ github.repository }}/git/ref/heads/$HEAD_BRANCH --jq .object.sha)
             
            if [[ "$TRIGGERING_SHA" == "$LATEST_SHA" ]]; then
               echo "should_skip=true" >> $GITHUB_OUTPUT
               echo "Skipping because no changes were made by formatter (SHA matches)"
               exit 0
            else
               echo "Formatting changed code ($TRIGGERING_SHA != $LATEST_SHA). Running CI."
            fi
          fi
          
          # If triggered by push, check commit message for auto-fix
          if [[ "${{ github.event_name }}" == "push" ]]; then
            if [[ "${{ github.event.head_commit.message }}" == *"Auto-fix: Format code with dprint"* ]]; then
              echo "should_skip=true" >> $GITHUB_OUTPUT
              echo "Skipping auto-fix commit"
              exit 0
            fi
          fi
          
          echo "should_skip=false" >> $GITHUB_OUTPUT

  checks:
    needs: check-skip
    if: needs.check-skip.outputs.should_skip != 'true'
    uses: ./.github/workflows/pr-checks.yml
    secrets: inherit

  unit-test:
    needs: check-skip
    if: needs.check-skip.outputs.should_skip != 'true'
    uses: ./.github/workflows/pr-test-unit.yml
    secrets: inherit

  integration-test:
    needs: check-skip
    if: needs.check-skip.outputs.should_skip != 'true'
    uses: ./.github/workflows/pr-test-integration.yml
    secrets: inherit

  e2e-test:
    needs: check-skip
    if: needs.check-skip.outputs.should_skip != 'true'
    uses: ./.github/workflows/pr-test-e2e.yml
    secrets: inherit
