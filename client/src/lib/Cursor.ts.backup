// @ts-nocheck
// Fluid Frameworké–¢é€£ã®importã¯å‰Šé™¤ï¼ˆYjsãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰
import { editorOverlayStore as store } from "../stores/EditorOverlayStore.svelte";
import { store as generalStore } from "../stores/store.svelte";
import { ScrapboxFormatter } from "../utils/ScrapboxFormatter";
import { dataOperationHooks } from "./dataOperationHooks";
import { getLogger } from "./logger";
import { YjsProjectManager } from "./yjsProjectManager.svelte";

const logger = getLogger();

// ãƒšãƒ¼ã‚¸ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¦‹ã¤ã‘ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function findPageItem(item: Item): Item | null {
    console.log(`ğŸ”§ [findPageItem] Starting search for page item from item ${item.id}`);
    let current = item;
    let depth = 0;

    while (current && depth < 10) { // ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢
        console.log(`ğŸ”§ [findPageItem] Depth ${depth}: Current item ${current.id} (${current.text})`);

        const parent = Tree.parent(current);
        console.log(`ğŸ”§ [findPageItem] Parent:`, parent ? `exists (${typeof parent})` : "null");

        if (parent) {
            console.log(`ğŸ”§ [findPageItem] Parent is Items:`, Tree.is(parent, Items));
            if (Tree.is(parent, Items)) {
                const grandParent = Tree.parent(parent);
                console.log(`ğŸ”§ [findPageItem] GrandParent:`, grandParent ? `exists (${typeof grandParent})` : "null");
                console.log(
                    `ğŸ”§ [findPageItem] GrandParent is Project:`,
                    grandParent ? Tree.is(grandParent, Project) : false,
                );

                if (grandParent && Tree.is(grandParent, Project)) {
                    console.log(`ğŸ”§ [findPageItem] Found page item: ${current.id} (${current.text})`);
                    return current;
                }
            }
        }

        // è¦ªãŒã‚¢ã‚¤ãƒ†ãƒ ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å­˜åœ¨ã§åˆ¤å®šï¼‰
        if (parent && typeof parent === "object" && "id" in parent && "text" in parent) {
            current = parent as Item;
            depth++;
        } else {
            console.log(`ğŸ”§ [findPageItem] Parent is not an item, breaking`);
            break;
        }
    }

    console.log(`ğŸ”§ [findPageItem] Page item not found for item ${item.id}`);
    return null;
}

// Yjsã«ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°ã‚’é©ç”¨ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
async function applyTextUpdateToYjs(item: Item, newText: string): Promise<void> {
    const mode = (typeof window !== "undefined") ? localStorage.getItem("OUTLINER_MODE") : null;

    if (mode !== "yjs") {
        console.log(`ğŸ”§ [Yjs] Text update disabled for mode separation (mode: ${mode})`);
        return;
    }

    try {
        const yjsProjectManager = (window as any).__YJS_PROJECT_MANAGER__;
        if (!yjsProjectManager) {
            console.log(`ğŸ”§ [Yjs] YjsProjectManager not available for text update`);
            return;
        }

        console.log(`ğŸ”§ [Yjs] Updating text for item ${item.id} in Yjs mode: "${newText}"`);

        // YjsProjectManagerã§ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°ã‚’å®Ÿè¡Œ
        // ã¾ãšã€ã‚¢ã‚¤ãƒ†ãƒ ãŒå­˜åœ¨ã™ã‚‹ã‹ã‚’ç¢ºèªã—ã€å­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
        const pages = yjsProjectManager.getPages();
        if (pages.length > 0) {
            const page = pages[0]; // æœ€åˆã®ãƒšãƒ¼ã‚¸ã‚’ä½¿ç”¨
            const pageManager = await yjsProjectManager.connectToPage(page.id);

            // ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆã‚¢ã‚¤ãƒ†ãƒ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆï¼‰
            try {
                pageManager.updateItemText(item.id, newText);
                console.log(`ğŸ”§ [Yjs] Successfully updated text for item ${item.id}`);
            } catch (updateError) {
                // ã‚¢ã‚¤ãƒ†ãƒ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ–°è¦ä½œæˆ
                console.log(`ğŸ”§ [Yjs] Item ${item.id} not found, creating new item`);
                const createdItemId = await yjsProjectManager.addItemToPage(page.id, newText, "local", undefined, item.id);
                if (createdItemId) {
                    console.log(`ğŸ”§ [Yjs] Successfully created new item ${createdItemId} with text "${newText}"`);
                } else {
                    console.error(`ğŸ”§ [Yjs] Failed to create new item ${item.id}`);
                }
            }
        }
    } catch (error) {
        console.error(`ğŸ”§ [Yjs] Error updating text in Yjs mode:`, error);
    }
}

interface CursorOptions {
    itemId: string;
    offset: number;
    isActive: boolean;
    userId: string;
}

export class Cursor {
    cursorId: string;
    itemId: string;
    offset: number;
    isActive: boolean;
    userId: string;
    // ä¸Šä¸‹ã‚­ãƒ¼æ“ä½œæ™‚ã«ä½¿ç”¨ã™ã‚‹åˆæœŸåˆ—ä½ç½®
    private initialColumn: number | null = null;

    constructor(cursorId: string, opts: CursorOptions) {
        this.cursorId = cursorId;
        this.itemId = opts.itemId;
        this.offset = opts.offset;
        this.isActive = opts.isActive;
        this.userId = opts.userId;
    }

    // SharedTree ä¸Šã® Item ã‚’å†å¸°æ¤œç´¢
    findTarget(): Item | undefined {
        const root = generalStore.currentPage;
        if (!root) return undefined;
        return this.searchItem(root, this.itemId);
    }

    // å‰ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¢ã™
    private findPreviousItem(): Item | undefined {
        const root = generalStore.currentPage;
        if (!root) return undefined;
        return this.findPreviousItemRecursive(root, this.itemId);
    }

    private findPreviousItemRecursive(node: Item, targetId: string, prevItem?: Item): Item | undefined {
        if (node.id === targetId) {
            return prevItem;
        }

        // å­ã‚¢ã‚¤ãƒ†ãƒ ã‚’é…åˆ—ã¨ã—ã¦å–å¾—
        const children: Item[] = [];
        if (node.items && (node.items as Iterable<Item>)[Symbol.iterator]) {
            for (const child of node.items as Iterable<Item>) {
                children.push(child);
            }
        }

        // å­ã‚¢ã‚¤ãƒ†ãƒ ã‚’é †ç•ªã«å‡¦ç†
        for (let i = 0; i < children.length; i++) {
            const child = children[i];

            // ç¾åœ¨ã®å­ãŒã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®å ´åˆã€å‰ã®å…„å¼Ÿã¾ãŸã¯è¦ªã‚’è¿”ã™
            if (child.id === targetId) {
                return i > 0 ? children[i - 1] : node;
            }

            // å­ã®å­å­«ã‚’å†å¸°çš„ã«æ¤œç´¢
            const found = this.findPreviousItemRecursive(child, targetId, i > 0 ? children[i - 1] : node);
            if (found) return found;
        }

        return undefined;
    }

    // æ¬¡ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¢ã™
    private findNextItem(): Item | undefined {
        const root = generalStore.currentPage;
        if (!root) return undefined;
        return this.findNextItemRecursive(root, this.itemId);
    }

    private findNextItemRecursive(node: Item, targetId: string): Item | undefined {
        if (node.id === targetId) {
            // å­ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Œã°æœ€åˆã®å­ã‚’è¿”ã™
            if (node.items && (node.items as Iterable<Item>)[Symbol.iterator]) {
                const iterator = (node.items as Iterable<Item>)[Symbol.iterator]();
                const first = iterator.next();
                if (!first.done) return first.value;
            }
            return undefined; // å­ãŒãªã‘ã‚Œã°å…„å¼Ÿã‚’æ¢ã™ï¼ˆå‘¼ã³å‡ºã—å…ƒã§å‡¦ç†ï¼‰
        }

        // å­ã‚¢ã‚¤ãƒ†ãƒ ã‚’é…åˆ—ã¨ã—ã¦å–å¾—
        const children: Item[] = [];
        if (node.items && (node.items as Iterable<Item>)[Symbol.iterator]) {
            for (const child of node.items as Iterable<Item>) {
                children.push(child);
            }
        }

        // å­ã‚¢ã‚¤ãƒ†ãƒ ã‚’é †ç•ªã«å‡¦ç†
        for (let i = 0; i < children.length; i++) {
            const child = children[i];

            if (child.id === targetId) {
                // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®æ¬¡ã®å…„å¼ŸãŒã‚ã‚Œã°è¿”ã™
                if (i < children.length - 1) {
                    return children[i + 1];
                }
                // æ¬¡ã®å…„å¼ŸãŒãªã‘ã‚Œã°è¦ªã®æ¬¡ã®å…„å¼Ÿã‚’æ¢ã™ï¼ˆå‘¼ã³å‡ºã—å…ƒã§å‡¦ç†ï¼‰
                return undefined;
            }

            const found = this.findNextItemRecursive(child, targetId);
            if (found) return found;
        }

        return undefined;
    }

    private searchItem(node: Item, id: string): Item | undefined {
        if (node.id === id) return node;
        for (const child of node.items as Iterable<Item>) {
            const found = this.searchItem(child, id);
            if (found) return found;
        }
        return undefined;
    }

    applyToStore() {
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
            console.log(
                `Cursor.applyToStore called for cursorId=${this.cursorId}, itemId=${this.itemId}, offset=${this.offset}`,
            );
        }

        // æ—¢å­˜ã®ã‚«ãƒ¼ã‚½ãƒ«ã‚’æ›´æ–°
        store.updateCursor({
            cursorId: this.cursorId,
            itemId: this.itemId,
            offset: this.offset,
            isActive: this.isActive,
            userId: this.userId,
        });

        // ã‚«ãƒ¼ã‚½ãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ–°ã—ãä½œæˆ
        const inst = store.cursorInstances.get(this.cursorId);
        if (!inst) {
            const cursorId = store.setCursor({
                itemId: this.itemId,
                offset: this.offset,
                isActive: this.isActive,
                userId: this.userId,
            });
            this.cursorId = cursorId;
        }

        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¨­å®š
        if (this.isActive) {
            store.setActiveItem(this.itemId);

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’è¨­å®š
            const textarea = store.getTextareaRef();
            if (textarea) {
                // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç¢ºå®Ÿã«è¨­å®šã™ã‚‹ãŸã‚ã®è¤‡æ•°ã®è©¦è¡Œ
                textarea.focus();

                // requestAnimationFrameã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’è¨­å®š
                requestAnimationFrame(() => {
                    textarea.focus();

                    // ã•ã‚‰ã«ç¢ºå®Ÿã«ã™ã‚‹ãŸã‚ã«setTimeoutã‚‚ä½µç”¨
                    setTimeout(() => {
                        textarea.focus();

                        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                        if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                            console.log(
                                `Cursor.applyToStore: Focus set. Active element is textarea: ${
                                    document.activeElement === textarea
                                }`,
                            );
                        }
                    }, 10);
                });
            } else {
                // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
                if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                    console.error(`Cursor.applyToStore: Global textarea not found`);
                }
            }
        }
    }

    // ãƒ†ã‚­ã‚¹ãƒˆå†…ã®è¡Œæ•°ã‚’è¨ˆç®—
    private countLines(text: string): number {
        return text.split("\n").length;
    }

    // æŒ‡å®šã—ãŸè¡Œã®é–‹å§‹ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’å–å¾—
    private getLineStartOffset(text: string, lineIndex: number): number {
        const lines = text.split("\n");
        let offset = 0;
        for (let i = 0; i < lineIndex; i++) {
            if (i < lines.length) {
                offset += lines[i].length + 1; // +1 ã¯æ”¹è¡Œæ–‡å­—åˆ†
            }
        }
        return offset;
    }

    // æŒ‡å®šã—ãŸè¡Œã®çµ‚äº†ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’å–å¾—
    private getLineEndOffset(text: string, lineIndex: number): number {
        const lines = text.split("\n");
        if (lineIndex >= lines.length) {
            return text.length;
        }

        let offset = 0;
        for (let i = 0; i < lineIndex; i++) {
            offset += lines[i].length + 1; // +1 ã¯æ”¹è¡Œæ–‡å­—åˆ†
        }
        // å¯¾è±¡è¡Œã®é•·ã•ã‚’åŠ ç®—ï¼ˆæ”¹è¡Œæ–‡å­—ã¯å«ã‚ãªã„ï¼‰
        offset += lines[lineIndex].length;
        return offset;
    }

    // ç¾åœ¨ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆãŒä½•è¡Œç›®ã‹ã‚’å–å¾—
    private getCurrentLineIndex(text: string, offset: number): number {
        // ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã®å ´åˆã¯0ã‚’è¿”ã™
        if (!text) return 0;

        const lines = text.split("\n");

        // ã‚ªãƒ•ã‚»ãƒƒãƒˆãŒãƒ†ã‚­ã‚¹ãƒˆé•·ã‚’è¶…ãˆã‚‹å ´åˆã¯æœ€å¾Œã®è¡Œã‚’è¿”ã™
        if (offset >= text.length) {
            return lines.length - 1;
        }

        let currentOffset = 0;
        for (let i = 0; i < lines.length; i++) {
            const lineLength = lines[i].length;

            // ç¾åœ¨ã®è¡Œå†…ã«ã‚ªãƒ•ã‚»ãƒƒãƒˆãŒã‚ã‚‹å ´åˆ
            if (offset < currentOffset + lineLength) {
                return i;
            }

            // æ¬¡ã®è¡Œã«é€²ã‚€ï¼ˆæ”¹è¡Œæ–‡å­—ã‚’å«ã‚€ï¼‰
            currentOffset += lineLength;
            if (i < lines.length - 1) {
                currentOffset += 1; // æ”¹è¡Œæ–‡å­—åˆ†
            }

            // æ”¹è¡Œæ–‡å­—ã®ä½ç½®ã«ã‚ªãƒ•ã‚»ãƒƒãƒˆãŒã‚ã‚‹å ´åˆã¯æ¬¡ã®è¡Œ
            if (offset === currentOffset && i < lines.length - 1) {
                return i + 1;
            }
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æœ€å¾Œã®è¡Œ
        return lines.length - 1;
    }

    // ç¾åœ¨ã®è¡Œå†…ã§ã®åˆ—ä½ç½®ã‚’å–å¾—
    private getCurrentColumn(text: string, offset: number): number {
        const lineIndex = this.getCurrentLineIndex(text, offset);
        const lineStartOffset = this.getLineStartOffset(text, lineIndex);
        return offset - lineStartOffset;
    }

    // è¦–è¦šçš„ãªè¡Œã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹
    private getVisualLineInfo(
        itemId: string,
        offset: number,
    ): {
        lineIndex: number;
        lineStartOffset: number;
        lineEndOffset: number;
        totalLines: number;
        lines: Array<{ startOffset: number; endOffset: number; y: number; }>;
    } | null {
        if (typeof window === "undefined") return null;

        const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
        if (!itemElement) return null;

        const textElement = itemElement.querySelector(".item-text") as HTMLElement;
        if (!textElement) return null;

        const text = textElement.textContent || "";
        if (text.length === 0) {
            return {
                lineIndex: 0,
                lineStartOffset: 0,
                lineEndOffset: 0,
                totalLines: 1,
                lines: [{ startOffset: 0, endOffset: 0, y: 0 }],
            };
        }

        // Range API ã‚’ä½¿ç”¨ã—ã¦è¦–è¦šçš„ãªè¡Œã‚’åˆ¤å®š
        const textNode = Array.from(textElement.childNodes).find(node => node.nodeType === Node.TEXT_NODE) as Text;
        if (!textNode) return null;

        try {
            // å„æ–‡å­—ä½ç½®ã§ã® Y åº§æ¨™ã‚’å–å¾—ã—ã¦è¡Œã‚’åˆ¤å®š
            const lines: { startOffset: number; endOffset: number; y: number; }[] = [];
            let currentLineY: number | null = null;
            let currentLineStart = 0;

            // 1æ–‡å­—å˜ä½ã§ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã—ã¦æ­£ç¢ºãªè¡Œå¢ƒç•Œã‚’æ¤œå‡º
            const step = 1;

            for (let i = 0; i <= text.length; i += step) {
                const actualOffset = Math.min(i, text.length);
                const range = document.createRange();
                const safeOffset = Math.min(actualOffset, textNode.textContent?.length || 0);
                range.setStart(textNode, safeOffset);
                range.setEnd(textNode, safeOffset);

                const rect = range.getBoundingClientRect();
                const y = Math.round(rect.top);

                if (currentLineY === null) {
                    currentLineY = y;
                } else if (Math.abs(y - currentLineY) > 2) { // 2pxä»¥ä¸Šã®å·®ãŒã‚ã‚Œã°æ–°ã—ã„è¡Œï¼ˆã‚ˆã‚Šç²¾å¯†ã«æ¤œå‡ºï¼‰
                    // æ–°ã—ã„è¡ŒãŒå§‹ã¾ã£ãŸ
                    lines.push({
                        startOffset: currentLineStart,
                        endOffset: Math.max(currentLineStart, actualOffset - 1), // æœ€ä½ã§ã‚‚é–‹å§‹ä½ç½®ã¯å«ã‚ã‚‹
                        y: currentLineY,
                    });
                    currentLineStart = actualOffset;
                    currentLineY = y;
                }
            }

            // æœ€å¾Œã®è¡Œã‚’è¿½åŠ 
            if (currentLineY !== null) {
                lines.push({
                    startOffset: currentLineStart,
                    endOffset: text.length,
                    y: currentLineY,
                });
            }

            // è¡ŒãŒæ¤œå‡ºã•ã‚Œãªã‹ã£ãŸå ´åˆã¯å˜ä¸€è¡Œã¨ã—ã¦æ‰±ã†
            if (lines.length === 0) {
                lines.push({
                    startOffset: 0,
                    endOffset: text.length,
                    y: textElement.getBoundingClientRect().top,
                });
            }

            // ç¾åœ¨ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆãŒã©ã®è¡Œã«ã‚ã‚‹ã‹ã‚’åˆ¤å®š
            let currentLineIndex = 0;
            for (let i = 0; i < lines.length; i++) {
                if (offset >= lines[i].startOffset && offset <= lines[i].endOffset) {
                    currentLineIndex = i;
                    break;
                }
            }

            // ç¯„å›²å¤–ã®å ´åˆã¯æœ€å¾Œã®è¡Œã«è¨­å®š
            if (currentLineIndex >= lines.length) {
                currentLineIndex = lines.length - 1;
            }

            const currentLine = lines[currentLineIndex];
            return {
                lineIndex: currentLineIndex,
                lineStartOffset: currentLine.startOffset,
                lineEndOffset: currentLine.endOffset,
                totalLines: lines.length,
                lines: lines,
            };
        } catch (error) {
            console.error("Error getting visual line info:", error);
            return null;
        }
    }

    // æŒ‡å®šã—ãŸè¦–è¦šçš„ãªè¡Œã®ã‚ªãƒ•ã‚»ãƒƒãƒˆç¯„å›²ã‚’å–å¾—ã™ã‚‹
    private getVisualLineOffsetRange(
        itemId: string,
        lineIndex: number,
    ): { startOffset: number; endOffset: number; } | null {
        const visualInfo = this.getVisualLineInfo(itemId, 0); // ä»»æ„ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã§è¡Œæƒ…å ±ã‚’å–å¾—
        if (!visualInfo || lineIndex < 0 || lineIndex >= visualInfo.totalLines) {
            return null;
        }

        const targetLine = visualInfo.lines[lineIndex];
        return {
            startOffset: targetLine.startOffset,
            endOffset: targetLine.endOffset,
        };
    }

    // ä¸Šä¸‹ã‚­ãƒ¼ä»¥å¤–ã®æ“ä½œãŒè¡Œã‚ã‚ŒãŸã¨ãã«åˆæœŸåˆ—ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
    private resetInitialColumn() {
        this.initialColumn = null;
    }

    moveLeft() {
        // ä¸Šä¸‹ã‚­ãƒ¼ä»¥å¤–ã®æ“ä½œãªã®ã§åˆæœŸåˆ—ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
        this.resetInitialColumn();

        const target = this.findTarget();
        if (!target) return;

        if (this.offset > 0) {
            this.offset = Math.max(0, this.offset - 1);
            this.applyToStore();

            // ã‚«ãƒ¼ã‚½ãƒ«ãŒæ­£ã—ãæ›´æ–°ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
            store.startCursorBlink();
        } else {
            // è¡Œé ­ã§å‰ã‚¢ã‚¤ãƒ†ãƒ ã¸ç§»å‹•
            this.navigateToItem("left");
        }
    }

    moveRight() {
        // ä¸Šä¸‹ã‚­ãƒ¼ä»¥å¤–ã®æ“ä½œãªã®ã§åˆæœŸåˆ—ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
        this.resetInitialColumn();

        const target = this.findTarget();
        const text = target?.text ?? "";

        // ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§ãªã„å ´åˆã®ã¿ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’å¢—åŠ 
        if (text.length > 0 && this.offset < text.length) {
            this.offset = this.offset + 1;
            this.applyToStore();

            // ã‚«ãƒ¼ã‚½ãƒ«ãŒæ­£ã—ãæ›´æ–°ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
            store.startCursorBlink();
        } else {
            // è¡Œæœ«ã¾ãŸã¯ç©ºã®ãƒ†ã‚­ã‚¹ãƒˆã®å ´åˆã¯æ¬¡ã‚¢ã‚¤ãƒ†ãƒ ã¸ç§»å‹•
            this.navigateToItem("right");
        }
    }

    moveUp() {
        const target = this.findTarget();
        if (!target) return;

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
            console.log(`moveUp called for itemId=${this.itemId}, offset=${this.offset}`);
        }

        // è¦–è¦šçš„ãªè¡Œã®æƒ…å ±ã‚’å–å¾—
        const visualLineInfo = this.getVisualLineInfo(this.itemId, this.offset);

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
            console.log(`getVisualLineInfo result:`, visualLineInfo);
        }

        if (!visualLineInfo) {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: è«–ç†çš„ãªè¡Œã§ã®å‡¦ç†ï¼ˆæ”¹è¡Œæ–‡å­—ãƒ™ãƒ¼ã‚¹ï¼‰
            const text = target.text || "";
            const currentLineIndex = this.getCurrentLineIndex(text, this.offset);
            if (currentLineIndex > 0) {
                const prevLineStart = this.getLineStartOffset(text, currentLineIndex - 1);
                this.offset = prevLineStart;
                this.applyToStore();
                store.startCursorBlink();
            } else {
                this.navigateToItem("up");
            }
            return;
        }

        const { lineIndex, lineStartOffset, totalLines } = visualLineInfo;

        // ç¾åœ¨ã®åˆ—ä½ç½®ã‚’è¨ˆç®—ï¼ˆè¦–è¦šçš„ãªè¡Œå†…ã§ã®ä½ç½®ï¼‰
        const currentColumn = this.offset - lineStartOffset;

        // åˆæœŸåˆ—ä½ç½®ã‚’è¨­å®šã¾ãŸã¯æ›´æ–°
        if (this.initialColumn === null) {
            this.initialColumn = currentColumn;
        }

        // ä½¿ç”¨ã™ã‚‹åˆ—ä½ç½®ï¼ˆåˆæœŸåˆ—ä½ç½®ï¼‰
        const targetColumn = this.initialColumn;

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
            console.log(
                `Visual line info: lineIndex=${lineIndex}, totalLines=${totalLines}, currentColumn=${currentColumn}, targetColumn=${targetColumn}`,
            );
        }

        if (lineIndex > 0) {
            // åŒã˜ã‚¢ã‚¤ãƒ†ãƒ å†…ã®ä¸Šã®è¦–è¦šçš„ãªè¡Œã«ç§»å‹•
            const prevLineRange = this.getVisualLineOffsetRange(this.itemId, lineIndex - 1);
            if (prevLineRange) {
                const prevLineLength = prevLineRange.endOffset - prevLineRange.startOffset;
                // åˆæœŸåˆ—ä½ç½®ã‹è¡Œã®é•·ã•ã®çŸ­ã„æ–¹ã«ç§»å‹•
                this.offset = prevLineRange.startOffset + Math.min(targetColumn, prevLineLength);
                this.applyToStore();

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                    console.log(
                        `Moved to previous visual line in same item: offset=${this.offset}, targetColumn=${targetColumn}`,
                    );
                }

                // ã‚«ãƒ¼ã‚½ãƒ«ç‚¹æ»…ã‚’é–‹å§‹
                store.startCursorBlink();
            }
        } else {
            // å‰ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¢ã™
            const prevItem = this.findPreviousItem();
            if (prevItem) {
                // å‰ã®ã‚¢ã‚¤ãƒ†ãƒ ã®æœ€å¾Œã®è¦–è¦šçš„ãªè¡Œã«ç§»å‹•
                this.navigateToItem("up");

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                    console.log(`Moved to previous item: itemId=${this.itemId}, offset=${this.offset}`);
                }
            } else {
                // å‰ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒãªã„å ´åˆã¯ã€åŒã˜ã‚¢ã‚¤ãƒ†ãƒ ã®å…ˆé ­ã«ç§»å‹•
                if (this.offset > 0) {
                    this.offset = 0;
                    this.applyToStore();

                    // ã‚«ãƒ¼ã‚½ãƒ«ãŒæ­£ã—ãæ›´æ–°ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
                    store.startCursorBlink();

                    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                    if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                        console.log(`Moved to start of current item: offset=${this.offset}`);
                    }
                }
            }
        }
    }

    moveDown() {
        const target = this.findTarget();
        if (!target) return;

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
            console.log(`moveDown called for itemId=${this.itemId}, offset=${this.offset}`);
        }

        // è¦–è¦šçš„ãªè¡Œã®æƒ…å ±ã‚’å–å¾—
        const visualLineInfo = this.getVisualLineInfo(this.itemId, this.offset);

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
            console.log(`getVisualLineInfo result:`, visualLineInfo);
        }

        if (!visualLineInfo) {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: è«–ç†çš„ãªè¡Œã§ã®å‡¦ç†ï¼ˆæ”¹è¡Œæ–‡å­—ãƒ™ãƒ¼ã‚¹ï¼‰
            const text = target.text || "";
            const lines = text.split("\n");
            const currentLineIndex = this.getCurrentLineIndex(text, this.offset);
            if (currentLineIndex < lines.length - 1) {
                const nextLineStart = this.getLineStartOffset(text, currentLineIndex + 1);
                this.offset = nextLineStart;
                this.applyToStore();
                store.startCursorBlink();
            } else {
                this.navigateToItem("down");
            }
            return;
        }

        const { lineIndex, lineStartOffset, totalLines } = visualLineInfo;

        // ç¾åœ¨ã®åˆ—ä½ç½®ã‚’è¨ˆç®—ï¼ˆè¦–è¦šçš„ãªè¡Œå†…ã§ã®ä½ç½®ï¼‰
        const currentColumn = this.offset - lineStartOffset;

        // åˆæœŸåˆ—ä½ç½®ã‚’è¨­å®šã¾ãŸã¯æ›´æ–°
        if (this.initialColumn === null) {
            this.initialColumn = currentColumn;
        }

        // ä½¿ç”¨ã™ã‚‹åˆ—ä½ç½®ï¼ˆåˆæœŸåˆ—ä½ç½®ï¼‰
        const targetColumn = this.initialColumn;

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
            console.log(
                `Visual line info: lineIndex=${lineIndex}, totalLines=${totalLines}, currentColumn=${currentColumn}, targetColumn=${targetColumn}`,
            );
        }

        if (lineIndex < totalLines - 1) {
            // åŒã˜ã‚¢ã‚¤ãƒ†ãƒ å†…ã®ä¸‹ã®è¦–è¦šçš„ãªè¡Œã«ç§»å‹•
            const nextLineRange = this.getVisualLineOffsetRange(this.itemId, lineIndex + 1);
            if (nextLineRange) {
                const nextLineLength = nextLineRange.endOffset - nextLineRange.startOffset;
                // åˆæœŸåˆ—ä½ç½®ã‹è¡Œã®é•·ã•ã®çŸ­ã„æ–¹ã«ç§»å‹•
                this.offset = nextLineRange.startOffset + Math.min(targetColumn, nextLineLength);
                this.applyToStore();

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                    console.log(
                        `Moved to next visual line in same item: offset=${this.offset}, targetColumn=${targetColumn}`,
                    );
                }

                // ã‚«ãƒ¼ã‚½ãƒ«ç‚¹æ»…ã‚’é–‹å§‹
                store.startCursorBlink();
            }
        } else {
            // æ¬¡ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¢ã™
            const nextItem = this.findNextItem();
            if (nextItem) {
                // æ¬¡ã®ã‚¢ã‚¤ãƒ†ãƒ ã®æœ€åˆã®è¦–è¦šçš„ãªè¡Œã«ç§»å‹•
                this.navigateToItem("down");

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                    console.log(`Moved to next item: itemId=${this.itemId}, offset=${this.offset}`);
                }
            } else {
                // æ¬¡ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒãªã„å ´åˆã¯ã€åŒã˜ã‚¢ã‚¤ãƒ†ãƒ ã®æœ«å°¾ã«ç§»å‹•
                const text = target.text || "";
                if (this.offset < text.length) {
                    this.offset = text.length;
                    this.applyToStore();

                    // ã‚«ãƒ¼ã‚½ãƒ«ãŒæ­£ã—ãæ›´æ–°ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
                    store.startCursorBlink();

                    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                    if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                        console.log(`Moved to end of current item: offset=${this.offset}`);
                    }
                }
            }
        }
    }

    /**
     * ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¿å…¥ã™ã‚‹
     * @param ch æŒ¿å…¥ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ
     */
    insertText(ch: string) {
        console.log(`ğŸ”§ [Cursor] insertText called with "${ch}" for item ${this.itemId}`);

        // ä¸Šä¸‹ã‚­ãƒ¼ä»¥å¤–ã®æ“ä½œãªã®ã§åˆæœŸåˆ—ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
        this.resetInitialColumn();

        const node = this.findTarget();
        if (!node) {
            console.error(`insertText: Target item not found for itemId: ${this.itemId}`);
            return;
        }

        console.log(`insertText: Inserting "${ch}" at offset ${this.offset} in item ${this.itemId}`);
        console.log(`insertText: Current text: "${node.text}"`);

        // é¸æŠç¯„å›²ãŒã‚ã‚‹å ´åˆã¯ã€é¸æŠç¯„å›²ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¿å…¥
        const selection = Object.values(store.selections).find(s =>
            s.userId === this.userId
            && s.startItemId === this.itemId
            && s.endItemId === this.itemId
        );

        if (selection && selection.startOffset !== selection.endOffset) {
            // é¸æŠç¯„å›²ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å‰Šé™¤
            const startOffset = Math.min(selection.startOffset, selection.endOffset);
            const endOffset = Math.max(selection.startOffset, selection.endOffset);
            let txt = node.text;
            txt = txt.slice(0, startOffset) + ch + txt.slice(endOffset);
            node.updateText(txt);

            // Yjsçµ±åˆ: ä¸¦è¡Œã—ã¦Yjsãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
            console.log(`ğŸ”§ [Cursor] Calling applyTextUpdateToYjs for item ${node.id} with text "${txt}"`);
            applyTextUpdateToYjs(node, txt).catch(error => {
                console.error(`ğŸ”§ [Cursor] applyTextUpdateToYjs failed: ${error}`);
            });

            // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’æ›´æ–°
            this.offset = startOffset + ch.length;

            // é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢
            this.clearSelection();

            console.log(`insertText: Updated text with selection: "${txt}"`);
        } else {
            // é€šå¸¸ã®æŒ¿å…¥
            let txt = node.text;
            txt = txt.slice(0, this.offset) + ch + txt.slice(this.offset);
            node.updateText(txt);

            // Yjsçµ±åˆ: ä¸¦è¡Œã—ã¦Yjsãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
            console.log(`ğŸ”§ [Cursor] Calling applyTextUpdateToYjs for item ${node.id} with text "${txt}"`);
            applyTextUpdateToYjs(node, txt).catch(error => {
                console.error(`ğŸ”§ [Cursor] applyTextUpdateToYjs failed: ${error}`);
            });

            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ä¸€è‡´ãƒã‚§ãƒƒã‚¯
            const oldText = node.text.slice(0, this.offset) + node.text.slice(this.offset);
            console.log(
                `ğŸ”§ [Cursor] Calling dataOperationHooks.afterItemUpdateText for item ${node.id} (old: "${oldText}", new: "${txt}")`,
            );
            dataOperationHooks.afterItemUpdateText(node.id as string, oldText, txt).catch(error => {
                console.error(`ğŸ”§ [Cursor] Data validation failed after insertText: ${error}`);
            });

            this.offset += ch.length;

            console.log(`insertText: Updated text: "${txt}"`);
        }

        this.applyToStore();

        // onEdit ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å‘¼ã³å‡ºã™
        store.triggerOnEdit();

        // æ³¨æ„: ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®å€¤ã‚’åŒæœŸã—ã¦ã¯ã„ã‘ãªã„
        // ãƒãƒ«ãƒã‚«ãƒ¼ã‚½ãƒ«ç’°å¢ƒã§ã¯ã€è¤‡æ•°ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒåŒæ™‚ã«ç·¨é›†ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€
        // å˜ä¸€ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ç‰¹å®šã®ã‚¢ã‚¤ãƒ†ãƒ ã®å€¤ã‚’è¨­å®šã™ã‚‹ã“ã¨ã¯é©åˆ‡ã§ã¯ãªã„
    }

    /**
     * ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã®å‰ã®æ–‡å­—ã‚’å‰Šé™¤ã™ã‚‹
     */
    deleteBackward() {
        // ä¸Šä¸‹ã‚­ãƒ¼ä»¥å¤–ã®æ“ä½œãªã®ã§åˆæœŸåˆ—ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
        this.resetInitialColumn();

        const node = this.findTarget();
        if (!node) return;

        // é¸æŠç¯„å›²ãŒã‚ã‚‹å ´åˆã¯ã€é¸æŠç¯„å›²ã‚’å‰Šé™¤
        const selection = Object.values(store.selections).find(s => s.userId === this.userId);

        if (selection && selection.startOffset !== selection.endOffset) {
            // è¤‡æ•°ã‚¢ã‚¤ãƒ†ãƒ ã«ã¾ãŸãŒã‚‹é¸æŠç¯„å›²ã®å ´åˆ
            if (selection.startItemId !== selection.endItemId) {
                this.deleteMultiItemSelection(selection);
                return;
            }

            // å˜ä¸€ã‚¢ã‚¤ãƒ†ãƒ å†…ã®é¸æŠç¯„å›²ã®å ´åˆ
            if (selection.startItemId === this.itemId && selection.endItemId === this.itemId) {
                // é¸æŠç¯„å›²ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å‰Šé™¤
                const startOffset = Math.min(selection.startOffset, selection.endOffset);
                const endOffset = Math.max(selection.startOffset, selection.endOffset);
                let txt = node.text;
                txt = txt.slice(0, startOffset) + txt.slice(endOffset);
                node.updateText(txt);

                // Yjsçµ±åˆ: ä¸¦è¡Œã—ã¦Yjsãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
                applyTextUpdateToYjs(node, txt);

                // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’æ›´æ–°
                this.offset = startOffset;

                // é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢
                this.clearSelection();
            }
        } else {
            // é€šå¸¸ã®å‰Šé™¤
            if (this.offset > 0) {
                let txt = node.text;
                const oldText = txt;
                const pos = this.offset - 1;
                txt = txt.slice(0, pos) + txt.slice(pos + 1);
                node.updateText(txt);

                // Yjsçµ±åˆ: ä¸¦è¡Œã—ã¦Yjsãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
                applyTextUpdateToYjs(node, txt);

                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ä¸€è‡´ãƒã‚§ãƒƒã‚¯
                dataOperationHooks.afterItemUpdateText(node.id as string, oldText, txt).catch(error => {
                    console.error(`ğŸ”§ [Cursor] Data validation failed after deleteBackward: ${error}`);
                });

                this.offset = Math.max(0, this.offset - 1);
            } else {
                // è¡Œé ­ã§å‰ã‚¢ã‚¤ãƒ†ãƒ ã¨ã®çµåˆ
                this.mergeWithPreviousItem();
            }
        }

        this.applyToStore();

        // onEdit ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å‘¼ã³å‡ºã™
        store.triggerOnEdit();

        // æ³¨æ„: ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®å€¤ã‚’åŒæœŸã—ã¦ã¯ã„ã‘ãªã„
        // ãƒãƒ«ãƒã‚«ãƒ¼ã‚½ãƒ«ç’°å¢ƒã§ã¯ã€è¤‡æ•°ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒåŒæ™‚ã«ç·¨é›†ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€
        // å˜ä¸€ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ç‰¹å®šã®ã‚¢ã‚¤ãƒ†ãƒ ã®å€¤ã‚’è¨­å®šã™ã‚‹ã“ã¨ã¯é©åˆ‡ã§ã¯ãªã„
    }

    /**
     * ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã®å¾Œã®æ–‡å­—ã‚’å‰Šé™¤ã™ã‚‹
     */
    deleteForward() {
        // ä¸Šä¸‹ã‚­ãƒ¼ä»¥å¤–ã®æ“ä½œãªã®ã§åˆæœŸåˆ—ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
        this.resetInitialColumn();

        const node = this.findTarget();
        if (!node) return;

        // é¸æŠç¯„å›²ãŒã‚ã‚‹å ´åˆã¯ã€é¸æŠç¯„å›²ã‚’å‰Šé™¤
        const selection = Object.values(store.selections).find(s => s.userId === this.userId);

        if (selection && selection.startOffset !== selection.endOffset) {
            // è¤‡æ•°ã‚¢ã‚¤ãƒ†ãƒ ã«ã¾ãŸãŒã‚‹é¸æŠç¯„å›²ã®å ´åˆ
            if (selection.startItemId !== selection.endItemId) {
                this.deleteMultiItemSelection(selection);
                return;
            }

            // å˜ä¸€ã‚¢ã‚¤ãƒ†ãƒ å†…ã®é¸æŠç¯„å›²ã®å ´åˆ
            if (selection.startItemId === this.itemId && selection.endItemId === this.itemId) {
                // é¸æŠç¯„å›²ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å‰Šé™¤
                const startOffset = Math.min(selection.startOffset, selection.endOffset);
                const endOffset = Math.max(selection.startOffset, selection.endOffset);
                let txt = node.text;
                txt = txt.slice(0, startOffset) + txt.slice(endOffset);
                node.updateText(txt);

                // Yjsçµ±åˆ: ä¸¦è¡Œã—ã¦Yjsãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
                applyTextUpdateToYjs(node, txt);

                // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’æ›´æ–°
                this.offset = startOffset;

                // é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢
                this.clearSelection();
            }
        } else {
            // é€šå¸¸ã®å‰Šé™¤
            let txt = node.text;
            if (this.offset < txt.length) {
                const oldText = txt;
                txt = txt.slice(0, this.offset) + txt.slice(this.offset + 1);
                node.updateText(txt);

                // Yjsçµ±åˆ: ä¸¦è¡Œã—ã¦Yjsãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
                applyTextUpdateToYjs(node, txt);

                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ä¸€è‡´ãƒã‚§ãƒƒã‚¯
                dataOperationHooks.afterItemUpdateText(node.id as string, oldText, txt).catch(error => {
                    console.error(`ğŸ”§ [Cursor] Data validation failed after deleteForward: ${error}`);
                });
            } else {
                // è¡Œæœ«ã®å ´åˆ
                // ã‚¢ã‚¤ãƒ†ãƒ ãŒç©ºã®å ´åˆã¯ã‚¢ã‚¤ãƒ†ãƒ è‡ªä½“ã‚’å‰Šé™¤
                if (txt.length === 0) {
                    this.deleteEmptyItem();
                    return;
                }
                // ç©ºã§ãªã„å ´åˆã¯æ¬¡ã‚¢ã‚¤ãƒ†ãƒ ã¨ã®çµåˆ
                this.mergeWithNextItem();
            }
        }

        this.applyToStore();

        // onEdit ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å‘¼ã³å‡ºã™
        store.triggerOnEdit();

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®å€¤ã‚‚åŒæœŸ
        const textarea = store.getTextareaRef();
        if (textarea) {
            textarea.value = node.text;
            textarea.setSelectionRange(this.offset, this.offset);
            console.log(`deleteForward: Synced textarea value: "${textarea.value}"`);
        }
    }

    /**
     * å‰ã®ã‚¢ã‚¤ãƒ†ãƒ ã¨çµåˆã™ã‚‹
     */
    private mergeWithPreviousItem() {
        const currentItem = this.findTarget();
        if (!currentItem) return;

        const prevItem = this.findPreviousItem();
        if (!prevItem) return;

        // å‰ã®ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
        const prevText = prevItem.text || "";
        const currentText = currentItem.text || "";

        // å‰ã®ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
        prevItem.updateText(prevText + currentText);

        // ç¾åœ¨ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ï¼ˆYjsã‚‚ä¸¦è¡Œã—ã¦å‰Šé™¤ï¼‰
        try {
            const ypm = (window as any).__YJS_PROJECT_MANAGER__;
            if (ypm && typeof ypm.getPages === 'function' && typeof ypm.connectToPage === 'function') {
                const pageTitle = decodeURIComponent((location.pathname.split('/')[2] || '').toString());
                const pages = ypm.getPages();
                const target = pages.find((p:any) => String(p.title||'') === pageTitle) || pages[0];
                if (target) {
                    ypm.connectToPage(target.id).then((mgr:any) => {
                        if (mgr && typeof mgr.removeItem === 'function') {
                            mgr.removeItem(currentItem.id);
                        }
                    }).catch((err:any) => console.warn('[Cursor] Yjs connectToPage failed during mergeWithPreviousItem:', err));
                }
            }
        } catch (e) {
            console.warn("[Cursor] Yjs removal during mergeWithPreviousItem failed:", e);
        }
        currentItem.delete();

        // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’æ›´æ–°
        const oldItemId = this.itemId;
        this.itemId = prevItem.id;
        this.offset = prevText.length;

        // å¤ã„ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚«ãƒ¼ã‚½ãƒ«ã‚’ã‚¯ãƒªã‚¢ï¼ˆã‚¢ã‚¤ãƒ†ãƒ å‰Šé™¤å¾Œï¼‰
        store.clearCursorForItem(oldItemId);

        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¨­å®š
        store.setActiveItem(this.itemId);

        // ã‚«ãƒ¼ã‚½ãƒ«ã®ç‚¹æ»…ã‚’é–‹å§‹
        store.startCursorBlink();
    }

    /**
     * æ¬¡ã®ã‚¢ã‚¤ãƒ†ãƒ ã¨çµåˆã™ã‚‹
     */
    private mergeWithNextItem() {
        const currentItem = this.findTarget();
        if (!currentItem) return;

        const nextItem = this.findNextItem();
        if (!nextItem) return;

        // ç¾åœ¨ã®ã‚¢ã‚¤ãƒ†ãƒ ã¨æ¬¡ã®ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
        const currentText = currentItem.text || "";
        const nextText = nextItem.text || "";

        // ç¾åœ¨ã®ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
        currentItem.updateText(currentText + nextText);

        // æ¬¡ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤
        // æ¬¡ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ï¼ˆYjsã‚‚ä¸¦è¡Œã—ã¦å‰Šé™¤ï¼‰
        try {
            const ypm = (window as any).__YJS_PROJECT_MANAGER__;
            if (ypm && typeof ypm.getPages === 'function' && typeof ypm.connectToPage === 'function') {
                const pageTitle = decodeURIComponent((location.pathname.split('/')[2] || '').toString());
                const pages = ypm.getPages();
                const target = pages.find((p:any) => String(p.title||'') === pageTitle) || pages[0];
                if (target) {
                    ypm.connectToPage(target.id).then((mgr:any) => {
                        if (mgr && typeof mgr.removeItem === 'function') {
                            mgr.removeItem(nextItem.id);
                        }
                    }).catch((err:any) => console.warn('[Cursor] Yjs connectToPage failed during mergeWithNextItem:', err));
                }
            }
        } catch (e) {
            console.warn("[Cursor] Yjs removal during mergeWithNextItem failed:", e);
        }
        nextItem.delete();

        // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã¯ãã®ã¾ã¾ï¼ˆç¾åœ¨ã®ã‚¢ã‚¤ãƒ†ãƒ ã®æœ«å°¾ï¼‰
    }

    /**
     * ç©ºã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ã™ã‚‹
     */
    private deleteEmptyItem() {
        const currentItem = this.findTarget();
        if (!currentItem) return;

        // ã‚¢ã‚¤ãƒ†ãƒ ãŒç©ºã§ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
        if (currentItem.text && currentItem.text.length > 0) return;

        // æ¬¡ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¢ã™
        const nextItem = this.findNextItem();

        // ã‚«ãƒ¼ã‚½ãƒ«ã‚’ç§»å‹•ã™ã‚‹å…ˆã‚’æ±ºå®š
        let targetItemId: string;
        let targetOffset: number;

        if (nextItem) {
            // æ¬¡ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚‹å ´åˆã¯æ¬¡ã®ã‚¢ã‚¤ãƒ†ãƒ ã®å…ˆé ­ã«ç§»å‹•
            targetItemId = nextItem.id;
            targetOffset = 0;
        } else {
            // æ¬¡ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒãªã„å ´åˆã¯å‰ã®ã‚¢ã‚¤ãƒ†ãƒ ã®æœ«å°¾ã«ç§»å‹•
            const prevItem = this.findPreviousItem();
            if (prevItem) {
                targetItemId = prevItem.id;
                targetOffset = prevItem.text ? prevItem.text.length : 0;
            } else {
                // å‰ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚‚ãªã„å ´åˆï¼ˆæœ€å¾Œã®1ã¤ã®ã‚¢ã‚¤ãƒ†ãƒ ï¼‰ã¯å‰Šé™¤ã—ãªã„
                return;
            }
        }

        // ç¾åœ¨ã®ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚«ãƒ¼ã‚½ãƒ«ã‚’ã‚¯ãƒªã‚¢
        store.clearCursorForItem(this.itemId);

        // ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ï¼ˆYjsã‚‚ä¸¦è¡Œã—ã¦å‰Šé™¤ï¼‰
        try {
            const ypm = (window as any).__YJS_PROJECT_MANAGER__;
            if (ypm && typeof ypm.getPages === 'function' && typeof ypm.connectToPage === 'function') {
                const pageTitle = decodeURIComponent((location.pathname.split('/')[2] || '').toString());
                const pages = ypm.getPages();
                const target = pages.find((p:any) => String(p.title||'') === pageTitle) || pages[0];
                if (target) {
                    ypm.connectToPage(target.id).then((mgr:any) => {
                        if (mgr && typeof mgr.removeItem === 'function') {
                            mgr.removeItem(currentItem.id);
                        }
                    }).catch((err:any) => console.warn('[Cursor] Yjs connectToPage failed during deleteEmptyItem:', err));
                }
            }
        } catch (e) {
            console.warn("[Cursor] Yjs removal during deleteEmptyItem failed:", e);
        }
        // ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤
        currentItem.delete();

        // æ–°ã—ã„ä½ç½®ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’è¨­å®š
        this.itemId = targetItemId;
        this.offset = targetOffset;

        // ã‚¹ãƒˆã‚¢ã‚’æ›´æ–°
        store.setActiveItem(this.itemId);
        store.setCursor({
            itemId: this.itemId,
            offset: this.offset,
            isActive: true,
            userId: this.userId,
        });

        // ã‚«ãƒ¼ã‚½ãƒ«ç‚¹æ»…ã‚’é–‹å§‹
        store.startCursorBlink();
    }

    insertLineBreak() {
        const __t0 = (typeof performance !== "undefined" && (performance as any).now) ? (performance as any).now() : Date.now();
        const target = this.findTarget();
        if (!target) { console.log(`â±ï¸ [Enter] insertLineBreak: target not found for itemId=${this.itemId}`); return; }

        const text = target.text || "";

        // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã§ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ†å‰²
        const beforeText = text.slice(0, this.offset);
        const afterText = text.slice(this.offset);

        // ã‚¿ã‚¤ãƒˆãƒ«ã‹ã©ã†ã‹ã‚’åˆ¤æ–­
        const isPageTitle = TreeViewManager.isPageItem(target);

        // Yjs é€£æºã¯ OutlinerTree.svelte å´ã§è¡Œã†ï¼ˆAGENTS.mdã®æ–¹é‡ã«å¾“ã„ã€Fluidã‚³ãƒ¼ãƒ‰ã«Yjsã‚’æ··åœ¨ã•ã›ãªã„ï¼‰
        console.log(`â±ï¸ [Enter] split text: before=${beforeText.length}, after=${afterText.length}, isPageTitle=${isPageTitle}`);

        if (isPageTitle) {
            // ã‚¿ã‚¤ãƒˆãƒ«ã®å ´åˆã¯æœ€åˆã®å­ã¨ã—ã¦è¿½åŠ 
            if (target.items && Tree.is(target.items, Items)) {
                // ç¾åœ¨ã®ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚ˆã‚Šå‰ã®ãƒ†ã‚­ã‚¹ãƒˆï¼‰
                target.updateText(beforeText);

                // æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆï¼ˆã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚ˆã‚Šå¾Œã®ãƒ†ã‚­ã‚¹ãƒˆï¼‰
                const newItem = target.items.addNode(this.userId, 0);
                newItem.updateText(afterText);

                // ã‚«ãƒ¼ã‚½ãƒ«ã‚’æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã®å…ˆé ­ã«ç§»å‹•
                const oldItemId = this.itemId;

                // å…¨ã¦ã®ã‚«ãƒ¼ã‚½ãƒ«ã‚’ã‚¯ãƒªã‚¢ã—ã¦å˜ä¸€ã‚«ãƒ¼ã‚½ãƒ«ãƒ¢ãƒ¼ãƒ‰ã‚’ç¶­æŒ
                store.clearCursorAndSelection(this.userId);

                // æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã¨ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è¨­å®š
                this.itemId = newItem.id;
                this.offset = 0;

                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ›´æ–°
                store.setActiveItem(this.itemId);

                // ã‚«ãƒ¼ã‚½ãƒ«ç‚¹æ»…ã‚’é–‹å§‹
                store.startCursorBlink();

                // ã‚¹ãƒˆã‚¢ã¸å…ˆã«åæ˜ 
                this.applyToStore();

                // ã‚¹ãƒˆã‚¢ã¸å…ˆã«åæ˜ 
                this.applyToStore();

                // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã¯æ¬¡ã‚¿ã‚¹ã‚¯ã§ç™ºè¡Œï¼ˆDOMæ›´æ–°å¾…ã¡ï¼‰
                if (typeof document !== "undefined") {
                    const event = new CustomEvent("navigate-to-item", {
                        bubbles: true,
                        detail: { direction: "enter", fromItemId: target.id, toItemId: this.itemId, t0: __t0 },
                    });
                    console.log(`â±ï¸ [Enter] schedule navigate-to-item enter toId=${this.itemId} delay=16`);
                    setTimeout(() => {
                        const now = (typeof performance !== "undefined" && (performance as any).now) ? (performance as any).now() : Date.now();
                        console.log(`â±ï¸ [Enter] dispatch navigate-to-item enter, dt=${now - __t0}ms`);
                        document.dispatchEvent(event);
                    }, 16);
                }
                return;
            }
        } else {
            // é€šå¸¸ã®ã‚¢ã‚¤ãƒ†ãƒ ã®å ´åˆã¯å…„å¼Ÿã¨ã—ã¦è¿½åŠ 
            const parent = Tree.parent(target);
            if (parent && Tree.is(parent, Items)) {
                // ç¾åœ¨ã®ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
                const currentIndex = parent.indexOf(target);

                // ç¾åœ¨ã®ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚ˆã‚Šå‰ã®ãƒ†ã‚­ã‚¹ãƒˆï¼‰
                target.updateText(beforeText);

                // æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆï¼ˆã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚ˆã‚Šå¾Œã®ãƒ†ã‚­ã‚¹ãƒˆï¼‰
                const newItem = parent.addNode(this.userId, currentIndex + 1);
                newItem.updateText(afterText);

                // ã‚«ãƒ¼ã‚½ãƒ«ã‚’æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã®å…ˆé ­ã«ç§»å‹•
                const oldItemId = this.itemId;

                // å…¨ã¦ã®ã‚«ãƒ¼ã‚½ãƒ«ã‚’ã‚¯ãƒªã‚¢ã—ã¦å˜ä¸€ã‚«ãƒ¼ã‚½ãƒ«ãƒ¢ãƒ¼ãƒ‰ã‚’ç¶­æŒ
                store.clearCursorAndSelection(this.userId);

                // æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã¨ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è¨­å®š
                this.itemId = newItem.id;
                this.offset = 0;

                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ›´æ–°
                store.setActiveItem(this.itemId);

                // ã‚«ãƒ¼ã‚½ãƒ«ç‚¹æ»…ã‚’é–‹å§‹
                store.startCursorBlink();

                // ã‚¹ãƒˆã‚¢ã¸å…ˆã«åæ˜ 
                this.applyToStore();

                // ã‚¹ãƒˆã‚¢ã¸å…ˆã«åæ˜ 
                this.applyToStore();

                // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã¯æ¬¡ã‚¿ã‚¹ã‚¯ã§ç™ºè¡Œï¼ˆDOMæ›´æ–°å¾…ã¡ï¼‰
                if (typeof document !== "undefined") {
                    const event = new CustomEvent("navigate-to-item", {
                        bubbles: true,
                        detail: { direction: "enter", fromItemId: target.id, toItemId: this.itemId, t0: __t0 },
                    });
                    console.log(`â±ï¸ [Enter] schedule navigate-to-item enter toId=${this.itemId} delay=16`);
                    setTimeout(() => {
                        const now = (typeof performance !== "undefined" && (performance as any).now) ? (performance as any).now() : Date.now();
                        console.log(`â±ï¸ [Enter] dispatch navigate-to-item enter, dt=${now - __t0}ms`);
                        document.dispatchEvent(event);
                    }, 16);
                }
                return;
            }
        }

        // è¦ªã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯é€šå¸¸ã®æ”¹è¡Œã‚’æŒ¿å…¥
        this.insertText("\n");
    }

    onInput(event: InputEvent) {
        const data = event.data;
        console.log(`Cursor.onInput called for item ${this.itemId}, data: "${data}", inputType: ${event.inputType}`);
        console.log(
            `Cursor.onInput: Current cursor state - itemId: ${this.itemId}, offset: ${this.offset}, isActive: ${this.isActive}`,
        );

        // æ³¨æ„: ãƒãƒ«ãƒã‚«ãƒ¼ã‚½ãƒ«ç’°å¢ƒã§ã¯ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®å€¤ã‚’ä½¿ã£ã¦
        // SharedTreeã‚’æ›´æ–°ã—ã¦ã¯ã„ã‘ãªã„ã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã¯å˜ä¸€ã®ã‚¢ã‚¤ãƒ†ãƒ ã®çŠ¶æ…‹ã‚’
        // è¡¨ã™ã‚‚ã®ã§ã¯ãªãã€è¤‡æ•°ã®ã‚«ãƒ¼ã‚½ãƒ«ãŒåŒæ™‚ã«ç·¨é›†ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

        // ä»£ã‚ã‚Šã«ã€InputEventã®dataã‚’ä½¿ã£ã¦é©åˆ‡ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¿å…¥ã™ã‚‹
        if (data && data.length > 0) {
            console.log(`Inserting text from input event: "${data}"`);
            this.insertText(data);
        } else {
            console.log(`No data in input event, skipping text insertion`);
        }
    }

    /**
     * ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã™ã‚‹
     * @param event ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆ
     * @returns ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã—ãŸã‹ã©ã†ã‹
     */
    onKeyDown(event: KeyboardEvent): boolean {
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
            console.log(`onKeyDown called with key=${event.key}, ctrlKey=${event.ctrlKey}, shiftKey=${event.shiftKey}`);
        }

        // é¸æŠç¯„å›²ã®æœ‰ç„¡ã‚’ç¢ºèª
        const hasSelection = Object.values(store.selections).some(s =>
            s.userId === this.userId
            && (s.startOffset !== s.endOffset || s.startItemId !== s.endItemId)
        );

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
            console.log(`Has selection: ${hasSelection}`);
            if (hasSelection) {
                console.log(`Selections:`, Object.values(store.selections).filter(s => s.userId === this.userId));
            }
        }

        // Ctrl/Cmd ã‚­ãƒ¼ãŒæŠ¼ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç‰¹æ®Šæ“ä½œ
        if (event.ctrlKey || event.metaKey) {
            switch (event.key) {
                case "a":
                case "A":
                    this.selectAll();
                    break;
                case "c":
                case "C":
                    this.copySelectedText();
                    return true;
                case "x":
                case "X":
                    this.cutSelectedText();
                    return true;
                case "v":
                case "V":
                    // ãƒšãƒ¼ã‚¹ãƒˆå‡¦ç†ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã«ä»»ã›ã‚‹
                    return false;
                case "ArrowLeft":
                    this.moveWordLeft();
                    break;
                case "ArrowRight":
                    this.moveWordRight();
                    break;
                case "ArrowUp":
                    this.scrollUp();
                    break;
                case "ArrowDown":
                    this.scrollDown();
                    break;
                case "Home":
                    this.moveToDocumentStart();
                    break;
                case "End":
                    this.moveToDocumentEnd();
                    break;
                case "PageUp":
                    this.pageUp();
                    break;
                case "PageDown":
                    this.pageDown();
                    break;
                case "\\":
                    if (event.shiftKey) {
                        this.jumpToMatchingBracket();
                        break;
                    } else {
                        return false;
                    }
                default:
                    return false;
            }
        } // Shift ã‚­ãƒ¼ãŒæŠ¼ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯é¸æŠç¯„å›²ã‚’æ‹¡å¼µ
        else if (event.shiftKey) {
            switch (event.key) {
                case "ArrowLeft":
                    this.extendSelectionLeft();
                    break;
                case "ArrowRight":
                    this.extendSelectionRight();
                    break;
                case "ArrowUp":
                    this.extendSelectionUp();
                    break;
                case "ArrowDown":
                    this.extendSelectionDown();
                    break;
                case "Home":
                    this.extendSelectionToLineStart();
                    break;
                case "End":
                    this.extendSelectionToLineEnd();
                    break;
                case "Enter":
                    this.insertLineBreak();
                    break;
                default:
                    return false;
            }
        } else {
            // é€šå¸¸ã®ã‚«ãƒ¼ã‚½ãƒ«ç§»å‹•
            switch (event.key) {
                case "ArrowLeft":
                    if (hasSelection) {
                        // é¸æŠç¯„å›²ãŒã‚ã‚‹å ´åˆã¯ã€é¸æŠç¯„å›²ã®é–‹å§‹ä½ç½®ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’ç§»å‹•ã—ã¦é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢
                        this.clearSelection();
                    } else {
                        this.moveLeft();
                    }
                    break;
                case "ArrowRight":
                    if (hasSelection) {
                        // é¸æŠç¯„å›²ãŒã‚ã‚‹å ´åˆã¯ã€é¸æŠç¯„å›²ã®çµ‚äº†ä½ç½®ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’ç§»å‹•ã—ã¦é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢
                        this.clearSelection();
                    } else {
                        this.moveRight();
                    }
                    break;
                case "ArrowUp":
                    if (hasSelection) {
                        // é¸æŠç¯„å›²ãŒã‚ã‚‹å ´åˆã¯ã€é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰ç§»å‹•
                        this.clearSelection();
                    }
                    this.moveUp();
                    break;
                case "ArrowDown":
                    if (hasSelection) {
                        // é¸æŠç¯„å›²ãŒã‚ã‚‹å ´åˆã¯ã€é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰ç§»å‹•
                        this.clearSelection();
                    }
                    this.moveDown();
                    break;
                case "Home":
                    if (hasSelection) {
                        // é¸æŠç¯„å›²ãŒã‚ã‚‹å ´åˆã¯ã€é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰ç§»å‹•
                        this.clearSelection();
                    }
                    this.moveToLineStart();
                    break;
                case "End":
                    if (hasSelection) {
                        // é¸æŠç¯„å›²ãŒã‚ã‚‹å ´åˆã¯ã€é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰ç§»å‹•
                        this.clearSelection();
                    }
                    this.moveToLineEnd();
                    break;
                case "Backspace":
                    // é¸æŠç¯„å›²ãŒã‚ã‚‹å ´åˆã¯ã€é¸æŠç¯„å›²ã‚’å‰Šé™¤
                    if (hasSelection) {
                        const selection = Object.values(store.selections).find(s => s.userId === this.userId);
                        if (selection) {
                            // è¤‡æ•°ã‚¢ã‚¤ãƒ†ãƒ ã«ã¾ãŸãŒã‚‹é¸æŠç¯„å›²ã®å ´åˆ
                            if (selection.startItemId !== selection.endItemId) {
                                this.deleteMultiItemSelection(selection);
                            } else {
                                // å˜ä¸€ã‚¢ã‚¤ãƒ†ãƒ å†…ã®é¸æŠç¯„å›²ã®å ´åˆ
                                this.deleteSelection();
                            }
                        }
                    } else {
                        // é€šå¸¸ã®Backspaceå‡¦ç†
                        this.deleteBackward();
                    }
                    break;
                case "Delete":
                    // é¸æŠç¯„å›²ãŒã‚ã‚‹å ´åˆã¯ã€é¸æŠç¯„å›²ã‚’å‰Šé™¤
                    if (hasSelection) {
                        const selection = Object.values(store.selections).find(s => s.userId === this.userId);
                        if (selection) {
                            // è¤‡æ•°ã‚¢ã‚¤ãƒ†ãƒ ã«ã¾ãŸãŒã‚‹é¸æŠç¯„å›²ã®å ´åˆ
                            if (selection.startItemId !== selection.endItemId) {
                                this.deleteMultiItemSelection(selection);
                            } else {
                                // å˜ä¸€ã‚¢ã‚¤ãƒ†ãƒ å†…ã®é¸æŠç¯„å›²ã®å ´åˆ
                                this.deleteSelection();
                            }
                        }
                    } else {
                        // é€šå¸¸ã®Deleteå‡¦ç†
                        this.deleteForward();
                    }
                    break;
                case "Enter":
                    // é¸æŠç¯„å›²ãŒã‚ã‚‹å ´åˆã¯ã€é¸æŠç¯„å›²ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰æ”¹è¡Œã‚’æŒ¿å…¥
                    if (hasSelection) {
                        const selection = Object.values(store.selections).find(s => s.userId === this.userId);
                        if (selection) {
                            // è¤‡æ•°ã‚¢ã‚¤ãƒ†ãƒ ã«ã¾ãŸãŒã‚‹é¸æŠç¯„å›²ã®å ´åˆ
                            if (selection.startItemId !== selection.endItemId) {
                                this.deleteMultiItemSelection(selection);
                            } else {
                                // å˜ä¸€ã‚¢ã‚¤ãƒ†ãƒ å†…ã®é¸æŠç¯„å›²ã®å ´åˆ
                                this.deleteSelection();
                            }
                        }
                    }
                    this.insertLineBreak();
                    break;
                case "Escape":
                    this.clearSelection();
                    break;
                default:
                    return false;
            }
        }

        // ã‚«ãƒ¼ã‚½ãƒ«ç‚¹æ»…ã‚’é–‹å§‹
        store.startCursorBlink();
        return true;
    }

    // é¸æŠç¯„å›²ã‚’å·¦ã«æ‹¡å¼µ
    extendSelectionLeft() {
        const target = this.findTarget();
        if (!target) return;

        // ç¾åœ¨ã®é¸æŠç¯„å›²ã‚’å–å¾—
        const existingSelection = Object.values(store.selections).find(s =>
            (s.startItemId === this.itemId || s.endItemId === this.itemId)
            && s.userId === this.userId
        );

        let startItemId, startOffset, endItemId, endOffset, isReversed;

        if (existingSelection) {
            // æ—¢å­˜ã®é¸æŠç¯„å›²ãŒã‚ã‚‹å ´åˆã¯æ‹¡å¼µ
            if (existingSelection.isReversed) {
                // é€†æ–¹å‘ã®é¸æŠç¯„å›²ã®å ´åˆã€é–‹å§‹ä½ç½®ã‚’ç§»å‹•
                startItemId = existingSelection.startItemId;
                startOffset = existingSelection.startOffset;

                // ã‚«ãƒ¼ã‚½ãƒ«ã‚’å·¦ã«ç§»å‹•
                const oldItemId = this.itemId;
                const oldOffset = this.offset;
                this.moveLeft();

                endItemId = this.itemId;
                endOffset = this.offset;
                isReversed = true;

                // é¸æŠç¯„å›²ãŒæ¶ˆæ»…ã—ãŸå ´åˆã¯æ–¹å‘ã‚’åè»¢
                if (startItemId === endItemId && startOffset === endOffset) {
                    this.itemId = oldItemId;
                    this.offset = oldOffset;
                    this.moveLeft();

                    startItemId = oldItemId;
                    startOffset = oldOffset;
                    endItemId = this.itemId;
                    endOffset = this.offset;
                    isReversed = true;
                }
            } else {
                // æ­£æ–¹å‘ã®é¸æŠç¯„å›²ã®å ´åˆã€çµ‚äº†ä½ç½®ã‚’ç§»å‹•
                endItemId = existingSelection.endItemId;
                endOffset = existingSelection.endOffset;

                // ã‚«ãƒ¼ã‚½ãƒ«ã‚’å·¦ã«ç§»å‹•
                this.moveLeft();

                startItemId = this.itemId;
                startOffset = this.offset;
                isReversed = false;

                // é¸æŠç¯„å›²ãŒæ¶ˆæ»…ã—ãŸå ´åˆã¯æ–¹å‘ã‚’åè»¢
                if (startItemId === endItemId && startOffset === endOffset) {
                    isReversed = true;
                    const temp = startItemId;
                    startItemId = endItemId;
                    endItemId = temp;

                    const tempOffset = startOffset;
                    startOffset = endOffset;
                    endOffset = tempOffset;
                }
            }
        } else {
            // æ–°è¦é¸æŠç¯„å›²ã®ä½œæˆ
            startItemId = this.itemId;
            startOffset = this.offset;

            // ã‚«ãƒ¼ã‚½ãƒ«ã‚’å·¦ã«ç§»å‹•
            this.moveLeft();

            endItemId = this.itemId;
            endOffset = this.offset;
            isReversed = true;
        }

        // æ—¢å­˜ã®åŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰æ–°ã—ã„ç¯„å›²ã‚’è¨­å®š
        store.clearSelectionForUser(this.userId);
        store.setSelection({
            startItemId,
            startOffset,
            endItemId,
            endOffset,
            userId: this.userId,
            isReversed,
        });

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®é¸æŠç¯„å›²ã‚’è¨­å®š
        this.updateGlobalTextareaSelection(startItemId, startOffset, endItemId, endOffset);
    }

    // é¸æŠç¯„å›²ã‚’å³ã«æ‹¡å¼µ
    extendSelectionRight() {
        const target = this.findTarget();
        if (!target) return;

        // ç¾åœ¨ã®é¸æŠç¯„å›²ã‚’å–å¾—
        const existingSelection = Object.values(store.selections).find(s =>
            (s.startItemId === this.itemId || s.endItemId === this.itemId)
            && s.userId === this.userId
        );

        let startItemId, startOffset, endItemId, endOffset, isReversed;

        if (existingSelection) {
            // æ—¢å­˜ã®é¸æŠç¯„å›²ãŒã‚ã‚‹å ´åˆã¯æ‹¡å¼µ
            if (!existingSelection.isReversed) {
                // æ­£æ–¹å‘ã®é¸æŠç¯„å›²ã®å ´åˆã€çµ‚äº†ä½ç½®ã‚’ç§»å‹•
                startItemId = existingSelection.startItemId;
                startOffset = existingSelection.startOffset;

                // ã‚«ãƒ¼ã‚½ãƒ«ã‚’å³ã«ç§»å‹•
                const oldItemId = this.itemId;
                const oldOffset = this.offset;
                this.moveRight();

                endItemId = this.itemId;
                endOffset = this.offset;
                isReversed = false;

                // é¸æŠç¯„å›²ãŒæ¶ˆæ»…ã—ãŸå ´åˆã¯æ–¹å‘ã‚’åè»¢
                if (startItemId === endItemId && startOffset === endOffset) {
                    this.itemId = oldItemId;
                    this.offset = oldOffset;
                    this.moveRight();

                    startItemId = oldItemId;
                    startOffset = oldOffset;
                    endItemId = this.itemId;
                    endOffset = this.offset;
                    isReversed = false;
                }
            } else {
                // é€†æ–¹å‘ã®é¸æŠç¯„å›²ã®å ´åˆã€é–‹å§‹ä½ç½®ã‚’ç§»å‹•
                endItemId = existingSelection.endItemId;
                endOffset = existingSelection.endOffset;

                // ã‚«ãƒ¼ã‚½ãƒ«ã‚’å³ã«ç§»å‹•
                this.moveRight();

                startItemId = this.itemId;
                startOffset = this.offset;
                isReversed = true;

                // é¸æŠç¯„å›²ãŒæ¶ˆæ»…ã—ãŸå ´åˆã¯æ–¹å‘ã‚’åè»¢
                if (startItemId === endItemId && startOffset === endOffset) {
                    isReversed = false;
                    const temp = startItemId;
                    startItemId = endItemId;
                    endItemId = temp;

                    const tempOffset = startOffset;
                    startOffset = endOffset;
                    endOffset = tempOffset;
                }
            }
        } else {
            // æ–°è¦é¸æŠç¯„å›²ã®ä½œæˆ
            startItemId = this.itemId;
            startOffset = this.offset;

            // ã‚«ãƒ¼ã‚½ãƒ«ã‚’å³ã«ç§»å‹•
            this.moveRight();

            endItemId = this.itemId;
            endOffset = this.offset;
            isReversed = false;
        }

        // é¸æŠç¯„å›²ã‚’è¨­å®š
        store.setSelection({
            startItemId,
            startOffset,
            endItemId,
            endOffset,
            userId: this.userId,
            isReversed,
        });

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®é¸æŠç¯„å›²ã‚’è¨­å®š
        this.updateGlobalTextareaSelection(startItemId, startOffset, endItemId, endOffset);
    }

    // é¸æŠç¯„å›²ã‚’ä¸Šã«æ‹¡å¼µ
    extendSelectionUp() {
        const target = this.findTarget();
        if (!target) return;

        // ç¾åœ¨ã®é¸æŠç¯„å›²ã‚’å–å¾—
        const existingSelection = Object.values(store.selections).find(s =>
            (s.startItemId === this.itemId || s.endItemId === this.itemId)
            && s.userId === this.userId
        );

        let startItemId, startOffset, endItemId, endOffset, isReversed;

        if (existingSelection) {
            // æ—¢å­˜ã®é¸æŠç¯„å›²ãŒã‚ã‚‹å ´åˆã¯æ‹¡å¼µ
            if (existingSelection.isReversed) {
                // é€†æ–¹å‘ã®é¸æŠç¯„å›²ã®å ´åˆã€é–‹å§‹ä½ç½®ã‚’ç§»å‹•
                startItemId = existingSelection.startItemId;
                startOffset = existingSelection.startOffset;

                // ã‚«ãƒ¼ã‚½ãƒ«ã‚’ä¸Šã«ç§»å‹•
                const oldItemId = this.itemId;
                const oldOffset = this.offset;
                this.moveUp();

                endItemId = this.itemId;
                endOffset = this.offset;
                isReversed = true;

                // é¸æŠç¯„å›²ãŒæ¶ˆæ»…ã—ãŸå ´åˆã¯æ–¹å‘ã‚’åè»¢
                if (startItemId === endItemId && startOffset === endOffset) {
                    this.itemId = oldItemId;
                    this.offset = oldOffset;
                    this.moveUp();

                    startItemId = this.itemId;
                    startOffset = this.offset;
                    endItemId = oldItemId;
                    endOffset = oldOffset;
                    isReversed = false;
                }
            } else {
                // æ­£æ–¹å‘ã®é¸æŠç¯„å›²ã®å ´åˆã€çµ‚äº†ä½ç½®ã‚’ç§»å‹•
                endItemId = existingSelection.endItemId;
                endOffset = existingSelection.endOffset;

                // ã‚«ãƒ¼ã‚½ãƒ«ã‚’ä¸Šã«ç§»å‹•
                const oldItemId = this.itemId;
                const oldOffset = this.offset;
                this.moveUp();

                startItemId = this.itemId;
                startOffset = this.offset;
                isReversed = false;

                // é¸æŠç¯„å›²ãŒæ¶ˆæ»…ã—ãŸå ´åˆã¯æ–¹å‘ã‚’åè»¢
                if (startItemId === endItemId && startOffset === endOffset) {
                    this.itemId = oldItemId;
                    this.offset = oldOffset;
                    this.moveUp();

                    endItemId = oldItemId;
                    endOffset = oldOffset;
                    startItemId = this.itemId;
                    startOffset = this.offset;
                    isReversed = true;
                }
            }
        } else {
            // æ–°è¦é¸æŠç¯„å›²ã®ä½œæˆ
            startItemId = this.itemId;
            startOffset = this.offset;

            // ã‚«ãƒ¼ã‚½ãƒ«ã‚’ä¸Šã«ç§»å‹•
            this.moveUp();

            endItemId = this.itemId;
            endOffset = this.offset;
            isReversed = true;
        }

        // é¸æŠç¯„å›²ã‚’è¨­å®š
        store.setSelection({
            startItemId,
            startOffset,
            endItemId,
            endOffset,
            userId: this.userId,
            isReversed,
        });

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®é¸æŠç¯„å›²ã‚’è¨­å®š
        this.updateGlobalTextareaSelection(startItemId, startOffset, endItemId, endOffset);
    }

    // é¸æŠç¯„å›²ã‚’ä¸‹ã«æ‹¡å¼µ
    extendSelectionDown() {
        const target = this.findTarget();
        if (!target) return;

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
            console.log(`extendSelectionDown called for itemId=${this.itemId}, offset=${this.offset}`);
        }

        // ç¾åœ¨ã®é¸æŠç¯„å›²ã‚’å–å¾—
        const existingSelection = Object.values(store.selections).find(s =>
            (s.startItemId === this.itemId || s.endItemId === this.itemId)
            && s.userId === this.userId
        );

        let startItemId, startOffset, endItemId, endOffset, isReversed;

        if (existingSelection) {
            // æ—¢å­˜ã®é¸æŠç¯„å›²ãŒã‚ã‚‹å ´åˆã¯æ‹¡å¼µ
            if (!existingSelection.isReversed) {
                // æ­£æ–¹å‘ã®é¸æŠç¯„å›²ã®å ´åˆã€çµ‚äº†ä½ç½®ã‚’ç§»å‹•
                startItemId = existingSelection.startItemId;
                startOffset = existingSelection.startOffset;

                // ã‚«ãƒ¼ã‚½ãƒ«ã‚’ä¸‹ã«ç§»å‹•
                const oldItemId = this.itemId;
                const oldOffset = this.offset;
                this.moveDown();

                endItemId = this.itemId;
                endOffset = this.offset;
                isReversed = false;

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                    console.log(
                        `Extending forward selection: startItemId=${startItemId}, startOffset=${startOffset}, endItemId=${endItemId}, endOffset=${endOffset}`,
                    );
                }

                // é¸æŠç¯„å›²ãŒæ¶ˆæ»…ã—ãŸå ´åˆã¯æ–¹å‘ã‚’åè»¢
                if (startItemId === endItemId && startOffset === endOffset) {
                    this.itemId = oldItemId;
                    this.offset = oldOffset;
                    this.moveDown();

                    startItemId = oldItemId;
                    startOffset = oldOffset;
                    endItemId = this.itemId;
                    endOffset = this.offset;
                    isReversed = false;

                    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                    if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                        console.log(
                            `Selection disappeared, reversed: startItemId=${startItemId}, startOffset=${startOffset}, endItemId=${endItemId}, endOffset=${endOffset}`,
                        );
                    }
                }
            } else {
                // é€†æ–¹å‘ã®é¸æŠç¯„å›²ã®å ´åˆã€é–‹å§‹ä½ç½®ã‚’ç§»å‹•
                endItemId = existingSelection.endItemId;
                endOffset = existingSelection.endOffset;

                // ã‚«ãƒ¼ã‚½ãƒ«ã‚’ä¸‹ã«ç§»å‹•
                const oldItemId = this.itemId;
                const oldOffset = this.offset;
                this.moveDown();

                startItemId = this.itemId;
                startOffset = this.offset;
                isReversed = true;

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                    console.log(
                        `Extending reversed selection: startItemId=${startItemId}, startOffset=${startOffset}, endItemId=${endItemId}, endOffset=${endOffset}`,
                    );
                }

                // é¸æŠç¯„å›²ãŒæ¶ˆæ»…ã—ãŸå ´åˆã¯æ–¹å‘ã‚’åè»¢
                if (startItemId === endItemId && startOffset === endOffset) {
                    this.itemId = oldItemId;
                    this.offset = oldOffset;
                    this.moveDown();

                    endItemId = oldItemId;
                    endOffset = oldOffset;
                    startItemId = this.itemId;
                    startOffset = this.offset;
                    isReversed = false;

                    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                    if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                        console.log(
                            `Selection disappeared, reversed: startItemId=${startItemId}, startOffset=${startOffset}, endItemId=${endItemId}, endOffset=${endOffset}`,
                        );
                    }
                }
            }
        } else {
            // æ–°è¦é¸æŠç¯„å›²ã®ä½œæˆ
            startItemId = this.itemId;
            startOffset = this.offset;

            // ç¾åœ¨ä½ç½®ã‚’ä¿å­˜
            const oldItemId = this.itemId;
            const oldOffset = this.offset;

            // ã‚«ãƒ¼ã‚½ãƒ«ã‚’ä¸‹ã«ç§»å‹•
            this.moveDown();

            // ç§»å‹•å…ˆãŒåŒã˜ã‚¢ã‚¤ãƒ†ãƒ å†…ã®å ´åˆã¯ã€å…¨ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠ
            if (this.itemId === oldItemId) {
                const text = target.text || "";
                endItemId = this.itemId;
                endOffset = this.offset;
                isReversed = false;

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                    console.log(
                        `New selection within same item: startItemId=${startItemId}, startOffset=${startOffset}, endItemId=${endItemId}, endOffset=${endOffset}`,
                    );
                }
            } else {
                // åˆ¥ã®ã‚¢ã‚¤ãƒ†ãƒ ã«ç§»å‹•ã—ãŸå ´åˆ
                endItemId = this.itemId;
                endOffset = this.offset; // æ¬¡ã®ã‚¢ã‚¤ãƒ†ãƒ ã®ç¾åœ¨ä½ç½®ã¾ã§é¸æŠï¼ˆä»¥å‰ã¯0å›ºå®šã ã£ãŸï¼‰
                isReversed = false;

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                    console.log(
                        `New selection across items: startItemId=${startItemId}, startOffset=${startOffset}, endItemId=${endItemId}, endOffset=${endOffset}`,
                    );
                }
            }
        }

        // é¸æŠç¯„å›²ã®æ–¹å‘ã‚’é©åˆ‡ã«è¨­å®šï¼ˆãƒ†ã‚¹ãƒˆç”¨ã®å¼·åˆ¶è¨­å®šã‚’å‰Šé™¤ï¼‰
        // é–‹å§‹ã¨çµ‚äº†ãŒåŒã˜ã‚¢ã‚¤ãƒ†ãƒ ã®å ´åˆã€ã‚ªãƒ•ã‚»ãƒƒãƒˆã§æ–¹å‘ã‚’æ±ºå®š
        if (startItemId === endItemId) {
            isReversed = startOffset > endOffset;
        } // ç•°ãªã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã®å ´åˆã€DOMä¸Šã®é †åºã§æ–¹å‘ã‚’æ±ºå®š
        else {
            const allItems = Array.from(document.querySelectorAll("[data-item-id]")) as HTMLElement[];
            const allItemIds = allItems.map(el => el.getAttribute("data-item-id")!);
            const startIdx = allItemIds.indexOf(startItemId);
            const endIdx = allItemIds.indexOf(endItemId);

            // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æ­£æ–¹å‘
            if (startIdx === -1 || endIdx === -1) {
                isReversed = false;
            } else {
                isReversed = startIdx > endIdx;
            }
        }

        // æ—¢å­˜ã®åŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰æ–°ã—ã„ç¯„å›²ã‚’è¨­å®š
        store.clearSelectionForUser(this.userId);
        const selectionId = store.setSelection({
            startItemId,
            startOffset,
            endItemId,
            endOffset,
            userId: this.userId,
            isReversed,
        });

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
            console.log(`Selection created with ID: ${selectionId}, isReversed=${isReversed}`);
            console.log(`Current selections:`, store.selections);
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®é¸æŠç¯„å›²ã‚’è¨­å®š
        this.updateGlobalTextareaSelection(startItemId, startOffset, endItemId, endOffset);

        // é¸æŠç¯„å›²ãŒæ­£ã—ãä½œæˆã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã€DOMã«åæ˜ ã•ã‚Œã‚‹ã¾ã§å°‘ã—å¾…ã¤
        if (typeof window !== "undefined") {
            setTimeout(() => {
                const selectionElements = document.querySelectorAll(".editor-overlay .selection");
                if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                    console.log(`Selection elements in DOM: ${selectionElements.length}`);
                }

                // é¸æŠç¯„å›²ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€å†åº¦é¸æŠç¯„å›²ã‚’è¨­å®š
                if (selectionElements.length === 0) {
                    store.setSelection({
                        startItemId,
                        startOffset,
                        endItemId,
                        endOffset,
                        userId: this.userId,
                        isReversed,
                    });

                    // é¸æŠç¯„å›²ã®è¡¨ç¤ºã‚’å¼·åˆ¶çš„ã«æ›´æ–°
                    store.forceUpdate();
                }
            }, 150); // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’150msã«å¢—ã‚„ã—ã¦ã€DOMã®æ›´æ–°ã‚’å¾…ã¤æ™‚é–“ã‚’é•·ãã™ã‚‹
        }
    }

    // ã‚«ãƒ¼ã‚½ãƒ«ã‚’è¡Œã®å…ˆé ­ã«ç§»å‹•
    moveToLineStart() {
        const target = this.findTarget();
        if (!target) return;

        const text = target.text || "";
        const currentLineIndex = this.getCurrentLineIndex(text, this.offset);

        // ç¾åœ¨ã®è¡Œã®é–‹å§‹ä½ç½®ã«ç§»å‹•
        this.offset = this.getLineStartOffset(text, currentLineIndex);
        this.applyToStore();

        // ã‚«ãƒ¼ã‚½ãƒ«ãŒæ­£ã—ãæ›´æ–°ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
        store.startCursorBlink();
    }

    // ã‚«ãƒ¼ã‚½ãƒ«ã‚’è¡Œã®æœ«å°¾ã«ç§»å‹•
    moveToLineEnd() {
        const target = this.findTarget();
        if (!target) return;

        const text = target.text || "";
        const currentLineIndex = this.getCurrentLineIndex(text, this.offset);

        // ç¾åœ¨ã®è¡Œã®çµ‚äº†ä½ç½®ã«ç§»å‹•
        this.offset = this.getLineEndOffset(text, currentLineIndex);
        this.applyToStore();

        // ã‚«ãƒ¼ã‚½ãƒ«ãŒæ­£ã—ãæ›´æ–°ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
        store.startCursorBlink();
    }

    // é¸æŠç¯„å›²ã‚’è¡Œé ­ã¾ã§æ‹¡å¼µ
    extendSelectionToLineStart() {
        const target = this.findTarget();
        if (!target) return;

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
            console.log(`extendSelectionToLineStart called for itemId=${this.itemId}, offset=${this.offset}`);
        }

        // ç¾åœ¨ã®é¸æŠç¯„å›²ã‚’å–å¾—
        const existingSelection = Object.values(store.selections).find(s =>
            (s.startItemId === this.itemId || s.endItemId === this.itemId)
            && s.userId === this.userId
        );

        let startItemId, startOffset, endItemId, endOffset, isReversed;
        const text = target.text || "";
        const currentLineIndex = this.getCurrentLineIndex(text, this.offset);
        const lineStartOffset = this.getLineStartOffset(text, currentLineIndex);

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
            console.log(
                `Current line index: ${currentLineIndex}, lineStartOffset: ${lineStartOffset}, text: "${text}"`,
            );
        }

        // ç¾åœ¨ã®ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ãŒæ—¢ã«è¡Œé ­ã«ã‚ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
        if (this.offset === lineStartOffset && !existingSelection) {
            if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                console.log(`Already at line start, no selection created`);
            }
            return;
        }

        if (existingSelection) {
            // æ—¢å­˜ã®é¸æŠç¯„å›²ãŒã‚ã‚‹å ´åˆã¯æ‹¡å¼µ
            if (existingSelection.isReversed) {
                // é€†æ–¹å‘ã®é¸æŠç¯„å›²ã®å ´åˆã€é–‹å§‹ä½ç½®ã‚’ç§»å‹•
                startItemId = existingSelection.startItemId;
                startOffset = existingSelection.startOffset;

                // ã‚«ãƒ¼ã‚½ãƒ«ã‚’è¡Œé ­ã«ç§»å‹•
                endItemId = this.itemId;
                endOffset = lineStartOffset;
                isReversed = true;
            } else {
                // æ­£æ–¹å‘ã®é¸æŠç¯„å›²ã®å ´åˆã€çµ‚äº†ä½ç½®ã‚’ç§»å‹•
                endItemId = existingSelection.endItemId;
                endOffset = existingSelection.endOffset;

                // ã‚«ãƒ¼ã‚½ãƒ«ã‚’è¡Œé ­ã«ç§»å‹•
                startItemId = this.itemId;
                startOffset = lineStartOffset;
                isReversed = false;
            }
        } else {
            // æ–°è¦é¸æŠç¯„å›²ã®ä½œæˆ
            // ç¾åœ¨ä½ç½®ã‹ã‚‰è¡Œé ­ã¾ã§ã‚’é¸æŠ
            startItemId = this.itemId;
            endItemId = this.itemId;

            // ç¾åœ¨ä½ç½®ã¨è¡Œé ­ã®ä½ç½®é–¢ä¿‚ã«åŸºã¥ã„ã¦æ–¹å‘ã‚’æ±ºå®š
            if (this.offset > lineStartOffset) {
                // é€šå¸¸ã®å ´åˆï¼ˆã‚«ãƒ¼ã‚½ãƒ«ãŒè¡Œã®é€”ä¸­ã«ã‚ã‚‹ï¼‰
                startOffset = this.offset;
                endOffset = lineStartOffset;
                isReversed = true; // è¡Œé ­ã«å‘ã‹ã£ã¦é¸æŠã™ã‚‹ã®ã§é€†æ–¹å‘
            } else {
                // ã‚«ãƒ¼ã‚½ãƒ«ãŒè¡Œé ­ã«ã‚ã‚‹å ´åˆï¼ˆé€šå¸¸ã¯ã“ã“ã«å…¥ã‚‰ãªã„ï¼‰
                startOffset = lineStartOffset;
                endOffset = this.offset;
                isReversed = false;
            }
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
            console.log(
                `Setting selection: startItemId=${startItemId}, startOffset=${startOffset}, endItemId=${endItemId}, endOffset=${endOffset}, isReversed=${isReversed}`,
            );
        }

        // é¸æŠç¯„å›²ã‚’è¨­å®š
        store.setSelection({
            startItemId,
            startOffset,
            endItemId,
            endOffset,
            userId: this.userId,
            isReversed,
        });

        // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’è¡Œé ­ã«ç§»å‹•
        this.offset = lineStartOffset;
        this.applyToStore();

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®é¸æŠç¯„å›²ã‚’è¨­å®š
        this.updateGlobalTextareaSelection(startItemId, startOffset, endItemId, endOffset);
    }

    // é¸æŠç¯„å›²ã‚’è¡Œæœ«ã¾ã§æ‹¡å¼µ
    extendSelectionToLineEnd() {
        const target = this.findTarget();
        if (!target) return;

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
            console.log(`extendSelectionToLineEnd called for itemId=${this.itemId}, offset=${this.offset}`);
        }

        // ç¾åœ¨ã®é¸æŠç¯„å›²ã‚’å–å¾—
        const existingSelection = Object.values(store.selections).find(s =>
            (s.startItemId === this.itemId || s.endItemId === this.itemId)
            && s.userId === this.userId
        );

        let startItemId, startOffset, endItemId, endOffset, isReversed;
        const text = target.text || "";
        const currentLineIndex = this.getCurrentLineIndex(text, this.offset);
        const lineEndOffset = this.getLineEndOffset(text, currentLineIndex);

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
            console.log(`Current line index: ${currentLineIndex}, lineEndOffset: ${lineEndOffset}, text: "${text}"`);
        }

        // ç¾åœ¨ã®ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ãŒæ—¢ã«è¡Œæœ«ã«ã‚ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
        if (this.offset === lineEndOffset && !existingSelection) {
            if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                console.log(`Already at line end, no selection created`);
            }
            return;
        }

        if (existingSelection) {
            // æ—¢å­˜ã®é¸æŠç¯„å›²ãŒã‚ã‚‹å ´åˆã¯æ‹¡å¼µ
            if (!existingSelection.isReversed) {
                // æ­£æ–¹å‘ã®é¸æŠç¯„å›²ã®å ´åˆã€çµ‚äº†ä½ç½®ã‚’ç§»å‹•
                startItemId = existingSelection.startItemId;
                startOffset = existingSelection.startOffset;

                // ã‚«ãƒ¼ã‚½ãƒ«ã‚’è¡Œæœ«ã«ç§»å‹•
                endItemId = this.itemId;
                endOffset = lineEndOffset;
                isReversed = false;
            } else {
                // é€†æ–¹å‘ã®é¸æŠç¯„å›²ã®å ´åˆã€é–‹å§‹ä½ç½®ã‚’ç§»å‹•
                endItemId = existingSelection.endItemId;
                endOffset = existingSelection.endOffset;

                // ã‚«ãƒ¼ã‚½ãƒ«ã‚’è¡Œæœ«ã«ç§»å‹•
                startItemId = this.itemId;
                startOffset = lineEndOffset;
                isReversed = true;
            }
        } else {
            // æ–°è¦é¸æŠç¯„å›²ã®ä½œæˆ
            startItemId = this.itemId;
            startOffset = this.offset;

            // è¡Œæœ«ã¾ã§ã‚’é¸æŠ
            endItemId = this.itemId;
            endOffset = lineEndOffset;
            isReversed = this.offset > lineEndOffset;
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
            console.log(
                `Setting selection: startItemId=${startItemId}, startOffset=${startOffset}, endItemId=${endItemId}, endOffset=${endOffset}, isReversed=${isReversed}`,
            );
        }

        // é¸æŠç¯„å›²ã‚’è¨­å®š
        const selectionId = store.setSelection({
            startItemId,
            startOffset,
            endItemId,
            endOffset,
            userId: this.userId,
            isReversed,
        });

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
            console.log(`Selection created with ID: ${selectionId}`);
            console.log(`Current selections:`, store.selections);
        }

        // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’è¡Œæœ«ã«ç§»å‹•
        this.offset = lineEndOffset;
        this.applyToStore();

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®é¸æŠç¯„å›²ã‚’è¨­å®š
        this.updateGlobalTextareaSelection(startItemId, startOffset, endItemId, endOffset);

        // é¸æŠç¯„å›²ãŒæ­£ã—ãä½œæˆã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã€DOMã«åæ˜ ã•ã‚Œã‚‹ã¾ã§å°‘ã—å¾…ã¤
        if (typeof window !== "undefined") {
            setTimeout(() => {
                const selectionElements = document.querySelectorAll(".editor-overlay .selection");
                if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                    console.log(`Selection elements in DOM: ${selectionElements.length}`);
                }

                // é¸æŠç¯„å›²ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€å†åº¦é¸æŠç¯„å›²ã‚’è¨­å®š
                if (selectionElements.length === 0) {
                    store.setSelection({
                        startItemId,
                        startOffset,
                        endItemId,
                        endOffset,
                        userId: this.userId,
                        isReversed,
                    });

                    // é¸æŠç¯„å›²ã®è¡¨ç¤ºã‚’å¼·åˆ¶çš„ã«æ›´æ–°
                    store.forceUpdate();
                }
            }, 100); // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’100msã«å¢—ã‚„ã—ã¦ã€DOMã®æ›´æ–°ã‚’å¾…ã¤æ™‚é–“ã‚’é•·ãã™ã‚‹

            // è¿½åŠ ã®ç¢ºèªã¨æ›´æ–°
            setTimeout(() => {
                const selectionElements = document.querySelectorAll(".editor-overlay .selection");
                if (selectionElements.length === 0) {
                    if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                        console.log(`Selection still not visible after 100ms, forcing update again`);
                    }

                    // é¸æŠç¯„å›²ã‚’å†è¨­å®š
                    store.setSelection({
                        startItemId,
                        startOffset,
                        endItemId,
                        endOffset,
                        userId: this.userId,
                        isReversed,
                    });

                    // å¼·åˆ¶çš„ã«æ›´æ–°
                    store.forceUpdate();
                }
            }, 200);
        }
    }

    /**
     * é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
     */
    clearSelection() {
        // é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢
        const selections = Object.values(store.selections).filter(s => s.userId === this.userId);
        if (selections.length > 0) {
            // é¸æŠç¯„å›²ã‚’å‰Šé™¤
            store.selections = Object.fromEntries(
                Object.entries(store.selections).filter(([_, s]) => s.userId !== this.userId),
            );
            // ã‚«ãƒ¼ã‚½ãƒ«ç‚¹æ»…ã‚’é–‹å§‹
            store.startCursorBlink();
        }
    }

    // --- Extended navigation commands ---

    // å˜èªå˜ä½ã§å·¦ã¸ç§»å‹•
    moveWordLeft() {
        const target = this.findTarget();
        if (!target) return;

        const text = target.text || "";
        let pos = this.offset;
        if (pos > 0) {
            pos--;
            while (pos > 0 && /\s/.test(text[pos])) pos--;
            while (pos > 0 && !/\s/.test(text[pos - 1])) pos--;
        }
        this.offset = pos;
        this.applyToStore();
        store.startCursorBlink();
    }

    // å˜èªå˜ä½ã§å³ã¸ç§»å‹•
    moveWordRight() {
        const target = this.findTarget();
        if (!target) return;

        const text = target.text || "";
        let pos = this.offset;
        const len = text.length;
        if (pos < len) {
            while (pos < len && /\s/.test(text[pos])) pos++;
            while (pos < len && !/\s/.test(text[pos])) pos++;
        }
        this.offset = pos;
        this.applyToStore();
        store.startCursorBlink();
    }

    // å¯¾å¿œã™ã‚‹è§’æ‹¬å¼§ã¸ã‚¸ãƒ£ãƒ³ãƒ—
    jumpToMatchingBracket() {
        const target = this.findTarget();
        if (!target) return;
        const text = target.text || "";
        const pos = this.offset;
        const before = text[pos - 1];
        const current = text[pos];

        if (current === "[") {
            const close = text.indexOf("]", pos + 1);
            if (close !== -1) {
                this.offset = close + 1;
            }
        } else if (before === "[") {
            const close = text.indexOf("]", pos);
            if (close !== -1) {
                this.offset = close + 1;
            }
        } else if (current === "]") {
            const open = text.lastIndexOf("[", pos - 1);
            if (open !== -1) {
                this.offset = open;
            }
        } else if (before === "]") {
            const open = text.lastIndexOf("[", pos - 2);
            if (open !== -1) {
                this.offset = open;
            }
        }

        this.applyToStore();
        store.startCursorBlink();
    }

    // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå…ˆé ­ã«ç§»å‹•
    moveToDocumentStart() {
        const root = generalStore.currentPage;
        if (!root) return;
        let item: Item = root;
        while (item.items && (item.items as Iterable<Item>)[Symbol.iterator]) {
            const iter = (item.items as Iterable<Item>)[Symbol.iterator]();
            const first = iter.next();
            if (first.done) break;
            item = first.value;
        }
        this.itemId = item.id;
        this.offset = 0;
        this.applyToStore();
        store.startCursorBlink();
    }

    // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæœ«å°¾ã«ç§»å‹•
    moveToDocumentEnd() {
        const root = generalStore.currentPage;
        if (!root) return;
        let item: Item = root;
        while (item.items && (item.items as Iterable<Item>)[Symbol.iterator]) {
            let last: Item | undefined;
            for (const child of item.items as Iterable<Item>) {
                last = child;
            }
            if (!last) break;
            item = last;
        }
        this.itemId = item.id;
        this.offset = (item.text || "").length;
        this.applyToStore();
        store.startCursorBlink();
    }

    // PageUp/PageDown ç›¸å½“ã®ç§»å‹•ï¼ˆ10è¡Œå˜ä½ï¼‰
    pageUp() {
        for (let i = 0; i < 10; i++) this.moveUp();
    }

    pageDown() {
        for (let i = 0; i < 10; i++) this.moveDown();
    }

    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ“ä½œ
    scrollUp() {
        if (typeof window !== "undefined") window.scrollBy(0, -100);
    }

    scrollDown() {
        if (typeof window !== "undefined") window.scrollBy(0, 100);
    }

    altPageUp() {
        if (typeof window !== "undefined") window.scrollBy(0, -window.innerHeight);
    }

    altPageDown() {
        if (typeof window !== "undefined") window.scrollBy(0, window.innerHeight);
    }

    // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã¯ä¸‹éƒ¨ã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™

    /**
     * ç¾åœ¨ã®ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¨é¸æŠã™ã‚‹
     */
    selectAll() {
        const target = this.findTarget();
        if (!target) return;

        const text = target.text || "";

        // é¸æŠç¯„å›²ã‚’è¨­å®š
        store.setSelection({
            startItemId: this.itemId,
            startOffset: 0,
            endItemId: this.itemId,
            endOffset: text.length,
            userId: this.userId,
            isReversed: false,
        });

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®é¸æŠç¯„å›²ã‚’è¨­å®š
        this.updateGlobalTextareaSelection(this.itemId, 0, this.itemId, text.length);

        // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’æœ«å°¾ã«è¨­å®š
        this.offset = text.length;
        this.applyToStore();

        // ã‚«ãƒ¼ã‚½ãƒ«ç‚¹æ»…ã‚’é–‹å§‹
        store.startCursorBlink();
    }

    // Shift+Alt+Right ã§é¸æŠç¯„å›²ã‚’æ‹¡å¼µ
    expandSelection() {
        const target = this.findTarget();
        if (!target) return;

        const text = target.text || "";
        const selection = Object.values(store.selections).find(s => s.userId === this.userId);

        const startOffset = selection ? Math.min(selection.startOffset, selection.endOffset) : this.offset;

        store.setSelection({
            startItemId: this.itemId,
            startOffset,
            endItemId: this.itemId,
            endOffset: text.length,
            userId: this.userId,
            isReversed: false,
        });

        this.updateGlobalTextareaSelection(this.itemId, startOffset, this.itemId, text.length);

        this.offset = text.length;
        this.applyToStore();
        store.startCursorBlink();
    }

    // Shift+Alt+Left ã§é¸æŠç¯„å›²ã‚’ç¸®å°
    shrinkSelection() {
        const selection = Object.values(store.selections).find(s => s.userId === this.userId);
        if (!selection) return;

        const newOffset = Math.min(selection.startOffset, selection.endOffset);
        this.offset = newOffset;
        this.applyToStore();
        this.clearSelection();
        this.updateGlobalTextareaSelection(this.itemId, newOffset, this.itemId, newOffset);
        store.startCursorBlink();
    }

    // Ctrl+L ã§ç¾åœ¨è¡Œã‚’é¸æŠ
    selectLine() {
        const target = this.findTarget();
        if (!target) return;

        const text = target.text || "";
        const currentLineIndex = this.getCurrentLineIndex(text, this.offset);
        const startOffset = this.getLineStartOffset(text, currentLineIndex);
        const endOffset = this.getLineEndOffset(text, currentLineIndex);

        store.setSelection({
            startItemId: this.itemId,
            startOffset,
            endItemId: this.itemId,
            endOffset,
            userId: this.userId,
            isReversed: false,
        });

        this.updateGlobalTextareaSelection(this.itemId, startOffset, this.itemId, endOffset);

        this.offset = endOffset;
        this.applyToStore();
        store.startCursorBlink();
    }

    /**
     * é¸æŠã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
     */
    copySelectedText() {
        const selection = Object.values(store.selections).find(s => s.userId === this.userId);
        if (!selection) return;

        // åŒä¸€ã‚¢ã‚¤ãƒ†ãƒ å†…ã®é¸æŠç¯„å›²ã®å ´åˆ
        if (selection.startItemId === selection.endItemId) {
            const target = this.findTarget();
            if (!target) return;

            const text = target.text || "";
            const startOffset = Math.min(selection.startOffset, selection.endOffset);
            const endOffset = Math.max(selection.startOffset, selection.endOffset);

            // é¸æŠç¯„å›²ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
            const selectedText = text.substring(startOffset, endOffset);

            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã«ä»»ã›ã‚‹ï¼‰
            // å®Ÿéš›ã®ã‚³ãƒ”ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ãŒè¡Œã†ã®ã§ã€ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„
            return;
        }

        // è¤‡æ•°ã‚¢ã‚¤ãƒ†ãƒ ã«ã¾ãŸãŒã‚‹é¸æŠç¯„å›²ã®å ´åˆ
        // å®Ÿéš›ã®ã‚³ãƒ”ãƒ¼ã¯EditorOverlay.svelteã®handleCopyã§å‡¦ç†ã•ã‚Œã‚‹ãŸã‚ã€
        // ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„
    }

    /**
     * é¸æŠã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚«ãƒƒãƒˆã™ã‚‹
     */
    cutSelectedText() {
        const selection = Object.values(store.selections).find(s => s.userId === this.userId);
        if (!selection) return;

        // åŒä¸€ã‚¢ã‚¤ãƒ†ãƒ å†…ã®é¸æŠç¯„å›²ã®å ´åˆ
        if (selection.startItemId === selection.endItemId) {
            const target = this.findTarget();
            if (!target) return;

            const text = target.text || "";
            const startOffset = Math.min(selection.startOffset, selection.endOffset);
            const endOffset = Math.max(selection.startOffset, selection.endOffset);

            // é¸æŠç¯„å›²ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
            const selectedText = text.substring(startOffset, endOffset);

            // ãƒ†ã‚­ã‚¹ãƒˆã‚’å‰Šé™¤
            const newText = text.substring(0, startOffset) + text.substring(endOffset);
            target.updateText(newText);

            // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’æ›´æ–°
            this.offset = startOffset;
            this.applyToStore();

            // é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢
            this.clearSelection();

            // ã‚«ãƒ¼ã‚½ãƒ«ç‚¹æ»…ã‚’é–‹å§‹
            store.startCursorBlink();

            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã«ä»»ã›ã‚‹ï¼‰
            // å®Ÿéš›ã®ã‚³ãƒ”ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ãŒè¡Œã†ã®ã§ã€ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„
            return;
        }

        // è¤‡æ•°ã‚¢ã‚¤ãƒ†ãƒ ã«ã¾ãŸãŒã‚‹é¸æŠç¯„å›²ã®å ´åˆ
        this.deleteMultiItemSelection(selection);
    }

    /**
     * è¤‡æ•°ã‚¢ã‚¤ãƒ†ãƒ ã«ã¾ãŸãŒã‚‹é¸æŠç¯„å›²ã‚’å‰Šé™¤ã™ã‚‹
     */
    deleteMultiItemSelection(selection: any) {
        if (!selection) return;

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
            console.log(`deleteMultiItemSelection called for selection:`, selection);
        }

        // é¸æŠç¯„å›²ã®é–‹å§‹ã¨çµ‚äº†ã‚¢ã‚¤ãƒ†ãƒ ãŒåŒã˜å ´åˆã¯å˜ä¸€ã‚¢ã‚¤ãƒ†ãƒ å‰Šé™¤ã‚’ä½¿ç”¨
        if (selection.startItemId === selection.endItemId) {
            this.deleteSelection();
            return;
        }

        // é¸æŠç¯„å›²ã®é–‹å§‹ã¨çµ‚äº†ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—
        const startItem = this.searchItem(generalStore.currentPage!, selection.startItemId);
        const endItem = this.searchItem(generalStore.currentPage!, selection.endItemId);

        if (!startItem || !endItem) {
            if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                console.log(`Start or end item not found: startItem=${startItem}, endItem=${endItem}`);
            }
            return;
        }

        // é¸æŠç¯„å›²ã®æ–¹å‘ã‚’è€ƒæ…®ã—ã¦ã€å®Ÿéš›ã®é–‹å§‹ã¨çµ‚äº†ã‚’æ±ºå®š
        const isReversed = selection.isReversed || false;

        // é¸æŠç¯„å›²ã®æ–¹å‘ã«åŸºã¥ã„ã¦ã€å®Ÿéš›ã®é–‹å§‹ã¨çµ‚äº†ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ±ºå®š
        let firstItem, lastItem, firstOffset, lastOffset;

        // DOMä¸Šã®é †åºã‚’å–å¾—
        const allItems = Array.from(document.querySelectorAll("[data-item-id]")) as HTMLElement[];
        const allItemIds = allItems.map(el => el.getAttribute("data-item-id")!);

        const startIdx = allItemIds.indexOf(selection.startItemId);
        const endIdx = allItemIds.indexOf(selection.endItemId);

        if (startIdx === -1 || endIdx === -1) {
            if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                console.log(`Start or end item not found in DOM: startIdx=${startIdx}, endIdx=${endIdx}`);
            }
            return;
        }

        // DOMä¸Šã®é †åºã«åŸºã¥ã„ã¦ã€æœ€åˆã¨æœ€å¾Œã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ±ºå®š
        if (startIdx <= endIdx) {
            firstItem = startItem;
            lastItem = endItem;
            firstOffset = selection.startOffset;
            lastOffset = selection.endOffset;
        } else {
            firstItem = endItem;
            lastItem = startItem;
            firstOffset = selection.endOffset;
            lastOffset = selection.startOffset;
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
            console.log(`Selection direction: ${isReversed ? "reversed" : "forward"}`);
            console.log(`First item: ${firstItem.id}, offset: ${firstOffset}`);
            console.log(`Last item: ${lastItem.id}, offset: ${lastOffset}`);
        }

        // ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒªã‚¹ãƒˆã‚’å–å¾—
        const root = generalStore.currentPage;
        if (!root) return;

        // ã‚¢ã‚¤ãƒ†ãƒ ã®è¦ªã‚’å–å¾—
        const startParent = Tree.parent(firstItem);
        const endParent = Tree.parent(lastItem);

        // è¦ªãŒç•°ãªã‚‹å ´åˆã¯å‡¦ç†ã‚’ä¸­æ­¢ï¼ˆç¾åœ¨ã¯ã‚µãƒãƒ¼ãƒˆå¤–ï¼‰
        if (startParent !== endParent || !Tree.is(startParent, Items)) {
            if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                console.log(`Parents are different or not Items: startParent=${startParent}, endParent=${endParent}`);
            }
            return;
        }

        const items = startParent as Items;
        const firstIndex = items.indexOf(firstItem);
        const lastIndex = items.indexOf(lastItem);

        if (firstIndex === -1 || lastIndex === -1) {
            if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                console.log(`First or last index not found: firstIndex=${firstIndex}, lastIndex=${lastIndex}`);
            }
            return;
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
            console.log(`First index: ${firstIndex}, Last index: ${lastIndex}`);
        }

        try {
            // é–‹å§‹ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆé¸æŠç¯„å›²ã®å‰åŠéƒ¨åˆ†ã‚’ä¿æŒï¼‰
            const firstText = firstItem.text || "";
            const newFirstText = firstText.substring(0, firstOffset);

            // çµ‚äº†ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆé¸æŠç¯„å›²ã®å¾ŒåŠéƒ¨åˆ†ã‚’ä¿æŒï¼‰
            const lastText = lastItem.text || "";
            const newLastText = lastText.substring(lastOffset);

            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
            if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                console.log(`First text: "${firstText}", New first text: "${newFirstText}"`);
                console.log(`Last text: "${lastText}", New last text: "${newLastText}"`);
                console.log(`Combined text will be: "${newFirstText + newLastText}"`);
            }

            // å‰Šé™¤ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã®IDã‚’ä¿å­˜
            const itemsToRemove = [];
            for (let i = firstIndex + 1; i <= lastIndex; i++) {
                const item = items.at(i);
                if (item) {
                    itemsToRemove.push(item.id);
                }
            }

            if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                console.log(`Items to remove: ${itemsToRemove.join(", ")}`);
            }

            // å‰Šé™¤å‰ã«ã€å‰Šé™¤å¯¾è±¡ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚«ãƒ¼ã‚½ãƒ«ã‚’ã‚¯ãƒªã‚¢
            for (const itemId of itemsToRemove) {
                store.clearCursorForItem(itemId);
            }

            // é–‹å§‹ã‚¢ã‚¤ãƒ†ãƒ ã«çµ‚äº†ã‚¢ã‚¤ãƒ†ãƒ ã®æ®‹ã‚Šã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
            firstItem.updateText(newFirstText + newLastText);

            // å®Ÿéš›ã®å‰Šé™¤å‡¦ç†ï¼ˆçµ‚äº†ã‚¢ã‚¤ãƒ†ãƒ ã‹ã‚‰é–‹å§‹ã‚¢ã‚¤ãƒ†ãƒ ã®æ¬¡ã¾ã§ï¼‰
            // å‰Šé™¤ã¯çµ‚äº†ã‚¢ã‚¤ãƒ†ãƒ ã‹ã‚‰é–‹å§‹ã‚¢ã‚¤ãƒ†ãƒ ã®æ–¹å‘ã«è¡Œã†
            for (let i = lastIndex; i > firstIndex; i--) {
                if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                    console.log(`Removing item at index ${i}`);
                }
                items.removeAt(i);
            }

            // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’æ›´æ–°
            this.itemId = firstItem.id;
            this.offset = firstOffset;
            this.applyToStore();

            // é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢
            this.clearSelection();

            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¨­å®š
            store.setActiveItem(this.itemId);

            // ã‚«ãƒ¼ã‚½ãƒ«ç‚¹æ»…ã‚’é–‹å§‹
            store.startCursorBlink();

            // ã‚«ãƒ¼ã‚½ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
            if (typeof window !== "undefined") {
                setTimeout(() => {
                    const cursorVisible = document.querySelector(".editor-overlay .cursor") !== null;
                    if (!cursorVisible) {
                        // ã‚«ãƒ¼ã‚½ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€å†åº¦ã‚«ãƒ¼ã‚½ãƒ«ã‚’è¨­å®š
                        this.applyToStore();
                        store.startCursorBlink();
                    }
                }, 150); // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’150msã«å¢—ã‚„ã—ã¦ã€DOMã®æ›´æ–°ã‚’å¾…ã¤æ™‚é–“ã‚’é•·ãã™ã‚‹
            }

            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
            if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                console.log(`After deletion: cursor at itemId=${this.itemId}, offset=${this.offset}`);
                console.log(`Remaining items count: ${items.length}`);
                console.log(`Updated first item text: "${firstItem.text}"`);
            }
        } catch (error) {
            // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ãƒ­ã‚°ã«å‡ºåŠ›
            if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                console.error(`Error in deleteMultiItemSelection:`, error);
                // ã‚¨ãƒ©ãƒ¼ã®è©³ç´°æƒ…å ±ã‚’å‡ºåŠ›
                if (error instanceof Error) {
                    console.error(`Error message: ${error.message}`);
                    console.error(`Error stack: ${error.stack}`);
                }
            }

            // é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢
            this.clearSelection();

            // ã‚«ãƒ¼ã‚½ãƒ«ç‚¹æ»…ã‚’é–‹å§‹
            store.startCursorBlink();

            // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã§ã‚‚ã€ã‚«ãƒ¼ã‚½ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹
            this.applyToStore();
        }
    }

    /**
     * é¸æŠç¯„å›²ã‚’å‰Šé™¤ã™ã‚‹
     */
    deleteSelection() {
        const selection = Object.values(store.selections).find(s => s.userId === this.userId);
        if (!selection) return;

        // è¤‡æ•°ã‚¢ã‚¤ãƒ†ãƒ ã«ã¾ãŸãŒã‚‹é¸æŠç¯„å›²ã®å ´åˆ
        if (selection.startItemId !== selection.endItemId) {
            this.deleteMultiItemSelection(selection);
            return;
        }

        // å˜ä¸€ã‚¢ã‚¤ãƒ†ãƒ å†…ã®é¸æŠç¯„å›²ã®å ´åˆ
        const target = this.findTarget();
        if (!target) return;

        const text = target.text || "";
        const startOffset = Math.min(selection.startOffset, selection.endOffset);
        const endOffset = Math.max(selection.startOffset, selection.endOffset);

        // ãƒ†ã‚­ã‚¹ãƒˆã‚’å‰Šé™¤
        const newText = text.substring(0, startOffset) + text.substring(endOffset);
        target.updateText(newText);

        // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’æ›´æ–°
        this.offset = startOffset;
        this.applyToStore();

        // é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢
        this.clearSelection();

        // ã‚«ãƒ¼ã‚½ãƒ«ç‚¹æ»…ã‚’é–‹å§‹
        store.startCursorBlink();
    }

    /**
     * ã‚¢ã‚¤ãƒ†ãƒ é–“ã‚’ç§»å‹•ã™ã‚‹
     * @param direction ç§»å‹•æ–¹å‘
     */
    private navigateToItem(direction: "left" | "right" | "up" | "down") {
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
            console.log(
                `navigateToItem called with direction=${direction}, itemId=${this.itemId}, offset=${this.offset}`,
            );
        }

        // å‰å¾Œã‚¢ã‚¤ãƒ†ãƒ ã¸ã®ç§»å‹•ã¯ã‚¹ãƒˆã‚¢æ›´æ–°ã®ã¿è¡Œã„ã€ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œã¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§å‡¦ç†
        const oldItemId = this.itemId;
        let newItemId = this.itemId; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç¾åœ¨ã®ã‚¢ã‚¤ãƒ†ãƒ 
        let newOffset = this.offset; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç¾åœ¨ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ
        let itemChanged = false;

        // ç¾åœ¨ã®ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
        const currentTarget = this.findTarget();
        const currentText = currentTarget?.text || "";
        const currentColumn = this.getCurrentColumn(currentText, this.offset);

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
            console.log(`Current column: ${currentColumn}, current text: "${currentText}"`);
        }

        // ã‚¢ã‚¤ãƒ†ãƒ é–“ç§»å‹•ã®å‡¦ç†
        if (direction === "left") {
            const prevItem = this.findPreviousItem();
            if (prevItem) {
                newItemId = prevItem.id;
                newOffset = prevItem.text?.length || 0;
                itemChanged = true;

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                    console.log(`Moving left to previous item: id=${prevItem.id}, offset=${newOffset}`);
                }
            } else {
                // å‰ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒãªã„å ´åˆã¯ã€åŒã˜ã‚¢ã‚¤ãƒ†ãƒ ã®å…ˆé ­ã«ç§»å‹•
                const target = this.findTarget();
                if (target) {
                    newOffset = 0;

                    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                    if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                        console.log(`No previous item, moving to start of current item: offset=${newOffset}`);
                    }
                }
            }
        } else if (direction === "right") {
            const nextItem = this.findNextItem();
            if (nextItem) {
                newItemId = nextItem.id;
                newOffset = 0;
                itemChanged = true;

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                    console.log(`Moving right to next item: id=${nextItem.id}, offset=${newOffset}`);
                }
            } else {
                // æ¬¡ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒãªã„å ´åˆã¯ã€åŒã˜ã‚¢ã‚¤ãƒ†ãƒ ã®æœ«å°¾ã«ç§»å‹•
                const target = this.findTarget();
                if (target) {
                    newOffset = target.text?.length || 0;

                    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                    if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                        console.log(`No next item, moving to end of current item: offset=${newOffset}`);
                    }
                }
            }
        } else if (direction === "up") {
            const prevItem = this.findPreviousItem();
            if (prevItem) {
                newItemId = prevItem.id;
                const prevText = prevItem.text || "";
                const prevLines = prevText.split("\n");
                const lastLineIndex = prevLines.length - 1;
                const lastLineStart = this.getLineStartOffset(prevText, lastLineIndex);
                const lastLineEnd = this.getLineEndOffset(prevText, lastLineIndex);
                const lastLineLength = lastLineEnd - lastLineStart;

                // xåº§æ¨™ã®å¤‰åŒ–ãŒæœ€ã‚‚å°ã•ã„ä½ç½®ã‚’è¨ˆç®—
                // åˆæœŸåˆ—ä½ç½®ã¾ãŸã¯ç¾åœ¨ã®åˆ—ä½ç½®ã«æœ€ã‚‚è¿‘ã„ä½ç½®ã‚’é¸æŠ
                // å‰ã®ã‚¢ã‚¤ãƒ†ãƒ ã®æœ€å¾Œã®è¡Œã®é•·ã•ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ã™ã‚‹
                const targetColumn = Math.min(
                    this.initialColumn !== null ? this.initialColumn : currentColumn,
                    lastLineLength,
                );
                newOffset = lastLineStart + targetColumn;

                // ç‰¹æ®Šã‚±ãƒ¼ã‚¹: ç¾åœ¨ã®ã‚«ãƒ¼ã‚½ãƒ«ãŒè¡Œã®å…ˆé ­ï¼ˆã‚ªãƒ•ã‚»ãƒƒãƒˆ0ï¼‰ã«ã‚ã‚‹å ´åˆã¯ã€
                // å‰ã®ã‚¢ã‚¤ãƒ†ãƒ ã®æœ€å¾Œã®è¡Œã®å…ˆé ­ã«ç§»å‹•
                if (this.offset === 0) {
                    newOffset = lastLineStart;
                }

                itemChanged = true;

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                console.log(
                    `navigateToItem up - Moving to previous item's last line: itemId=${prevItem.id}, offset=${newOffset}, targetColumn=${targetColumn}, lastLineStart=${lastLineStart}, lastLineLength=${lastLineLength}`,
                );
                if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                    console.log(
                        `Moving up to previous item's last line: id=${prevItem.id}, lastLineIndex=${lastLineIndex}, lastLineStart=${lastLineStart}, lastLineLength=${lastLineLength}, newOffset=${newOffset}, currentColumn=${currentColumn}`,
                    );
                }
            } else {
                // å‰ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒãªã„å ´åˆã¯ã€åŒã˜ã‚¢ã‚¤ãƒ†ãƒ ã®å…ˆé ­ã«ç§»å‹•
                newOffset = 0;

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                    console.log(`No previous item, moving to start of current item: offset=${newOffset}`);
                }
            }
        } else if (direction === "down") {
            const nextItem = this.findNextItem();
            if (nextItem) {
                newItemId = nextItem.id;
                const nextText = nextItem.text || "";
                const nextLines = nextText.split("\n");
                const firstLineIndex = 0;
                const firstLineStart = this.getLineStartOffset(nextText, firstLineIndex);
                const firstLineEnd = this.getLineEndOffset(nextText, firstLineIndex);
                const firstLineLength = firstLineEnd - firstLineStart;

                // xåº§æ¨™ã®å¤‰åŒ–ãŒæœ€ã‚‚å°ã•ã„ä½ç½®ã‚’è¨ˆç®—
                // åˆæœŸåˆ—ä½ç½®ã¾ãŸã¯ç¾åœ¨ã®åˆ—ä½ç½®ã«æœ€ã‚‚è¿‘ã„ä½ç½®ã‚’é¸æŠ
                // æ¬¡ã®ã‚¢ã‚¤ãƒ†ãƒ ã®æœ€åˆã®è¡Œã®é•·ã•ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ã™ã‚‹
                const targetColumn = Math.min(
                    this.initialColumn !== null ? this.initialColumn : currentColumn,
                    firstLineLength,
                );
                newOffset = firstLineStart + targetColumn;

                // ç‰¹æ®Šã‚±ãƒ¼ã‚¹: ç¾åœ¨ã®ã‚«ãƒ¼ã‚½ãƒ«ãŒè¡Œã®æœ«å°¾ï¼ˆã‚ªãƒ•ã‚»ãƒƒãƒˆãŒãƒ†ã‚­ã‚¹ãƒˆé•·ï¼‰ã«ã‚ã‚‹å ´åˆã¯ã€
                // æ¬¡ã®ã‚¢ã‚¤ãƒ†ãƒ ã®æœ€åˆã®è¡Œã®æœ«å°¾ã«ç§»å‹•
                const currentTarget = this.findTarget();
                const currentText = currentTarget?.text || "";
                if (this.offset === currentText.length) {
                    newOffset = firstLineEnd;
                }

                itemChanged = true;

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                console.log(
                    `navigateToItem down - Moving to next item's first line: itemId=${nextItem.id}, offset=${newOffset}, targetColumn=${targetColumn}, firstLineStart=${firstLineStart}, firstLineLength=${firstLineLength}`,
                );
                if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                    console.log(
                        `Moving down to next item's first line: id=${nextItem.id}, firstLineIndex=${firstLineIndex}, firstLineStart=${firstLineStart}, firstLineLength=${firstLineLength}, newOffset=${newOffset}, currentColumn=${currentColumn}`,
                    );
                }
            } else {
                // æ¬¡ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒãªã„å ´åˆã¯ã€åŒã˜ã‚¢ã‚¤ãƒ†ãƒ ã®æœ«å°¾ã«ç§»å‹•
                const target = this.findTarget();
                if (target) {
                    newOffset = target.text?.length || 0;

                    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                    if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                        console.log(`No next item, moving to end of current item: offset=${newOffset}`);
                    }
                }
            }
        }

        // ã‚¢ã‚¤ãƒ†ãƒ ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã®ã¿å‡¦ç†ã‚’å®Ÿè¡Œ
        if (itemChanged) {
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
            if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                console.log(`Item changed: oldItemId=${oldItemId}, newItemId=${newItemId}, newOffset=${newOffset}`);
            }

            // ç§»å‹•å‰ã«å¤ã„ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚«ãƒ¼ã‚½ãƒ«ã‚’ç¢ºå®Ÿã«å‰Šé™¤
            store.clearCursorForItem(oldItemId);

            // åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä»–ã®ã‚«ãƒ¼ã‚½ãƒ«ã‚‚å‰Šé™¤ï¼ˆå˜ä¸€ã‚«ãƒ¼ã‚½ãƒ«ãƒ¢ãƒ¼ãƒ‰ã‚’ç¶­æŒï¼‰
            // æ³¨æ„: å…¨ã¦ã®ã‚«ãƒ¼ã‚½ãƒ«ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã®ã§ã¯ãªãã€åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚«ãƒ¼ã‚½ãƒ«ã®ã¿ã‚’ã‚¯ãƒªã‚¢
            const cursorsToRemove = Object.values(store.cursors)
                .filter(c => c.userId === this.userId && c.cursorId !== this.cursorId)
                .map(c => c.cursorId);

            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
            if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                console.log(`Removing cursors: ${cursorsToRemove.join(", ")}`);
            }

            // é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢
            store.clearSelectionForUser(this.userId);

            // ç§»å‹•å…ˆã‚¢ã‚¤ãƒ†ãƒ ã®æ—¢å­˜ã®ã‚«ãƒ¼ã‚½ãƒ«ã‚‚å‰Šé™¤ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
            // æ³¨æ„: åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚«ãƒ¼ã‚½ãƒ«ã®ã¿ã‚’å‰Šé™¤
            const cursorsInTargetItem = Object.values(store.cursors)
                .filter(c => c.itemId === newItemId && c.userId === this.userId)
                .map(c => c.cursorId);

            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
            if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                console.log(`Removing cursors in target item: ${cursorsInTargetItem.join(", ")}`);
            }

            // æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã¨ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è¨­å®š
            this.itemId = newItemId;
            this.offset = newOffset;

            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ›´æ–°
            store.setActiveItem(this.itemId);

            // æ–°ã—ã„ã‚«ãƒ¼ã‚½ãƒ«ã‚’ä½œæˆ
            const cursorId = store.setCursor({
                itemId: this.itemId,
                offset: this.offset,
                isActive: true,
                userId: this.userId,
            });

            // cursorIdã‚’æ›´æ–°
            this.cursorId = cursorId;

            // ã‚«ãƒ¼ã‚½ãƒ«ç‚¹æ»…ã‚’é–‹å§‹
            store.startCursorBlink();

            // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œ
            if (typeof document !== "undefined") {
                const event = new CustomEvent("navigate-to-item", {
                    bubbles: true,
                    detail: {
                        direction,
                        fromItemId: oldItemId,
                        toItemId: this.itemId,
                        cursorScreenX: 0, // ã‚«ãƒ¼ã‚½ãƒ«ã®Xåº§æ¨™ï¼ˆã‚¢ã‚¤ãƒ†ãƒ é–“ç§»å‹•æ™‚ã¯0ã‚’æŒ‡å®šï¼‰
                    },
                });
                document.dispatchEvent(event);
            }
        } else {
            // ã‚¢ã‚¤ãƒ†ãƒ ãŒå¤‰æ›´ã•ã‚Œãªã‹ã£ãŸå ´åˆã§ã‚‚ã€ã‚«ãƒ¼ã‚½ãƒ«ã®çŠ¶æ…‹ã‚’æ›´æ–°
            this.offset = newOffset;
            this.applyToStore();
            store.startCursorBlink();

            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
            if (typeof window !== "undefined" && (window as any).DEBUG_MODE) {
                console.log(`Item not changed, updated offset: ${newOffset}`);
            }
        }
    }

    /**
     * ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®é¸æŠç¯„å›²ã‚’è¨­å®šã™ã‚‹
     * @param startItemId é–‹å§‹ã‚¢ã‚¤ãƒ†ãƒ ID
     * @param startOffset é–‹å§‹ã‚ªãƒ•ã‚»ãƒƒãƒˆ
     * @param endItemId çµ‚äº†ã‚¢ã‚¤ãƒ†ãƒ ID
     * @param endOffset çµ‚äº†ã‚ªãƒ•ã‚»ãƒƒãƒˆ
     */
    updateGlobalTextareaSelection(startItemId: string, startOffset: number, endItemId: string, endOffset: number) {
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’å–å¾—
        const textarea = document.querySelector(".global-textarea") as HTMLTextAreaElement;
        if (!textarea) return;

        // ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
        const startItemEl = document.querySelector(`[data-item-id="${startItemId}"] .item-text`) as HTMLElement;
        const endItemEl = document.querySelector(`[data-item-id="${endItemId}"] .item-text`) as HTMLElement;

        if (!startItemEl || !endItemEl) return;

        const startItemText = startItemEl.textContent || "";
        const endItemText = endItemEl.textContent || "";

        // å˜ä¸€ã‚¢ã‚¤ãƒ†ãƒ å†…ã®é¸æŠç¯„å›²ã®å ´åˆ
        if (startItemId === endItemId) {
            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®å†…å®¹ã‚’æ›´æ–°
            textarea.value = startItemText;

            // é¸æŠç¯„å›²ã‚’è¨­å®š
            textarea.setSelectionRange(startOffset, endOffset);
        } else {
            // è¤‡æ•°ã‚¢ã‚¤ãƒ†ãƒ ã«ã¾ãŸãŒã‚‹é¸æŠç¯„å›²ã®å ´åˆ
            // å…¨ã¦ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—
            const allItems = Array.from(document.querySelectorAll("[data-item-id]")) as HTMLElement[];
            const allItemIds = allItems.map(el => el.getAttribute("data-item-id")!);

            // é–‹å§‹ã‚¢ã‚¤ãƒ†ãƒ ã¨çµ‚äº†ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
            const startIdx = allItemIds.indexOf(startItemId);
            const endIdx = allItemIds.indexOf(endItemId);

            if (startIdx === -1 || endIdx === -1) return;

            // é–‹å§‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨çµ‚äº†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ­£è¦åŒ–
            const firstIdx = Math.min(startIdx, endIdx);
            const lastIdx = Math.max(startIdx, endIdx);

            // é¸æŠç¯„å›²å†…ã®ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’é€£çµ
            let combinedText = "";
            for (let i = firstIdx; i <= lastIdx; i++) {
                const itemId = allItemIds[i];
                const itemEl = document.querySelector(`[data-item-id="${itemId}"] .item-text`) as HTMLElement;
                if (itemEl) {
                    combinedText += itemEl.textContent || "";
                    if (i < lastIdx) combinedText += "\n";
                }
            }

            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®å†…å®¹ã‚’æ›´æ–°
            textarea.value = combinedText;

            // é¸æŠç¯„å›²ã®é–‹å§‹ä½ç½®ã¨çµ‚äº†ä½ç½®ã‚’è¨ˆç®—
            let selectionStart = 0;
            let selectionEnd = 0;

            // é–‹å§‹ã‚¢ã‚¤ãƒ†ãƒ ã‹ã‚‰é–‹å§‹ä½ç½®ã¾ã§ã®ãƒ†ã‚­ã‚¹ãƒˆé•·ã‚’è¨ˆç®—
            if (startIdx === firstIdx) {
                selectionStart = startOffset;
            } else {
                // é–‹å§‹ã‚¢ã‚¤ãƒ†ãƒ ãŒçµ‚äº†ã‚¢ã‚¤ãƒ†ãƒ ã‚ˆã‚Šå¾Œã«ã‚ã‚‹å ´åˆï¼ˆé€†æ–¹å‘é¸æŠï¼‰
                let textBeforeStart = 0;
                for (let i = firstIdx; i < startIdx; i++) {
                    const itemId = allItemIds[i];
                    const itemEl = document.querySelector(`[data-item-id="${itemId}"] .item-text`) as HTMLElement;
                    if (itemEl) {
                        textBeforeStart += (itemEl.textContent || "").length + 1; // +1 for newline
                    }
                }
                selectionStart = textBeforeStart + startOffset;
            }

            // çµ‚äº†ã‚¢ã‚¤ãƒ†ãƒ ã‹ã‚‰çµ‚äº†ä½ç½®ã¾ã§ã®ãƒ†ã‚­ã‚¹ãƒˆé•·ã‚’è¨ˆç®—
            if (endIdx === lastIdx) {
                let textBeforeEnd = 0;
                for (let i = firstIdx; i < endIdx; i++) {
                    const itemId = allItemIds[i];
                    const itemEl = document.querySelector(`[data-item-id="${itemId}"] .item-text`) as HTMLElement;
                    if (itemEl) {
                        textBeforeEnd += (itemEl.textContent || "").length + 1; // +1 for newline
                    }
                }
                selectionEnd = textBeforeEnd + endOffset;
            } else {
                // çµ‚äº†ã‚¢ã‚¤ãƒ†ãƒ ãŒé–‹å§‹ã‚¢ã‚¤ãƒ†ãƒ ã‚ˆã‚Šå‰ã«ã‚ã‚‹å ´åˆï¼ˆé€†æ–¹å‘é¸æŠï¼‰
                selectionEnd = endOffset;
            }

            // é¸æŠç¯„å›²ã‚’è¨­å®š
            textarea.setSelectionRange(selectionStart, selectionEnd);
        }
    }

    /**
     * é¸æŠç¯„å›²ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤ªå­—ã«å¤‰æ›´ã™ã‚‹ï¼ˆScrapboxæ§‹æ–‡: [[text]]ï¼‰
     */
    formatBold() {
        this.applyScrapboxFormatting("bold");
    }

    /**
     * é¸æŠç¯„å›²ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ–œä½“ã«å¤‰æ›´ã™ã‚‹ï¼ˆScrapboxæ§‹æ–‡: [/ text]ï¼‰
     */
    formatItalic() {
        this.applyScrapboxFormatting("italic");
    }

    /**
     * é¸æŠç¯„å›²ã®ãƒ†ã‚­ã‚¹ãƒˆã«ä¸‹ç·šã‚’è¿½åŠ ã™ã‚‹ï¼ˆHTML ã‚¿ã‚°ã‚’ä½¿ç”¨ï¼‰
     */
    formatUnderline() {
        this.applyScrapboxFormatting("underline");
    }

    /**
     * é¸æŠç¯„å›²ã®ãƒ†ã‚­ã‚¹ãƒˆã«å–ã‚Šæ¶ˆã—ç·šã‚’è¿½åŠ ã™ã‚‹ï¼ˆScrapboxæ§‹æ–‡: [- text]ï¼‰
     */
    formatStrikethrough() {
        this.applyScrapboxFormatting("strikethrough");
    }

    /**
     * é¸æŠç¯„å›²ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›´ã™ã‚‹ï¼ˆScrapboxæ§‹æ–‡: `text`ï¼‰
     */
    formatCode() {
        this.applyScrapboxFormatting("code");
    }

    /**
     * é¸æŠç¯„å›²ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é©ç”¨ã™ã‚‹å…±é€šãƒ¡ã‚½ãƒƒãƒ‰
     * @param markdownPrefix Markdownå½¢å¼ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹
     * @param markdownSuffix Markdownå½¢å¼ã®ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹
     * @param scrapboxPrefix Scrapboxå½¢å¼ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹
     * @param scrapboxSuffix Scrapboxå½¢å¼ã®ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹
     */
    private applyFormatting(
        markdownPrefix: string,
        markdownSuffix: string,
        scrapboxPrefix: string,
        scrapboxSuffix: string,
    ) {
        // Scrapboxæ§‹æ–‡ã‚’ä½¿ç”¨
        const prefix = scrapboxPrefix;
        const suffix = scrapboxSuffix;

        // é¸æŠç¯„å›²ã‚’å–å¾—
        const selection = Object.values(store.selections).find(s => s.userId === this.userId);

        if (!selection || selection.startOffset === selection.endOffset) {
            // é¸æŠç¯„å›²ãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
            return;
        }

        // è¤‡æ•°ã‚¢ã‚¤ãƒ†ãƒ ã«ã¾ãŸãŒã‚‹é¸æŠç¯„å›²ã®å ´åˆ
        if (selection.startItemId !== selection.endItemId) {
            this.applyFormattingToMultipleItems(selection, prefix, suffix);
            return;
        }

        // å˜ä¸€ã‚¢ã‚¤ãƒ†ãƒ å†…ã®é¸æŠç¯„å›²ã®å ´åˆ
        const target = this.findTarget();
        if (!target) return;

        const text = target.text || "";
        const startOffset = Math.min(selection.startOffset, selection.endOffset);
        const endOffset = Math.max(selection.startOffset, selection.endOffset);
        const selectedText = text.substring(startOffset, endOffset);

        // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ
        const formattedText = prefix + selectedText + suffix;

        // ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
        const newText = text.substring(0, startOffset) + formattedText + text.substring(endOffset);
        target.updateText(newText);

        // Yjsçµ±åˆ: ä¸¦è¡Œã—ã¦Yjsãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
        applyTextUpdateToYjs(target, newText);

        // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’æ›´æ–°ï¼ˆé¸æŠç¯„å›²ã®çµ‚äº†ä½ç½®ã«è¨­å®šï¼‰
        this.offset = startOffset + formattedText.length;
        this.applyToStore();

        // é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢
        this.clearSelection();

        // ã‚«ãƒ¼ã‚½ãƒ«ç‚¹æ»…ã‚’é–‹å§‹
        store.startCursorBlink();
    }

    /**
     * é¸æŠç¯„å›²ã«Scrapboxæ§‹æ–‡ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é©ç”¨ã™ã‚‹
     * @param formatType ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ç¨®é¡ï¼ˆ'bold', 'italic', 'strikethrough', 'underline', 'code'ï¼‰
     */
    private applyScrapboxFormatting(formatType: "bold" | "italic" | "strikethrough" | "underline" | "code") {
        // é¸æŠç¯„å›²ã‚’å–å¾—
        const selection = Object.values(store.selections).find(s => s.userId === this.userId);

        if (!selection || selection.startOffset === selection.endOffset) {
            // é¸æŠç¯„å›²ãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
            return;
        }

        // è¤‡æ•°ã‚¢ã‚¤ãƒ†ãƒ ã«ã¾ãŸãŒã‚‹é¸æŠç¯„å›²ã®å ´åˆ
        if (selection.startItemId !== selection.endItemId) {
            this.applyScrapboxFormattingToMultipleItems(selection, formatType);
            return;
        }

        // å˜ä¸€ã‚¢ã‚¤ãƒ†ãƒ å†…ã®é¸æŠç¯„å›²ã®å ´åˆ
        const target = this.findTarget();
        if (!target) return;

        const text = target.text || "";
        const startOffset = Math.min(selection.startOffset, selection.endOffset);
        const endOffset = Math.max(selection.startOffset, selection.endOffset);
        const selectedText = text.substring(startOffset, endOffset);

        // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ
        let formattedText = "";
        switch (formatType) {
            case "bold":
                formattedText = ScrapboxFormatter.bold(selectedText);
                break;
            case "italic":
                formattedText = ScrapboxFormatter.italic(selectedText);
                break;
            case "strikethrough":
                formattedText = ScrapboxFormatter.strikethrough(selectedText);
                break;
            case "underline":
                formattedText = ScrapboxFormatter.underline(selectedText);
                break;
            case "code":
                formattedText = ScrapboxFormatter.code(selectedText);
                break;
        }

        // ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
        const newText = text.substring(0, startOffset) + formattedText + text.substring(endOffset);
        target.updateText(newText);

        // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’æ›´æ–°ï¼ˆé¸æŠç¯„å›²ã®çµ‚äº†ä½ç½®ã«è¨­å®šï¼‰
        this.offset = startOffset + formattedText.length;
        this.applyToStore();

        // é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢
        this.clearSelection();

        // ã‚«ãƒ¼ã‚½ãƒ«ç‚¹æ»…ã‚’é–‹å§‹
        store.startCursorBlink();
    }

    /**
     * è¤‡æ•°ã‚¢ã‚¤ãƒ†ãƒ ã«ã¾ãŸãŒã‚‹é¸æŠç¯„å›²ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é©ç”¨ã™ã‚‹
     */
    private applyFormattingToMultipleItems(selection: any, prefix: string, suffix: string) {
        // é–‹å§‹ã‚¢ã‚¤ãƒ†ãƒ ã¨çµ‚äº†ã‚¢ã‚¤ãƒ†ãƒ ã®IDã‚’å–å¾—
        const startItemId = selection.startItemId;
        const endItemId = selection.endItemId;
        const startOffset = selection.startOffset;
        const endOffset = selection.endOffset;
        const isReversed = selection.isReversed;

        // å…¨ã‚¢ã‚¤ãƒ†ãƒ ã®IDã‚’å–å¾—
        const allItemElements = Array.from(document.querySelectorAll("[data-item-id]")) as HTMLElement[];
        const allItemIds = allItemElements.map(el => el.getAttribute("data-item-id")!);

        // é–‹å§‹ã‚¢ã‚¤ãƒ†ãƒ ã¨çµ‚äº†ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
        const startIdx = allItemIds.indexOf(startItemId);
        const endIdx = allItemIds.indexOf(endItemId);

        if (startIdx === -1 || endIdx === -1) return;

        // é–‹å§‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨çµ‚äº†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ­£è¦åŒ–
        const firstIdx = Math.min(startIdx, endIdx);
        const lastIdx = Math.max(startIdx, endIdx);

        // é¸æŠç¯„å›²å†…ã®å„ã‚¢ã‚¤ãƒ†ãƒ ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é©ç”¨
        for (let i = firstIdx; i <= lastIdx; i++) {
            const itemId = allItemIds[i];
            const item = this.searchItem(generalStore.currentPage!, itemId);

            if (!item) continue;

            const text = item.text || "";

            // ã‚¢ã‚¤ãƒ†ãƒ ã®ä½ç½®ã«å¿œã˜ã¦ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é©ç”¨
            if (i === firstIdx && i === lastIdx) {
                // å˜ä¸€ã‚¢ã‚¤ãƒ†ãƒ å†…ã®é¸æŠç¯„å›²
                const start = isReversed ? endOffset : startOffset;
                const end = isReversed ? startOffset : endOffset;
                const selectedText = text.substring(start, end);
                const formattedText = prefix + selectedText + suffix;
                const newText = text.substring(0, start) + formattedText + text.substring(end);
                item.updateText(newText);

                // Yjsçµ±åˆ: ä¸¦è¡Œã—ã¦Yjsãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
                applyTextUpdateToYjs(item, newText);
            } else if (i === firstIdx) {
                // é–‹å§‹ã‚¢ã‚¤ãƒ†ãƒ 
                const start = isReversed ? text.length : startOffset;
                const end = text.length;
                const selectedText = text.substring(start, end);
                const formattedText = prefix + selectedText + (i === lastIdx - 1 ? suffix : "");
                const newText = text.substring(0, start) + formattedText;
                item.updateText(newText);

                // Yjsçµ±åˆ: ä¸¦è¡Œã—ã¦Yjsãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
                applyTextUpdateToYjs(item, newText);
            } else if (i === lastIdx) {
                // çµ‚äº†ã‚¢ã‚¤ãƒ†ãƒ 
                const start = 0;
                const end = isReversed ? startOffset : endOffset;
                const selectedText = text.substring(start, end);
                const formattedText = (i === firstIdx + 1 ? prefix : "") + selectedText + suffix;
                const newText = formattedText + text.substring(end);
                item.updateText(newText);

                // Yjsçµ±åˆ: ä¸¦è¡Œã—ã¦Yjsãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
                applyTextUpdateToYjs(item, newText);
            } else {
                // ä¸­é–“ã‚¢ã‚¤ãƒ†ãƒ 
                const newText = prefix + text + suffix;
                item.updateText(newText);

                // Yjsçµ±åˆ: ä¸¦è¡Œã—ã¦Yjsãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
                applyTextUpdateToYjs(item, newText);
            }
        }

        // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’æ›´æ–°ï¼ˆé¸æŠç¯„å›²ã®çµ‚äº†ä½ç½®ã«è¨­å®šï¼‰
        this.itemId = isReversed ? startItemId : endItemId;
        this.offset = isReversed ? startOffset : endOffset;
        this.applyToStore();

        // é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢
        this.clearSelection();

        // ã‚«ãƒ¼ã‚½ãƒ«ç‚¹æ»…ã‚’é–‹å§‹
        store.startCursorBlink();
    }

    /**
     * è¤‡æ•°ã‚¢ã‚¤ãƒ†ãƒ ã«ã¾ãŸãŒã‚‹é¸æŠç¯„å›²ã«Scrapboxæ§‹æ–‡ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é©ç”¨ã™ã‚‹
     */
    private applyScrapboxFormattingToMultipleItems(
        selection: any,
        formatType: "bold" | "italic" | "strikethrough" | "underline" | "code",
    ) {
        // é–‹å§‹ã‚¢ã‚¤ãƒ†ãƒ ã¨çµ‚äº†ã‚¢ã‚¤ãƒ†ãƒ ã®IDã‚’å–å¾—
        const startItemId = selection.startItemId;
        const endItemId = selection.endItemId;
        const startOffset = selection.startOffset;
        const endOffset = selection.endOffset;
        const isReversed = selection.isReversed;

        // å…¨ã‚¢ã‚¤ãƒ†ãƒ ã®IDã‚’å–å¾—
        const allItemElements = Array.from(document.querySelectorAll("[data-item-id]")) as HTMLElement[];
        const allItemIds = allItemElements.map(el => el.getAttribute("data-item-id")!);

        // é–‹å§‹ã‚¢ã‚¤ãƒ†ãƒ ã¨çµ‚äº†ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
        const startIdx = allItemIds.indexOf(startItemId);
        const endIdx = allItemIds.indexOf(endItemId);

        if (startIdx === -1 || endIdx === -1) return;

        // é–‹å§‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨çµ‚äº†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ­£è¦åŒ–
        const firstIdx = Math.min(startIdx, endIdx);
        const lastIdx = Math.max(startIdx, endIdx);

        // é¸æŠç¯„å›²å†…ã®å„ã‚¢ã‚¤ãƒ†ãƒ ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é©ç”¨
        for (let i = firstIdx; i <= lastIdx; i++) {
            const itemId = allItemIds[i];
            const item = this.searchItem(generalStore.currentPage!, itemId);

            if (!item) continue;

            const text = item.text || "";

            // ã‚¢ã‚¤ãƒ†ãƒ ã®ä½ç½®ã«å¿œã˜ã¦ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é©ç”¨
            if (i === firstIdx && i === lastIdx) {
                // å˜ä¸€ã‚¢ã‚¤ãƒ†ãƒ å†…ã®é¸æŠç¯„å›²
                const start = isReversed ? endOffset : startOffset;
                const end = isReversed ? startOffset : endOffset;
                const selectedText = text.substring(start, end);

                // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ
                let formattedText = "";
                switch (formatType) {
                    case "bold":
                        formattedText = ScrapboxFormatter.bold(selectedText);
                        break;
                    case "italic":
                        formattedText = ScrapboxFormatter.italic(selectedText);
                        break;
                    case "strikethrough":
                        formattedText = ScrapboxFormatter.strikethrough(selectedText);
                        break;
                    case "underline":
                        formattedText = ScrapboxFormatter.underline(selectedText);
                        break;
                    case "code":
                        formattedText = ScrapboxFormatter.code(selectedText);
                        break;
                }

                const newText = text.substring(0, start) + formattedText + text.substring(end);
                item.updateText(newText);
            } else {
                // è¤‡æ•°ã‚¢ã‚¤ãƒ†ãƒ ã«ã¾ãŸãŒã‚‹é¸æŠç¯„å›²ã®å ´åˆã¯ã€å„ã‚¢ã‚¤ãƒ†ãƒ ã‚’å€‹åˆ¥ã«å‡¦ç†
                // ç¾åœ¨ã¯å˜ä¸€ã‚¢ã‚¤ãƒ†ãƒ å†…ã®é¸æŠç¯„å›²ã®ã¿ã‚µãƒãƒ¼ãƒˆ
                // å°†æ¥çš„ã«è¤‡æ•°ã‚¢ã‚¤ãƒ†ãƒ ã«ã¾ãŸãŒã‚‹é¸æŠç¯„å›²ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹å ´åˆã¯ã€
                // ã“ã“ã«å®Ÿè£…ã‚’è¿½åŠ ã™ã‚‹
            }
        }

        // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’æ›´æ–°ï¼ˆé¸æŠç¯„å›²ã®çµ‚äº†ä½ç½®ã«è¨­å®šï¼‰
        this.itemId = isReversed ? startItemId : endItemId;
        this.offset = isReversed ? startOffset : endOffset;
        this.applyToStore();

        // é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢
        this.clearSelection();

        // ã‚«ãƒ¼ã‚½ãƒ«ç‚¹æ»…ã‚’é–‹å§‹
        store.startCursorBlink();
    }
}
