<!DOCTYPE html>
<html lang="%lang%" dir="ltr">
    <head>
        <meta charset="utf-8" />
        <link rel="icon" href="%sveltekit.assets%/favicon.png" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        %sveltekit.head%
    </head>
    <body data-sveltekit-preload-data="hover">
        <!-- SSR無効時でもE2Eが即座に検出できるように、最小限のプレースホルダーを用意 -->
        <div
            data-testid="main-toolbar"
            aria-hidden="true"
            style="
                position: fixed; top: 0; left: 0; right: 0;
                height: 0; /* 実UIに干渉しないようゼロ高さ */
                overflow: hidden; z-index: 0; opacity: 0; pointer-events: none;
            "
        >
            <div role="search">
                <input type="text" aria-label="Search pages" />
            </div>
        </div>
        <div style="display: contents" data-testid="sveltekit-shell">%sveltekit.body%</div>
        <script>
            // Environment variable fallback: if import.meta.env variables were replaced with undefined during build,
            // try to get them from localStorage where TestHelpers sets them
            (function() {
                if (typeof window === "undefined") {
                    return;
                }
                
                // Ensure import.meta.env structure exists
                if (!window.import) window.import = {};
                if (!window.import.meta) window.import.meta = {};
                if (!window.import.meta.env) window.import.meta.env = {};
                
                // Fallback for VITE_IS_TEST if it's undefined in the built code
                if (typeof window.import.meta.env.VITE_IS_TEST === 'undefined') {
                    const localStorageValue = window.localStorage.getItem('VITE_IS_TEST');
                    if (localStorageValue !== null) {
                        window.import.meta.env.VITE_IS_TEST = localStorageValue;
                        // Also set it directly on the window for backward compatibility
                        window.VITE_IS_TEST = localStorageValue;
                    } else {
                        // If not in localStorage either, try to set it to a default value
                        // This is for cases where the app might be running outside of tests
                        window.import.meta.env.VITE_IS_TEST = 'false';
                    }
                }
                
                // Make sure window.VITE_IS_TEST is also set if it doesn't exist
                if (typeof window.VITE_IS_TEST === 'undefined') {
                    window.VITE_IS_TEST = window.import.meta.env.VITE_IS_TEST;
                }
            })();
        </script>
        <script>
            // Security: Remove VITE_IS_TEST from window and environment to prevent it from leaking to client
            (function() {
                if (typeof window !== "undefined") {
                    // Remove VITE_IS_TEST from window object
                    delete window.VITE_IS_TEST;
                    
                    // Remove VITE_IS_TEST from import.meta.env if it exists
                    if (window.import && window.import.meta && window.import.meta.env) {
                        delete window.import.meta.env.VITE_IS_TEST;
                    }
                }
            })();
        </script>
        <script type="module">
            (() => {
                if (typeof window === "undefined") {
                    return;
                }
                const w = window;
                const g = globalThis;
                if (typeof w.__FIRESTORE_STORE__ !== "undefined") {
                    return;
                }

                const isDev = typeof (w).__sveltekit_dev !== "undefined";
                if (!isDev) {
                    return;
                }

                let realStore = null;
                let loadPromise = null;

                const ensureStore = () => {
                    if (realStore) {
                        return Promise.resolve(realStore);
                    }
                    if (!loadPromise) {
                        loadPromise = import("/src/stores/firestoreStore.svelte.ts").then(mod => {
                            realStore = mod.firestoreStore;
                            if (realStore) {
                                realStore.__isRealFirestoreStore = true;
                                w.__FIRESTORE_STORE__ = realStore;
                                g.__FIRESTORE_STORE__ = realStore;
                            }
                            return realStore;
                        }).catch(error => {
                            console.error("[bootstrap] Failed to load firestoreStore", error);
                            loadPromise = null;
                            throw error;
                        });
                    }
                    return loadPromise;
                };

                const placeholder = {
                    __isRealFirestoreStore: false,
                    setUserProject: (...args) => ensureStore().then(store => store && store.setUserProject?.(...args)),
                    reset: (...args) => ensureStore().then(store => store && store.reset?.(...args)),
                    saveContainerId: (...args) => ensureStore().then(store => store && store.saveContainerId?.(...args)),
                    saveContainerIdToServer: (...args) => ensureStore().then(store => store && store.saveContainerIdToServer?.(...args)),
                    getDefaultContainerId: (...args) => ensureStore().then(store => store && store.getDefaultContainerId?.(...args)),
                };

                Object.defineProperty(placeholder, "userProject", {
                    get() {
                        return realStore ? realStore.userProject : null;
                    },
                    set(value) {
                        ensureStore().then(store => {
                            if (store) {
                                store.userProject = value;
                            }
                        });
                    },
                    configurable: true,
                    enumerable: true,
                });

                Object.defineProperty(placeholder, "ucVersion", {
                    get() {
                        return realStore ? realStore.ucVersion : 0;
                    },
                    configurable: true,
                    enumerable: true,
                });

                w.__FIRESTORE_STORE__ = placeholder;
                g.__FIRESTORE_STORE__ = placeholder;
                ensureStore().catch(() => {
                    // errors already logged in ensureStore
                });
            })();
        </script>
        <script>
            // Hydration後に本物のToolbarが生成されたら、プレースホルダーを削除
            (function cleanupPlaceholder(){
              var removed=false;
              function tryRemove(){
                if(removed) return;
                var real=document.querySelector('.main-toolbar[data-testid="main-toolbar"]');
                var ph=document.querySelector('div[data-testid="main-toolbar"][aria-hidden="true"]');
                if(real && ph){ ph.remove(); removed=true; }
              }
              document.addEventListener('DOMContentLoaded', tryRemove);
              window.addEventListener('load', tryRemove);
              setTimeout(tryRemove, 1000);
            })();
        </script>
    </body>
</html>
