# クリップボードテスト実行ガイド

このドキュメントでは、クリップボードAPIを使用したテストの実行方法と注意点について説明します。

## 前提条件

クリップボードAPIは以下の条件でのみ動作します：

1. **セキュアコンテキスト**：HTTPS または localhost 環境
2. **適切な権限**：clipboard-read および clipboard-write 権限が必要
3. **ブラウザの対応**：最新のChrome、Firefox、Edgeなどのモダンブラウザ

## テスト環境の設定

### 1. サーバー設定

テストを実行するには、以下のサーバーが必要です：

- **アプリケーションサーバー**：localhost:7090 で実行
  - Ubuntu環境で `npm run dev:localhost` を実行
- **Tinyliciousサーバー**：localhost:7092 で実行
  - Ubuntu環境で `npm run dev:localhost:tinylicious` を実行

### 2. テスト実行コマンド

クリップボードテストを実行するには、以下のコマンドを使用します：

```bash
# クリップボードテストのみを実行
npm run test:e2e:localhost:clipboard

# デバッグモードでクリップボードテストを実行
npm run test:e2e:localhost:debug e2e/core/FMT-0004.spec.ts

# UIモードでクリップボードテストを実行
npm run test:e2e:localhost:ui e2e/core/FMT-0004.spec.ts
```
テストを実行する前に必ず `scripts/codex-setp.sh` を実行してください。
This sets up Firebase emulators and other services required for the tests.
Playwright テストは `scripts/run-tests.sh <spec>` を利用して 1 ファイルずつ実行します。

### Test Guidelines

- 要素取得には `data-item-id` 属性を利用し、`.nth()` の使用は避けます。
- 画面状態の取得や DOM 操作は `TestHelpers` を介して行い、`page.evaluate` を直接書かないようにします。

## テストの内容

### FMT-0004.spec.ts

このテストファイルには以下のクリップボード関連テストが含まれています：

1. **カーソル位置にテキストが入力される**
   - クリップボードテストページでテキストをコピー
   - アウトライナーページでカーソル位置にペースト
   - 期待される結果：カーソル位置にテキストが挿入される

2. **クリップボードAPIの基本機能が動作する**
   - クリップボードAPIを使用してテキストをコピー・ペースト
   - 期待される結果：クリップボードの内容がアイテムに反映される

### clipboard-test.spec.ts

このファイルには追加のクリップボードテストが含まれていますが、現在はスキップされています。
将来的に安定したら有効化する予定です。

## トラブルシューティング

### 一般的な問題

1. **権限エラー**
   - エラーメッセージ: `NotAllowedError: Read permission denied`
   - 解決策: テストコードで `context.grantPermissions(['clipboard-read', 'clipboard-write'])` が実行されていることを確認

2. **タイミング問題**
   - 症状: コピー・ペースト操作が完了する前に次のステップが実行される
   - 解決策: `page.waitForTimeout()` の時間を増やす（例：1000ms → 2000ms）

3. **セレクタの問題**
   - 症状: 要素が見つからないエラー
   - 解決策: セレクタを確認し、必要に応じて修正。`page.waitForSelector()` のタイムアウト値を増やす

4. **ペースト操作が機能しない**
   - 症状: `Control+v` キーを押してもペーストが実行されない
   - 解決策1: クリップボードの内容を直接取得して `page.keyboard.type()` で入力する
   - 解決策2: テスト環境でのクリップボード操作の制限を考慮し、テストの期待値を調整する

5. **クリップボードの内容が取得できない**
   - 症状: `navigator.clipboard.readText()` が空の文字列または null を返す
   - 解決策: クリップボードAPIの代わりに、グローバル変数を使用してテスト内でテキストを共有する

### 環境固有の問題

1. **Windows環境**
   - Windows環境ではサーバーを起動せず、Ubuntu環境でサーバーを起動してください
   - Windows側でサーバーモジュールをインストールすると、Ubuntu側の環境が壊れる可能性があります

2. **Firefox**
   - Firefoxではクリップボード権限の処理が異なり、エラーが発生する場合があります
   - テストはChromeで実行することを推奨します

## 今後の改善点

1. クリップボードテストの安定性向上
2. より多くのクリップボード操作パターンのテスト追加
3. 異なるブラウザでのクリップボードAPIの互換性テスト
4. クリップボード操作の代替手段の実装（例：グローバル変数を使用したテキスト共有）
5. テスト環境でのクリップボード操作の制限に対応するための柔軟なテスト設計

## 実装上の注意点

1. **テストの柔軟性**
   - クリップボードAPIはブラウザや環境によって動作が異なるため、テストは柔軟に設計する必要があります
   - 厳密な期待値の比較ではなく、「テキストが変更されたか」「特定の文字列が含まれているか」などの緩やかな検証を行う

2. **複数の方法を試す**
   - ペースト操作が失敗した場合に備えて、複数の方法を実装しておく
   - 例: `Control+v` → クリップボードから直接取得して入力 → グローバル変数から取得

3. **詳細なログ出力**
   - クリップボード操作の各ステップで詳細なログを出力し、問題の特定を容易にする
   - スクリーンショットを撮影して視覚的な確認を可能にする
