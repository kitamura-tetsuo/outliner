version: "3.9"
services:
  server:
    build: ./server
    env_file: .env
    ports:
      - "${PORT:-3000}:${PORT:-3000}"
    volumes:
      - yjs-data:${YJS_DATA_DIR:-/data/yjs}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PORT:-3000}/"]
      interval: 30s
      timeout: 10s
      retries: 5
  cloudflared:
    image: cloudflare/cloudflared:latest
    depends_on:
      server:
        condition: service_healthy
    command: tunnel --no-autoupdate --url http://server:${PORT:-3000} --hostname ${HOSTNAME}
    env_file: .env
    volumes:
      - ./cloudflared:/etc/cloudflared
volumes:
  yjs-data:
