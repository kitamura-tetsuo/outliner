rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // User containers collection
    match /userContainers/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Container users collection
    match /containerUsers/{document=**} {
      allow read, write: if request.auth != null;
    }

    // Projects collection
    // Allow public read access for projects that are public
    // Write access requires authentication and permission
    match /projects/{containerId} {
      allow read: if resource.data.isPublic == true || (request.auth != null);
      allow write: if request.auth != null && (
        // Owner can write
        resource.data.ownerId == request.auth.uid ||
        // Users with owner permission can write
        (resource.data.permissions != null && resource.data.permissions.hasAny([request.auth.uid])) ||
        // Check if user has owner role in permissions array
        (request.auth.uid in resource.data.permissions.where(role == 'owner').userId)
      );
    }

    // Pages collection (for schedules, etc.)
    match /pages/{pageId} {
      allow read, write: if request.auth != null;
    }

    // Default: Allow read/write access to authenticated users for other collections
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
