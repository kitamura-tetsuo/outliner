rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /userContainers/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    match /projects/{projectId} {
      function signedIn() {
        return request.auth != null;
      }

      function hasResource() {
        return resource != null;
      }

      function isOwner() {
        return hasResource() && signedIn() && request.auth.uid == resource.data.ownerId;
      }

      function roleFromPermissionsMap(uid) {
        return hasResource()
          && (resource.data.permissionsMap is map)
          && (uid in resource.data.permissionsMap)
          ? resource.data.permissionsMap[uid]
          : 0;
      }

      function hasRoleAtLeast(minRole) {
        return hasResource() && signedIn() && roleFromPermissionsMap(request.auth.uid) >= minRole;
      }

      // Viewer+ can read; Owner always can read.
      allow read: if hasResource() && (isOwner() || hasRoleAtLeast(1));

      // Project metadata is created client-side on first project creation.
      allow create: if signedIn() && request.resource.data.ownerId == request.auth.uid;

      // Owner and Editor+ can update project metadata (e.g., rename, soft-delete).
      allow update: if isOwner() || hasRoleAtLeast(2);

      // Hard-delete is reserved for Owner (typically performed by Functions).
      allow delete: if isOwner();
    }
  }
}
