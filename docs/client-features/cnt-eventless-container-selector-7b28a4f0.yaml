id: CNT-7b28a4f0
title: Eventless ContainerSelector via ucVersion
title-ja: イベントレスなContainerSelector（ucVersion依存）
description: 'Completely eliminate CustomEvent dependency (firestore-user-container-changed) from ContainerSelector and prove that stable recalculation is possible only with firestoreStore.ucVersion and Svelte 5 $state/$derived. Maintains a design where immediate reflection is achieved by ucVersion++ in both setUserContainer replacement path and array push/pop via Proxy, while adding a fallback that polls for ucVersion changes in the test environment to backstop redraws. Confirmed in E2E that setUserContainer replacement via fluidService directly leads to option increase in real UI.

  '
category: project
status: implemented
components:
- client/src/components/ContainerSelector.svelte
- client/src/stores/firestoreStore.svelte.ts
- client/src/tests/components/TestContainerSelector.svelte
- client/src/tests/fixtures/UserContainerDisplay.svelte
impact:
- ContainerSelector depends only on firestoreStore.ucVersion and internal redraw backstop
- Immediate UI reflection by ucVersion++ in both setUserContainer replacement and array push/pop
- Removed CustomEvent firing from firestoreStore.setUserContainer and visualized differences with log output
tradeoffs:
- Additional state called ucVersion version counter needs to be managed continuously
- Redraw polling dedicated to test environment does not run in production (no unnecessary cost but branches increase)
notes:
- containerStore.containers remains a getter. Name resolution is as before
- Verified fluidService.createClient -> setUserContainer replacement -> option increase in short E2E equivalent to Production
- Can track changes in ucVersion, accessible count, and default ID with INFO logs of firestoreStore.setUserContainer
tests:
- client/e2e/new/cnt-container-selector-setusercontainer-reflects-7b28a4f0.spec.ts
- client/src/tests/integration/cnt-container-selector-reactivity-e3f1a9c2.integration.spec.ts
