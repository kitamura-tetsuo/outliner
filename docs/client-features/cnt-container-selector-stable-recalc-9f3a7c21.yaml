id: CNT-9f3a7c21
title: ContainerSelector Stable Recalculation (PoC)
title-ja: ContainerSelectorの安定再計算（PoC）
description: 'Reduce reliance on CustomEvent for ContainerSelector reactivity and validate that $state/$derived-only

  dependencies can drive stable DOM updates. Introduced a $state-based version counter (ucVersion) on

  firestoreStore that increments on setUserContainer and Proxy-driven array mutations. ContainerSelector

  now derives its options based on firestoreStore.ucVersion and containerStore.containers, while a

  test-only polling fallback keeps redraws in sync when initialization races occur.

  '
category: project
status: implemented
components:
- client/src/components/ContainerSelector.svelte
- client/src/stores/containerStore.svelte.ts
- client/src/stores/firestoreStore.svelte.ts
impact:
- Recalculation on the component side is triggered by dependency on firestoreStore.ucVersion
- Immediate reflection by ucVersion++ in both setUserContainer replacement path and Proxy destructive changes
- Initialization races are mitigated by running ucVersion polling in the test environment
tradeoffs:
- Since dependencies are concentrated on top-level $state, design debt of holding a version counter in the store increases
- Polling is limited to the test environment, but the code path becomes complicated
notes:
- containerStore.containers remains a getter. Container name resolution is as before.
- CustomEvents have been completely eliminated in the current phase. PoC results confirmed in Production-equivalent flow.
- Future consideration of organizing ucVersion itself (migration to a more declarative reactivity path).
tests:
- client/src/tests/integration/cnt-container-selector-reactivity-e3f1a9c2.integration.spec.ts
- client/src/tests/integration/snapshot-diff-modal-a11y-9f2d1c3a.integration.spec.ts
