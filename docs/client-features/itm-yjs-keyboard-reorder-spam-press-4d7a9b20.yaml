id: ITM-yjs-keyboard-reorder-spam-press-4d7a9b20
slug: itm-yjs-keyboard-reorder-spam-press-4d7a9b20
title: Yjs Outliner - Alt+矢印 連打安定性
title-ja: Yjsアウトライナー - Alt+矢印 連打安定性
owner: client
area: outliner
status: active
summary: 'Alt+ArrowDown/Up を短時間に連続押下しても、表示順とアクティブカーソルの整合性が保たれ、

  setCursor の遅延再設定によりカーソル多重化が発生しないことをE2Eで担保する。

  '
rationale: '並べ替え後のカーソル再設定は非同期で行われるため、連打時に重複カーソルや不整合が発生しやすい。

  安定性E2Eで回帰を防止する。

  '
scope:
- /yjs-outliner ルートでの OutlinerBase レンダリング
- Alt+ArrowDown/Up による並べ替えの連続操作
- 再設定後の activeItemId とカーソル数の整合性
impl_notes: '- KeyEventHandler.reorderByKeyboard() は rAF+timeout の2段再設定でアクティブ1つを保証

  - E2E: client/e2e/new/itm-yjs-keyboard-reorder-spam-press-4d7a9b20.spec.ts

  '
acceptance:
- Alt+ArrowDown/Up を複数回押しても最終的な表示順が期待通りになる
- editorOverlayStore.cursors の数は最終的に 1
- 並べ替え後はアクティブカーソルが1つで、そのアイテムIDが移動後のアイテムに一致する
components:
- client/src/lib/KeyEventHandler.ts
- client/src/stores/EditorOverlayStore.svelte.ts
tests:
- client/e2e/new/itm-yjs-keyboard-reorder-spam-press-4d7a9b20.spec.ts
known_pitfalls:
- setCursor 再設定は requestAnimationFrame + setTimeout の二段で行われるため、E2Eでは waitForFunction(active=1 かつ activeItemId の存在)で安定待ちすること。
- 連打中に cursorHistory が重複IDを含まないこと（再アクティブ化時は末尾に移動させる）。
- タイトル(index 0)は移動対象外であり、交互連打でも並びが変化しないこと。
