id: ITM-yjs-keyboard-reorder-boundary-b2c4d8e1
slug: itm-yjs-keyboard-reorder-boundary-b2c4d8e1
title: Yjs Outliner - Alt+矢印 並べ替えの境界ケース
title-ja: Yjsアウトライナー - Alt+矢印 並べ替えの境界ケース
owner: client
area: outliner
status: active
summary: 'Alt+ArrowUp/Down による並べ替え操作で、先頭／末尾の境界やタイトル行での非移動、

  および複数カーソル存在時でもアクティブカーソルが1つに保たれることを厳密にE2Eで検証する。

  '
rationale: 'キーバインドによる並べ替えは、境界での不正移動やカーソル多重化が起きやすい。

  仕様に沿った不変性（タイトル非移動・先頭/末尾での非移動）とアクティブカーソルの一意性を担保する。

  '
scope:
- /yjs-outliner ルートでの OutlinerBase レンダリング
- Alt+ArrowDown/Up による並べ替え
- 先頭/末尾での非移動の確認
- タイトル(index 0)の非移動
- マルチカーソル状態での境界押下時のアクティブカーソル単一化
impl_notes: '- KeyEventHandler.reorderByKeyboard() はタイトル(index 0)対象外、境界外はreturnで無視する

  - editorOverlayStore.clearCursorAndSelection() と setCursor() を二段階(rAF+timeout)で再設定し、アクティブ1つを維持

  - E2E: client/e2e/new/itm-yjs-keyboard-reorder-boundary-b2c4d8e1.spec.ts

  '
acceptance:
- タイトル(index 0)で Alt+ArrowUp/Down を押してもタイトルは移動しない
- 先頭の直下アイテムで Alt+ArrowUp を押しても並びが変化しない
- 最下段で Alt+ArrowDown を押しても並びが変化しない
- 複数カーソル状態で末尾境界押下後も、アクティブカーソル数は1つ
components:
- client/src/lib/KeyEventHandler.ts
- client/src/stores/EditorOverlayStore.svelte.ts
tests:
- client/e2e/new/itm-yjs-keyboard-reorder-boundary-b2c4d8e1.spec.ts
known_pitfalls:
- setCursor 再設定は rAF+timeout の二段で行われるため、E2Eでは waitForFunction(active=1 かつ activeItemId の存在)で安定待ちすること。
- 境界（先頭/末尾）での Alt 押下は無視される実装であること。無視時も active は 1 を維持する必要がある。
- タイトル(index 0)は移動対象外であり、連打時もタイトルは移動しないこと。
