id: ENV-7c3a1f2b
title: Yjs WebSocket URL priority and single source of truth
category: env
status: implemented
components:
- client/e2e/utils/testHelpers.ts
- client/src/lib/yjs/connection.ts
- client/src/routes/[project]/[page]/+page.svelte
priority:
- VITE_YJS_WS_URL > VITE_YJS_PORT > default(7093)
notes:
- Use getWsBase() in client/src/lib/yjs/connection.ts as the single source for the WS base URL
- In E2E environments, suppress WebSocket connections using VITE_YJS_DISABLE_WS and VITE_IS_TEST/localStorage
- Eliminate/suppress existing hardcoded values (like direct port specification)
- Production sourcing: VITE_YJS_WS_URL is provided from GitHub Actions repository Variable (YJS_WS_URL) via .github/workflows/deploy.yml
verification:
- Verify minimum visibility and absence of erroneous WS connections in client/e2e/core/nav-outlinerbase-min-visibility-7a3c91e2.spec.ts
- Priority of getWsBase(): VITE_YJS_WS_URL is highest, then VITE_YJS_PORT, and finally 7093 as default
changelog:
- Implemented getWsBase() as single source and updated related code paths
- Suppressed noisy ERROR logs on empty pages in standard flow (downgraded to WARN)
examples:
  production:
  - VITE_YJS_WS_URL=wss://yjs.example.com
  - VITE_YJS_PORT=443
  e2e:
  - 'Set "VITE_YJS_DISABLE_WS=true" in .env.test or localStorage to suppress Yjs WS'
  - 'In Playwright, collect WS using page.on(''websocket'', ...) and confirm that the number of Yjs-related connections (port 7093, /yjs, /projects/) is 0'
ws-enabled-priority:
- '1) Force Enable: localStorage.VITE_YJS_FORCE_WS === ''true'' -> Always enabled (For Test/E2E. Prioritized over disable)'
- '2) Disable: VITE_YJS_DISABLE_WS (Either env or localStorage is ''true'') -> Disabled'
- '3) Explicit Enable: localStorage.VITE_YJS_ENABLE_WS === ''true'' -> Enabled (Only if (2) is not present)'
- '4) Test Default: MODE===''test'' or VITE_IS_TEST===''true'' -> Enabled by default (Prioritizes (2) if present)'
- '5) Default: Enabled if none of the above apply'
usage:
- Recommend VITE_YJS_DISABLE_WS=true in .env.test (Suppress Yjs WS handshake noise)
- For E2E requiring WS, force connection by setting VITE_YJS_FORCE_WS=true in localStorage using page.addInitScript etc.
- In production, do not use localStorage overrides (ENABLE/FORCE) in principle. Prioritize control via environment variables when necessary
