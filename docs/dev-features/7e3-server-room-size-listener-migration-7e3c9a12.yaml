id: FTR-7e3c9a12
slug: 7e3
title: 'Server: migrate room-size listener to Yjs observeDeep with fallback'
type: dev
area: server
status: implemented
owner: server
introduced-in: server/src/update-listeners.ts
summary:
  en: 'Replace doc.on(''update'') with minimal-granularity Yjs observeDeep on the root orderedTree map when available, with a safe fallback to doc-level update listener.

    '
motivation:
  en: 'Reduce unnecessary wake-ups from unrelated Y.Doc updates and make room-size checks more targeted.

    Keep backward compatibility for containers without orderedTree.

    '
changes:
- file: server/src/update-listeners.ts
  description:
    en: 'addRoomSizeListener prefers ymap.observeDeep(warn) on doc.getMap("orderedTree"),

      otherwise falls back to doc.on(''update'', warn). removeRoomSizeListener detaches both safely.

      '
impact:
  granularity:
    en: Observes only orderedTree subtree when available (reduced noise).
  load:
    en: Lower CPU due to fewer irrelevant listener wake-ups; equivalent memory footprint.
  detach:
    en: 'Safe detach covers both unobserveDeep and off(''update''). Listener references are ref-counted per room.

      '
fallback:
  en: If orderedTree is missing or observeDeep is unavailable, uses doc.on('update') to preserve behavior.
future:
  en: '- Consider subdoc-level listeners if pages are split into subdocs.

    - Emit metrics for listener attach/detach to observe load over time.

    '
tests:
  files:
  - path: server/tests/update-listeners.test.js
    ensures:
      en: '- orderedTree changes trigger warnIfRoomTooLarge via observeDeep

        - Fallback path via doc.on(''update'') also triggers

        - Both detach paths release listeners safely

        '