version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile

    working_dir: /workspace
    user: node

    environment:
      - GIT_MERGE_AUTOEDIT=no

    ipc: 'host'
    shm_size: '1gb'

    volumes:
      # 1️⃣  Project source as a bind-mount
      - type: bind
        source: ..
        target: /workspace
        consistency: cached

      # 2️⃣  Mask client-side node_modules with an anonymous volume
      - type: volume
        source: node_modules_client
        target: /workspace/client/node_modules
        volume:
          nocopy: true # don’t copy any existing files

      # 3️⃣  Mask server-side node_modules
      - type: volume
        source: node_modules_server
        target: /workspace/server/node_modules
        volume:
          nocopy: true

      # 4️⃣  Remaining bind-mounts
      - type: bind
        source: /home/ubuntu/.ssh
        target: /home/node/.ssh
        consistency: cached
      - type: bind
        source: /var/run/docker.sock
        target: /var/run/docker.sock
        consistency: cached

    ports:
      - '7070-7072:7070-7072'
      - '7080-7082:7080-7082'
      - '7090-7092:7090-7092'
      - '9323:9323'
      - '54000:54000'
      - '57000:57000'
      - '58080:58080'
      - '59099:59099'

    command: sleep infinity

volumes:
  node_modules_client:
  node_modules_server:
